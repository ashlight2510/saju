<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>ê¶í•© Â· ì˜¤ëŠ˜ìš´ì„¸ Â· ì‹ ë…„ìš´ì„¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Adsense (ìš”ì²­ ë°˜ì˜) -->
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1204894220949193"
      crossorigin="anonymous"
    ></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@400;600;800&family=Playfair+Display:wght@700;800&display=swap");

      :root {
        --bg1: #0b1621;
        --bg2: #101f2e;
        --bg3: #14273b;
        --card: rgba(255, 255, 255, 0.94);
        --text: #0f172a;
        --muted: rgba(15, 23, 42, 0.65);
        --line: rgba(15, 23, 42, 0.12);
        --accent: #2563eb;
        --accent2: #f59e0b;
        --shadow: 0 16px 40px rgba(0, 0, 0, 0.25);
        --radius: 18px;
        --font-body: "IBM Plex Sans KR", "Apple SD Gothic Neo", sans-serif;
        --font-title: "Playfair Display", "Nanum Myeongjo", serif;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: var(--font-body);
        background: linear-gradient(180deg, var(--bg1), var(--bg2), var(--bg3));
        color: rgba(255, 255, 255, 0.92);
      }
      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 24px 18px 40px;
      }
      h1,
      h2,
      h3 {
        margin: 0 0 10px;
      }
      h1 {
        font-family: var(--font-title);
        font-weight: 800;
        letter-spacing: 0.02em;
      }
      .hero {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
      }
      .badge {
        font-size: 12px;
        font-weight: 800;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        padding: 8px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .card {
        background: var(--card);
        color: var(--text);
        border-radius: var(--radius);
        padding: 18px;
        margin-bottom: 16px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        box-shadow: var(--shadow);
      }
      .card-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .score {
        font-size: 28px;
        font-weight: 800;
        color: var(--accent);
      }
      .lead {
        font-size: 1.05rem;
        font-weight: 800;
        line-height: 1.5;
      }
      .mini {
        font-size: 0.85rem;
        color: var(--muted);
        font-weight: 700;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .btn {
        padding: 10px 14px;
        border-radius: 999px;
        border: none;
        font-weight: 800;
        cursor: pointer;
        background: var(--text);
        color: #fff;
      }
      .btn.outline {
        background: #fff;
        color: var(--text);
        border: 1px solid var(--text);
      }
      .btn.ghost {
        background: rgba(15, 23, 42, 0.08);
        color: var(--text);
        border: 1px solid rgba(15, 23, 42, 0.1);
      }
      select,
      input[type="range"] {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(15, 23, 42, 0.16);
        font-weight: 700;
      }
      .rule-card {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 10px;
        background: rgba(255, 255, 255, 0.96);
      }
      .rule-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .like-btn {
        border: none;
        background: rgba(37, 99, 235, 0.12);
        color: #1e40af;
        border-radius: 10px;
        padding: 4px 8px;
        cursor: pointer;
        font-weight: 800;
      }
      .radar {
        width: 100%;
        max-width: 420px;
        margin: 12px auto 0;
        display: block;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }
      .pill-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        font-weight: 800;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.06);
        border: 1px solid rgba(15, 23, 42, 0.1);
      }
      .section-title {
        font-weight: 800;
        font-size: 1rem;
      }
      .share-note {
        margin-top: 10px;
      }

      @media (max-width: 720px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
        .card-head {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="hero">
        <div class="badge">Local Only</div>
        <div class="badge" id="todayBadge"></div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <h1>ğŸ”® ê¶í•© ë¦¬í¬íŠ¸</h1>
            <p class="mini" id="summarySub">Asia/Seoul ê¸°ì¤€ Â· ì ˆê¸°/ì˜¤í–‰ ê·œì¹™</p>
          </div>
          <div class="score" id="totalScore">â€”</div>
        </div>
        <p class="lead" id="summaryMain">â€”</p>
        <div class="pill-row" id="summaryPills"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content: space-between">
          <div>
            <h2>ì˜¤ëŠ˜ ìš´ì„¸ (ê¶í•© ê²°í•©)</h2>
            <p class="lead" id="todayCoupleLine">â€”</p>
            <p class="mini" id="todayCoupleMeta">â€”</p>
          </div>
          <button class="btn ghost" id="todayLuckBtn">ì˜¤ëŠ˜ ë‹¤ì‹œ ë³´ê¸°</button>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h2>ì„¹ì…˜ë³„ ê· í˜•</h2>
          <svg id="sectionRadarSvg" class="radar" viewBox="0 0 320 320"></svg>
          <p class="mini" id="sectionRadarLegend">ê´€ê³„ì˜ ì „ì²´ ë°¸ëŸ°ìŠ¤</p>
        </div>

        <div class="card">
          <h2>ëª¨ë“œ Â· íŠœë‹</h2>
          <div class="row" style="margin-bottom: 8px">
            <span class="mini">í†¤</span>
            <select id="toneSelect">
              <option value="couple" selected>ì»¤í”Œ ëª¨ë“œ</option>
              <option value="biz">ë™ì—…ì ëª¨ë“œ</option>
            </select>
          </div>
          <div class="row">
            <span class="mini">íŠœë‹ ê°•ë„</span>
            <input
              type="range"
              min="0"
              max="2"
              step="0.1"
              value="1"
              id="tuneStrength"
            />
            <span id="tuneLabel" class="mini">1.0</span>
            <button class="btn outline" id="tuneReset">ì´ˆê¸°í™”</button>
          </div>
          <p class="mini" id="tuneStatus"></p>
        </div>
      </div>

      <div class="card">
        <h2>ê¶í•© í¬ì¸íŠ¸</h2>
        <div id="ruleList"></div>
      </div>

      <div class="card">
        <h2>2026 ì‹ ë…„ìš´ì„¸ (ì›”ë³„)</h2>
        <div id="monthlyList"></div>
      </div>

      <div class="card">
        <h2>ê³µìœ </h2>
        <button class="btn" id="shareBtn">ê³µìœ  ì¹´ë“œ ë§Œë“¤ê¸°</button>
        <p class="mini share-note" id="shareStatus"></p>
        <canvas
          id="shareCanvas"
          width="1080"
          height="1350"
          style="display: none"
        ></canvas>
      </div>
    </div>

    <script>
      /* ======================================================
  0. ìƒ˜í”Œ ë°ì´í„° (A/B ì‚¬ì£¼ ê²°ê³¼ë¼ê³  ê°€ì •)
====================================================== */
      const A = {
        name: "A",
        elements: { ëª©: 0.9, í™”: 1.4, í† : 1.0, ê¸ˆ: 0.6, ìˆ˜: 1.8 },
        dayBranch: "ì",
      };
      const B = {
        name: "B",
        elements: { ëª©: 1.2, í™”: 1.1, í† : 1.1, ê¸ˆ: 0.9, ìˆ˜: 1.3 },
        dayBranch: "ì¶•",
      };

      const todayBadge = document.getElementById("todayBadge");
      todayBadge.textContent = new Date().toISOString().slice(0, 10);

      const todayCoupleLine = document.getElementById("todayCoupleLine");
      const todayCoupleMeta = document.getElementById("todayCoupleMeta");
      const sectionRadarSvg = document.getElementById("sectionRadarSvg");
      const summaryMain = document.getElementById("summaryMain");
      const summarySub = document.getElementById("summarySub");
      const totalScoreEl = document.getElementById("totalScore");
      const summaryPills = document.getElementById("summaryPills");
      const ruleList = document.getElementById("ruleList");
      const monthlyList = document.getElementById("monthlyList");
      const toneSelect = document.getElementById("toneSelect");
      const tuneStrength = document.getElementById("tuneStrength");
      const tuneLabel = document.getElementById("tuneLabel");
      const tuneReset = document.getElementById("tuneReset");
      const tuneStatus = document.getElementById("tuneStatus");
      const todayLuckBtn = document.getElementById("todayLuckBtn");
      const shareBtn = document.getElementById("shareBtn");
      const shareStatus = document.getElementById("shareStatus");

      /* ======================================================
  1. ìœ í‹¸
====================================================== */
      const STEM_ELEM = {
        ê°‘: "ëª©",
        ì„: "ëª©",
        ë³‘: "í™”",
        ì •: "í™”",
        ë¬´: "í† ",
        ê¸°: "í† ",
        ê²½: "ê¸ˆ",
        ì‹ : "ê¸ˆ",
        ì„: "ìˆ˜",
        ê³„: "ìˆ˜",
      };
      const BRANCH_ELEM = {
        ì: "ìˆ˜",
        ì¶•: "í† ",
        ì¸: "ëª©",
        ë¬˜: "ëª©",
        ì§„: "í† ",
        ì‚¬: "í™”",
        ì˜¤: "í™”",
        ë¯¸: "í† ",
        ì‹ : "ê¸ˆ",
        ìœ : "ê¸ˆ",
        ìˆ : "í† ",
        í•´: "ìˆ˜",
      };
      const GENERATE = { ëª©: "í™”", í™”: "í† ", í† : "ê¸ˆ", ê¸ˆ: "ìˆ˜", ìˆ˜: "ëª©" };
      const OVERCOME = { ëª©: "í† ", í™”: "ê¸ˆ", í† : "ìˆ˜", ê¸ˆ: "ëª©", ìˆ˜: "í™”" };

      const LIUHE = [
        ["ì", "ì¶•"],
        ["ì¸", "í•´"],
        ["ë¬˜", "ìˆ "],
        ["ì§„", "ìœ "],
        ["ì‚¬", "ì‹ "],
        ["ì˜¤", "ë¯¸"],
      ];
      const CHUNG = [
        ["ì", "ì˜¤"],
        ["ì¶•", "ë¯¸"],
        ["ì¸", "ì‹ "],
        ["ë¬˜", "ìœ "],
        ["ì§„", "ìˆ "],
        ["ì‚¬", "í•´"],
      ];
      const HAE = [
        ["ì", "ë¯¸"],
        ["ì¶•", "ì˜¤"],
        ["ì¸", "ì‚¬"],
        ["ë¬˜", "ì§„"],
        ["ì‹ ", "í•´"],
        ["ìœ ", "ìˆ "],
      ];
      const SAMHAP = [
        ["ì‹ ", "ì", "ì§„"],
        ["í•´", "ë¬˜", "ë¯¸"],
        ["ì¸", "ì˜¤", "ìˆ "],
        ["ì‚¬", "ìœ ", "ì¶•"],
      ];
      const SELF_PUNISH = ["ì", "ì˜¤", "ìœ ", "í•´"];

      const MONTH_FLOW = {
        1: { monthBranch: "ì¶•", seasonTop: "í† " },
        2: { monthBranch: "ì¸", seasonTop: "ëª©" },
        3: { monthBranch: "ë¬˜", seasonTop: "ëª©" },
        4: { monthBranch: "ì§„", seasonTop: "í† " },
        5: { monthBranch: "ì‚¬", seasonTop: "í™”" },
        6: { monthBranch: "ì˜¤", seasonTop: "í™”" },
        7: { monthBranch: "ë¯¸", seasonTop: "í† " },
        8: { monthBranch: "ì‹ ", seasonTop: "ê¸ˆ" },
        9: { monthBranch: "ìœ ", seasonTop: "ê¸ˆ" },
        10: { monthBranch: "ìˆ ", seasonTop: "í† " },
        11: { monthBranch: "í•´", seasonTop: "ìˆ˜" },
        12: { monthBranch: "ì", seasonTop: "ìˆ˜" },
      };

      function hasPair(a, b, table) {
        return table.some(([x, y]) => (a === x && b === y) || (a === y && b === x));
      }
      function isLiuhe(a, b) {
        return hasPair(a, b, LIUHE);
      }
      function isChung(a, b) {
        return hasPair(a, b, CHUNG);
      }
      function isHae(a, b) {
        return hasPair(a, b, HAE);
      }
      function isSamhap(a, b) {
        return SAMHAP.some((g) => g.includes(a) && g.includes(b));
      }
      function isSelfPunish(b) {
        return SELF_PUNISH.includes(b);
      }
      function relationElem(a, b) {
        if (GENERATE[a] === b) return "ìƒ";
        if (OVERCOME[a] === b) return "ê·¹";
        if (GENERATE[b] === a) return "ë°›ìŒ";
        if (OVERCOME[b] === a) return "ëˆŒë¦¼";
        if (a === b) return "ë™";
        return "ì¤‘ë¦½";
      }
      function getTopWeak(elementsRaw) {
        const entries = Object.entries(elementsRaw).sort((a, b) => b[1] - a[1]);
        return { top: entries[0][0], weak: entries[entries.length - 1][0] };
      }
      function calcBalance(elementsRaw) {
        const vals = Object.values(elementsRaw);
        const max = Math.max(...vals);
        const min = Math.min(...vals);
        return max ? (max - min) / max : 0;
      }
      function combineElements(a, b) {
        const keys = Object.keys(a);
        const out = {};
        keys.forEach((k) => {
          out[k] = (a[k] + b[k]) / 2;
        });
        return out;
      }
      function round1(x) {
        return Math.round(x * 10) / 10;
      }
      function clamp01(x) {
        return Math.max(0, Math.min(1, x));
      }
      function hashToIndex(str, mod) {
        let h = 2166136261;
        for (let i = 0; i < str.length; i++) {
          h ^= str.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        h >>>= 0;
        return mod ? h % mod : 0;
      }
      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (c) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        })[c]);
      }

      /* ======================================================
  2. ì˜¤ëŠ˜ ìš´ì„¸ (ì¼ì§„ ê°„ì§€)
====================================================== */
      const STEMS = ["ê°‘", "ì„", "ë³‘", "ì •", "ë¬´", "ê¸°", "ê²½", "ì‹ ", "ì„", "ê³„"];
      const BRANCHES = ["ì", "ì¶•", "ì¸", "ë¬˜", "ì§„", "ì‚¬", "ì˜¤", "ë¯¸", "ì‹ ", "ìœ ", "ìˆ ", "í•´"];
      const GANJI_60 = (() => {
        const arr = [];
        for (let i = 0; i < 60; i++) {
          arr.push({ stem: STEMS[i % 10], branch: BRANCHES[i % 12] });
        }
        return arr;
      })();

      const BASE_GAPJA_DAY = new Date("1984-02-02T00:00:00+09:00");
      const KOREA_DST = [
        {
          start: "1988-05-08T00:00:00+09:00",
          end: "1988-10-09T23:59:59+09:00",
          offsetHours: 1,
        },
      ];

      function applyDST(dateKST) {
        const t = dateKST.getTime();
        for (const d of KOREA_DST) {
          const s = new Date(d.start).getTime();
          const e = new Date(d.end).getTime();
          if (t >= s && t <= e) {
            return new Date(t + d.offsetHours * 3600 * 1000);
          }
        }
        return dateKST;
      }

      function getTodayGanji(date = new Date()) {
        const kst = new Date(date.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
        const adj = applyDST(kst);
        const days = Math.floor((adj - BASE_GAPJA_DAY) / (24 * 3600 * 1000));
        const idx = ((days % 60) + 60) % 60;
        return { index: idx, ...GANJI_60[idx] };
      }

      function getTodayElementFlow(date = new Date()) {
        const g = getTodayGanji(date);
        return {
          ganji: g,
          stemElem: STEM_ELEM[g.stem],
          branchElem: BRANCH_ELEM[g.branch],
        };
      }

      function todayAdvantage(aPerson, bPerson, date = new Date()) {
        const flow = getTodayElementFlow(date);
        const key1 = flow.stemElem;
        const key2 = flow.branchElem;
        const scoreA = aPerson.elements[key1] * 1.0 + aPerson.elements[key2] * 0.7;
        const scoreB = bPerson.elements[key1] * 1.0 + bPerson.elements[key2] * 0.7;
        const diff = scoreA - scoreB;
        const TH = 0.35;

        let winner = "even";
        if (diff > TH) winner = "A";
        else if (diff < -TH) winner = "B";

        const line = makeTodayCoupleLine(winner, key1, key2);
        return {
          winner,
          keys: [key1, key2],
          scoreA: round1(scoreA),
          scoreB: round1(scoreB),
          line,
        };
      }

      function makeTodayCoupleLine(winner, k1, k2) {
        if (winner === "A") {
          return `ì˜¤ëŠ˜ íë¦„ì€ ${k1}/${k2} ìª½ì´ ê°•í•´ì„œ, Aê°€ ì¡°ê¸ˆ ë” ìœ ë¦¬í•´. ì¤‘ìš”í•œ ì–˜ê¸°ëŠ” Aê°€ ë¨¼ì € êº¼ë‚´ë©´ ì¢‹ì•„.`;
        }
        if (winner === "B") {
          return `ì˜¤ëŠ˜ íë¦„ì€ ${k1}/${k2} ìª½ì´ ê°•í•´ì„œ, Bê°€ ì¡°ê¸ˆ ë” ìœ ë¦¬í•´. ì•½ì†/ê²°ì •ì€ B ì»¨ë””ì…˜ì— ë§ì¶”ë©´ ë¶€ë“œëŸ½ê²Œ ê°„ë‹¤.`;
        }
        return `ì˜¤ëŠ˜ì€ ${k1}/${k2} íë¦„ì¸ë°, A/B ë‘˜ ë‹¤ ë¹„ìŠ·í•˜ê²Œ ë°›ëŠ”ë‹¤. ë§ì¶°ê°€ëŠ” ê²Œ ì´ë“ì´ì•¼.`;
      }

      function renderTodayCoupleBox() {
        const t = todayAdvantage(A, B);
        todayCoupleLine.textContent = t.line;
        todayCoupleMeta.textContent = `A ${t.scoreA} vs B ${t.scoreB} (ì˜¤ëŠ˜ ì˜¤í–‰: ${t.keys.join("/")})`;
      }

      /* ======================================================
  3. ë£° + íŠœë‹ + ìš”ì•½
====================================================== */
      const SECTION_WEIGHT = { ì„±í–¥: 0.25, ê´€ê³„: 0.25, ëˆ: 0.15, ì¼: 0.2, ê±´ê°•: 0.15 };
      const RULES = [
        {
          id: "ELEM_TOP_SAME",
          section: "ì„±í–¥",
          priority: 88,
          when: (a, b) => a.topElem === b.topElem && a.topScore >= 1.2 && b.topScore >= 1.2,
          evidence: "ë‘˜ ë‹¤ {topElem} ê¸°ìš´ì´ ê°€ì¥ ê°•í•´ ê¸°ì¤€ê³¼ ì†ë„ê°€ ë¹„ìŠ·í•´.",
          copies: ["ê¸°ë³¸ ê²°ì´ ì˜ ë§ì•„. ê°™ì´ ì›€ì§ì´ë©´ ë¹ ë¥´ë‹¤.", "ë‘˜ ë‹¤ ëª°ì…í•  ë• ë¸Œë ˆì´í¬ë§Œ ë§ì¶”ë©´ ì™„ë²½í•´."],
        },
        {
          id: "ELEM_COMPLEMENT",
          section: "ê´€ê³„",
          priority: 82,
          when: (a, b) => GENERATE[a.topElem] === b.topElem || GENERATE[b.topElem] === a.topElem,
          evidence: "ìƒìƒ ê´€ê³„ì˜ ê°•ì ì´ ì„œë¡œ ë§ë¬¼ë ¤ ìˆì–´.",
          copies: ["ì„œë¡œ ì—†ëŠ” ê±¸ ì±„ì›Œì£¼ëŠ” êµ¬ì¡°ë¼ ì˜¤ë˜ ê°€ê¸° ì¢‹ì•„.", "ì—­í•  ë¶„ë‹´ë§Œ ì˜ ë˜ë©´ ì‹œë„ˆì§€ê°€ í¬ê²Œ ë‚œë‹¤."],
        },
        {
          id: "ELEM_WEAK_SAME",
          section: "ê±´ê°•",
          priority: 60,
          when: (a, b) => a.weakElem === b.weakElem && a.weakScore <= 0.7 && b.weakScore <= 0.7,
          evidence: "ë‘˜ ë‹¤ {weakElem} ê¸°ìš´ì´ ë‚®ì•„ ê°™ì€ ë¶€ë¶„ì—ì„œ í”ë“¤ë¦¬ê¸° ì‰¬ì›Œ.",
          copies: ["ì•½ì ì´ ê°™ì•„ì„œ ì´í•´ëŠ” ì˜ ëœë‹¤.", "ì´ ë¶€ë¶„ë§Œ ê·œì¹™ìœ¼ë¡œ ê´€ë¦¬í•˜ë©´ ì¶©ë¶„íˆ ì»¤ë²„ë¼."],
        },
        {
          id: "BRANCH_LIUHE",
          section: "ê´€ê³„",
          priority: 90,
          when: (a, b) => isLiuhe(a.dayBranch, b.dayBranch),
          evidence: "ì¼ì§€ ê¸°ì¤€ ìœ¡í•©ì´ ì„±ë¦½ë¼ ê¸°ë³¸ í˜¸í¡ì´ í¸í•´.",
          copies: ["ê°™ì´ ìˆìœ¼ë©´ ì´ìœ  ì—†ì´ í¸í•˜ë‹¤.", "ìƒí™œ ê¶í•©ì´ ì¢‹ì€ íƒ€ì…."],
        },
        {
          id: "BRANCH_SAMHAP",
          section: "ì¼",
          priority: 78,
          when: (a, b) => isSamhap(a.dayBranch, b.dayBranch),
          evidence: "ì‚¼í•© êµ¬ì¡°ë¼ ëª©í‘œë¥¼ í–¥í•´ í˜ì´ ëª¨ì—¬.",
          copies: ["ê°™ì€ ëª©í‘œë§Œ ìˆìœ¼ë©´ í­ë°œë ¥ì´ ì¢‹ë‹¤.", "í”„ë¡œì íŠ¸ ê¶í•©ì´ ìµœê³ ì•¼."],
        },
        {
          id: "BRANCH_CHUNG",
          section: "ê´€ê³„",
          priority: 62,
          when: (a, b) => isChung(a.dayBranch, b.dayBranch),
          evidence: "ì§€ì§€ ì¶©ìœ¼ë¡œ íƒ€ì´ë°ì´ ìì£¼ ì—‡ê°ˆë¦´ ìˆ˜ ìˆì–´.",
          copies: ["ë§ëŠ” ë§ë„ íƒ€ì´ë°ì´ ì–´ê¸‹ë‚˜ë©´ ì‹¸ì›€ì´ ëœë‹¤.", "ì¤‘ìš”í•œ ì–˜ê¸°ëŠ” ì»¨ë””ì…˜ ì¢‹ì„ ë•Œ."],
        },
        {
          id: "BRANCH_HAE",
          section: "ì„±í–¥",
          priority: 58,
          when: (a, b) => isHae(a.dayBranch, b.dayBranch),
          evidence: "í•´ ê´€ê³„ê°€ ìˆì–´ ì˜¤í•´ê°€ ìŒ“ì¼ ìˆ˜ ìˆì–´.",
          copies: ["ì‘ì€ ë§ì´ í¬ê²Œ ë“¤ë¦´ ìˆ˜ ìˆë‹¤.", "ì‚¬ì‹¤ í™•ì¸ ë¨¼ì € í•˜ë©´ ê´œì°®ì•„."],
        },
        {
          id: "SELF_PUNISH",
          section: "ê±´ê°•",
          priority: 55,
          when: (a, b) => a.dayBranch === b.dayBranch && isSelfPunish(a.dayBranch),
          evidence: "ê°™ì€ ì§€ì§€ë¼ ê°ì •ì„ ì•ˆìœ¼ë¡œ ìŒ“ê¸° ì‰¬ìš´ êµ¬ì¡°ì•¼.",
          copies: ["ì°¸ëŠ” ê²Œ ë¬¸ì œ í¬ì¸íŠ¸.", "ê¸°ë¶„ì€ ê·¸ë‚ ê·¸ë‚  í‘¸ëŠ” ê²Œ ë‹µ."],
        },
        {
          id: "MONEY_STYLE_MATCH",
          section: "ëˆ",
          priority: 75,
          when: (a, b) => Math.abs(a.elements["ê¸ˆ"] - b.elements["ê¸ˆ"]) <= 0.3,
          evidence: "ëˆì— ëŒ€í•œ ê°ê°ì´ ë¹„ìŠ·í•œ í¸ì´ì•¼.",
          copies: ["ê¸ˆì „ ìŠ¤íŠ¸ë ˆìŠ¤ ì ì€ ì¡°í•©.", "ê³µë™ ì§€ì¶œ ê¸°ì¤€ë§Œ ì •í•˜ë©´ ëœë‹¤."],
        },
        {
          id: "WORK_SPEED_DIFF",
          section: "ì¼",
          priority: 63,
          when: (a, b) => Math.abs(a.elements["í™”"] - b.elements["í™”"]) >= 0.6,
          evidence: "ì¼ ì²˜ë¦¬ ì†ë„ ì°¨ì´ê°€ ê½¤ ìˆëŠ” í¸ì´ì•¼.",
          copies: ["ì†ë„ ì°¨ì´ì¼ ë¿ ë°©í–¥ì€ ê°™ë‹¤.", "ê¸°í•œë§Œ ëª…í™•íˆ ë§ì¶”ì."],
        },
      ];

      const TUNE_KEY = "compat_rule_tuning_v1";
      const TUNE_CFG_KEY = "compat_rule_tuning_cfg_v1";

      function loadTune() {
        try {
          return JSON.parse(localStorage.getItem(TUNE_KEY) || "{}");
        } catch {
          return {};
        }
      }
      function saveTune(v) {
        localStorage.setItem(TUNE_KEY, JSON.stringify(v));
      }
      function loadTuneCfg() {
        try {
          return JSON.parse(localStorage.getItem(TUNE_CFG_KEY) || "{}") || { strength: 1 };
        } catch {
          return { strength: 1 };
        }
      }
      function saveTuneCfg(cfg) {
        localStorage.setItem(TUNE_CFG_KEY, JSON.stringify(cfg));
      }
      function getTuneStrength() {
        return loadTuneCfg().strength ?? 1;
      }
      function getTunedPriority(rule) {
        const tune = loadTune();
        const delta = tune[rule.id] || 0;
        const strength = getTuneStrength();
        const tuned = rule.priority + delta * strength;
        return Math.max(40, Math.min(100, tuned));
      }
      function feedback(ruleId) {
        const t = loadTune();
        t[ruleId] = (t[ruleId] || 0) + 1.5;
        saveTune(t);
        updateTuneStatus();
      }
      function updateTuneStatus() {
        const t = loadTune();
        const keys = Object.keys(t);
        const strength = getTuneStrength();
        tuneStatus.textContent = keys.length
          ? `íŠœë‹ ì ìš© ì¤‘: ${keys.length}ê°œ ë£° (ê°•ë„ ${strength.toFixed(1)})`
          : `íŠœë‹ ì—†ìŒ (ê°•ë„ ${strength.toFixed(1)})`;
      }

      function buildPerson(person) {
        const { top, weak } = getTopWeak(person.elements);
        return {
          ...person,
          topElem: top,
          weakElem: weak,
          topScore: person.elements[top],
          weakScore: person.elements[weak],
          balance: calcBalance(person.elements),
        };
      }

      function evaluateRules(a, b) {
        return RULES.filter((r) => r.when(a, b)).map((r) => ({
          ...r,
          tunedPriority: getTunedPriority(r),
        }));
      }

      function calcSectionScores(firedRules) {
        const result = {};
        Object.keys(SECTION_WEIGHT).forEach((s) => (result[s] = { sum: 0, cnt: 0 }));
        firedRules.forEach((r) => {
          if (result[r.section]) {
            result[r.section].sum += r.tunedPriority;
            result[r.section].cnt += 1;
          }
        });
        const scores = {};
        Object.keys(result).forEach((s) => {
          scores[s] = result[s].cnt ? Math.round(result[s].sum / result[s].cnt) : 50;
        });
        return scores;
      }

      function calcTotalFromSections(sectionScores) {
        let total = 0;
        Object.entries(SECTION_WEIGHT).forEach(([k, w]) => {
          total += sectionScores[k] * w;
        });
        return Math.round(total);
      }

      function generateSummary(score) {
        if (score >= 85) return "ì „ë°˜ì ìœ¼ë¡œ ê¶í•©ì´ ê°•í•´. ê¸°ë³¸ ê²°ì´ ì˜ ë§ê³ , ì¥ê¸°ì ìœ¼ë¡œ ì•ˆì •ì ì´ì•¼.";
        if (score >= 70) return "ì¢‹ì€ í¸ì´ì•¼. í¬ì¸íŠ¸ ëª‡ ê°€ì§€ë§Œ ë§ì¶”ë©´ í›¨ì”¬ í¸í•´ì§ˆ ìˆ˜ ìˆì–´.";
        if (score >= 55) return "ë¬´ë‚œí•´. ê·œì¹™ë§Œ ì˜ ì„¸ìš°ë©´ ì¶©ë¶„íˆ ì¢‹ì€ ê´€ê³„ë¡œ ê°ˆ ìˆ˜ ìˆì–´.";
        return "ë…¸ë ¥ì´ í•„ìš”í•œ ê¶í•©ì´ì•¼. ëŒ€ì‹  ê¸°ì¤€ë§Œ ë§ì¶”ë©´ ì˜ì™¸ë¡œ ë‹¨ë‹¨í•´ì§ˆ ìˆ˜ ìˆì–´.";
      }

      /* ======================================================
  4. í†¤ ë¶„ê¸°
====================================================== */
      const TONE = {
        couple: {
          title: "ì»¤í”Œ ëª¨ë“œ",
          soften: (s) =>
            s
              .replaceAll("ê·œì¹™", "ì•½ì†")
              .replaceAll("ê¸°í•œ", "íƒ€ì´ë°")
              .replaceAll("ë¦¬ìŠ¤í¬", "ì¡°ì‹¬ í¬ì¸íŠ¸"),
          tips: {
            conflict: ["ê°ì • ì˜¬ë¼ì˜¤ë©´ í•œ ë°•ì ì‰¬ê³  ë§í•˜ì.", "ë¬¸ìë³´ë‹¤ ì–¼êµ´ ë³´ê³  ì–˜ê¸°í•˜ëŠ” ê²Œ ë‹µ."],
            money: ["ëˆ ì–˜ê¸°ëŠ” ê¸°ì¤€ì„ ë¨¼ì € ë§ì¶”ëŠ” ê²Œ í¸í•´.", "í°ëˆë§Œ ê°™ì´ ê²°ì •í•˜ê³  ë‚˜ë¨¸ì§„ ììœ ë¡œ ê°€ì."],
          },
        },
        biz: {
          title: "ë™ì—…ì ëª¨ë“œ",
          soften: (s) =>
            s
              .replaceAll("ê°ì •", "ì»¤ë®¤ë‹ˆì¼€ì´ì…˜")
              .replaceAll("ì„œë¡œ", "ì–‘ì¸¡")
              .replaceAll("ì˜¤í•´", "ì •ë³´ ë¹„ëŒ€ì¹­"),
          tips: {
            conflict: ["ì˜ì‚¬ê²°ì • í”„ë¡œì„¸ìŠ¤ë¥¼ ë¬¸ì„œë¡œ ë°•ì•„.", "íšŒì˜ëŠ” ì˜ì œ 1ê°œì”©ë§Œ ì¡ì."],
            money: ["ì¬ë¬´ëŠ” ë£°ì´ ì•„ë‹ˆë¼ ì •ì±…ì´ë‹¤.", "ì§€ì¶œ ê¸°ì¤€/ìŠ¹ì¸ê¶Œì/í•œë„ë¥¼ ê³ ì •í•´."],
          },
        },
      };

      function applyTone(text, toneKey) {
        const t = TONE[toneKey] || TONE.couple;
        return t.soften(text);
      }
      function toneExtraTip(section, toneKey) {
        const t = TONE[toneKey] || TONE.couple;
        const pool = t.tips[section] || [];
        if (!pool.length) return "";
        return pool[hashToIndex(`${toneKey}|${section}`, pool.length)];
      }

      /* ======================================================
  5. ì„¹ì…˜ ë ˆì´ë” ë Œë”
====================================================== */
      function renderRadar(scores) {
        const svg = sectionRadarSvg;
        const keys = ["ì„±í–¥", "ê´€ê³„", "ëˆ", "ì¼", "ê±´ê°•"];
        const cx = 160;
        const cy = 160;
        const R = 110;
        svg.innerHTML = "";

        const ang = (i) => ((Math.PI * 2) / 5) * i - Math.PI / 2;
        const pt = (v, i) => [cx + R * v * Math.cos(ang(i)), cy + R * v * Math.sin(ang(i))];
        const polyPoints = (arr, scale = 1) =>
          arr.map((v, i) => pt(v * scale, i).map((n) => n.toFixed(2)).join(",")).join(" ");

        const el = (name, attrs = {}) => {
          const e = document.createElementNS("http://www.w3.org/2000/svg", name);
          Object.entries(attrs).forEach(([k, v]) => e.setAttribute(k, v));
          return e;
        };

        for (let r = 1; r <= 4; r++) {
          svg.appendChild(
            el("polygon", {
              points: polyPoints([r / 4, r / 4, r / 4, r / 4, r / 4]),
              fill: "none",
              stroke: "rgba(15,23,42,0.14)",
              "stroke-width": "1",
            })
          );
        }

        keys.forEach((name, i) => {
          const [x, y] = pt(1, i);
          svg.appendChild(
            el("line", { x1: cx, y1: cy, x2: x, y2: y, stroke: "rgba(15,23,42,0.22)", "stroke-width": "1" })
          );
          const [lx, ly] = pt(1.18, i);
          const text = el("text", {
            x: lx,
            y: ly,
            "text-anchor": "middle",
            "dominant-baseline": "middle",
            "font-size": "13",
            "font-weight": "900",
            fill: "#0f172a",
          });
          text.textContent = name;
          svg.appendChild(text);
        });

        const vals = keys.map((k) => clamp01((scores[k] ?? 50) / 100));
        const poly = el("polygon", {
          points: polyPoints(vals, 0.02),
          fill: "rgba(37,99,235,0.28)",
          stroke: "rgba(37,99,235,0.9)",
          "stroke-width": "2",
          "stroke-linejoin": "round",
        });
        svg.appendChild(poly);

        let p = 0.02;
        function anim() {
          p += 0.05;
          if (p > 1) p = 1;
          poly.setAttribute("points", polyPoints(vals, p));
          if (p < 1) requestAnimationFrame(anim);
        }
        requestAnimationFrame(anim);
      }

      /* ======================================================
  6. ì‹ ë…„ìš´ì„¸ ì›”ë³„
====================================================== */
      function pickMonthlyCopy(ctx) {
        const { month, seasonElem, top, weak, relTop, relWeak } = ctx;
        let mode = "steady";
        if (relTop === "ìƒ" || relTop === "ë™") mode = "push";
        if (relWeak === "ìƒ" || relWeak === "ë™") mode = mode === "push" ? "pushPlus" : "recover";
        if (relTop === "ê·¹" || relTop === "ëˆŒë¦¼") mode = "brake";

        const monthLabel = `${month}ì›”`;
        const templates = {
          push: [
            [`${monthLabel}ì€ íë¦„ì´ ë„¤ í¸ì´ì•¼. ë°€ì–´ë¶™ì´ë©´ ì„±ê³¼ê°€ ë‚œë‹¤.`, "ê°€ì¥ ì¤‘ìš”í•œ ì¼ 1ê°œë§Œ ë¨¼ì € ëë‚´."],
            [`${monthLabel}ì€ ì†ë„ê°€ ë¶™ëŠ” ë‹¬ì´ì•¼. ë¯¸ë£¨ë˜ ê±° ì²˜ë¦¬í•˜ê¸° ë”± ì¢‹ì•„.`, "ì—°ë½/ê²°ì •/ì •ë¦¬ ì¤‘ í•˜ë‚˜ëŠ” ì´ë²ˆ ë‹¬ì— ëë‚´."],
          ],
          pushPlus: [
            [`${monthLabel}ì€ ì¢‹ì€ íë¦„ + íšŒë³µê¹Œì§€ ê°™ì´ ì˜¤ëŠ” ë‹¬ì´ì•¼.`, "ìš•ì‹¬ë‚´ë„ ë˜ëŠ”ë°, ìˆ˜ë©´ë§Œì€ ê¼­ ì§€ì¼œ."],
            [`${monthLabel}ì€ ì˜ í’€ë¦¬ë©´ì„œ í¸í•´ì§€ëŠ” ë‹¬ì´ì•¼.`, "ìƒˆë¡œ ë²Œë¦¬ê¸°ë³´ë‹¤ ê¸°ì¡´ ê±¸ ì—…ê·¸ë ˆì´ë“œí•˜ë©´ í¬ê²Œ ë‚¨ì•„."],
          ],
          recover: [
            [`${monthLabel}ì€ íšŒë³µì´ ë³µì´ë‹¤. ì»¨ë””ì…˜ë§Œ ì¡ì•„ë„ ì¼ì´ í’€ë¦°ë‹¤.`, "ë¬´ë¦¬í•œ ì•½ì† ì¤„ì´ê³  ë£¨í‹´ í•˜ë‚˜ ë¶™ì—¬."],
            [`${monthLabel}ì€ ì •ë¦¬í•˜ë©´ ìš´ì´ ë¶™ëŠ” ë‹¬ì´ì•¼.`, "ê³µê°„/ëˆ/ì¼ì • ì¤‘ í•˜ë‚˜ë§Œ ì •ë¦¬í•´ë„ ì²´ê° ì˜¨ë‹¤."],
          ],
          brake: [
            [`${monthLabel}ì€ ë¬´ë¦¬í•˜ë©´ ì†í•´ ë³´ëŠ” ë‹¬ì´ì•¼. ì†ë„ ì¤„ì´ëŠ” ê²Œ ì´ë“.`, "í° ê²°ì •ì€ 2ì£¼ë§Œ ë¯¸ë£¨ê³  í™•ì¸ë¶€í„° í•´."],
            [`${monthLabel}ì€ ì‹ ì¤‘ì´ ê³§ ëˆì´ë‹¤.`, "ê³„ì•½/íˆ¬ì/ì¶©ë™êµ¬ë§¤ëŠ” í•œ ë²ˆ ë” ì²´í¬."],
          ],
          steady: [
            [`${monthLabel}ì€ ìœ ì§€ê°€ ì´ê¸°ëŠ” ë‹¬ì´ì•¼. ê¸°ë³¸ë§Œ ì§€ì¼œë„ ì¶©ë¶„í•´.`, "ë£¨í‹´ 3ê°œ(ìˆ˜ë©´/ì‹ì‚¬/ì •ë¦¬)ë§Œ ì±™ê²¨."],
            [`${monthLabel}ì€ í° ë³€í™”ë³´ë‹¤ ì‘ì€ ê°œì„ ì´ ë§ì•„.`, "5% ê°œì„  ëª©í‘œë¡œ ê°€ë©´ ê¾¸ì¤€íˆ ì´ê¸´ë‹¤."],
          ],
        };

        const seed = `${month}|${seasonElem}|${top}|${weak}|${mode}`;
        const arr = templates[mode];
        const idx = hashToIndex(seed, arr.length);
        const [oneLine, tip] = arr[idx];
        return { oneLine, tip, tags: [mode, seasonElem] };
      }

      function makeMonthlyLuck(person) {
        const { top, weak } = getTopWeak(person.elements);
        const months = [];
        for (let m = 1; m <= 12; m++) {
          const flow = MONTH_FLOW[m];
          const s = flow.seasonTop;
          const relTop = relationElem(top, s);
          const relWeak = relationElem(weak, s);
          const { oneLine, tip, tags } = pickMonthlyCopy({ month: m, seasonElem: s, top, weak, relTop, relWeak });
          months.push({
            month: m,
            seasonElem: s,
            monthBranch: flow.monthBranch,
            summary: oneLine,
            tip,
            tags,
          });
        }
        return months;
      }

      function renderMonthly(person) {
        monthlyList.innerHTML = makeMonthlyLuck(person)
          .map(
            (m) => `
            <div class="rule-card">
              <div class="row" style="justify-content: space-between">
                <div class="section-title">${m.month}ì›” Â· ${m.seasonElem} íë¦„</div>
                <span class="mini">${m.tags.join(" Â· ")}</span>
              </div>
              <p class="lead">${escapeHtml(m.summary)}</p>
              <p class="mini">íŒ: ${escapeHtml(m.tip)}</p>
            </div>`
          )
          .join("");
      }

      /* ======================================================
  7. ë Œë”
====================================================== */
      function renderSummary(totalScore, firedRules, toneKey, coupleElements) {
        const summary = generateSummary(totalScore);
        totalScoreEl.textContent = `${totalScore}ì `;
        summaryMain.textContent = summary;
        summarySub.textContent = "Asia/Seoul ê¸°ì¤€ Â· ì ˆê¸°/ì˜¤í–‰ ê·œì¹™";

        const { top, weak } = getTopWeak(coupleElements);
        const pills = [
          `í•µì‹¬ ì˜¤í–‰: ${top}`,
          `ì•½í•œ ì˜¤í–‰: ${weak}`,
          `ë°œë™ ë£°: ${firedRules.length}ê°œ`,
          TONE[toneKey]?.title || "ì»¤í”Œ ëª¨ë“œ",
        ];
        summaryPills.innerHTML = pills
          .map((p) => `<span class="pill">${escapeHtml(p)}</span>`)
          .join("");
      }

      function renderRules(firedRules, toneKey, tokens) {
        if (!firedRules.length) {
          ruleList.innerHTML = `<p class="mini">ë°œë™ëœ ë£°ì´ ì•„ì§ ì—†ì–´. ì…ë ¥ê°’ì„ í™•ì¸í•´ì¤˜.</p>`;
          return;
        }

        const topElem = tokens?.topElem || "";
        const weakElem = tokens?.weakElem || "";

        ruleList.innerHTML = firedRules
          .sort((a, b) => b.tunedPriority - a.tunedPriority)
          .map((r) => {
            const evidence = applyTone(r.evidence, toneKey)
              .replace("{topElem}", topElem)
              .replace("{weakElem}", weakElem);
            const copy = applyTone(r.copies[0], toneKey);
            const extra = r.section === "ëˆ" ? toneExtraTip("money", toneKey) : toneExtraTip("conflict", toneKey);
            return `
            <div class="rule-card">
              <div class="rule-head">
                <b>${escapeHtml(r.id)}</b>
                <button class="like-btn" data-rule="${r.id}">ê³µê° ğŸ‘</button>
              </div>
              <p class="mini">ê·¼ê±°: ${escapeHtml(evidence)}</p>
              <p>${escapeHtml(copy)}${extra ? `<br/><span class="mini">+ ${escapeHtml(extra)}</span>` : ""}</p>
            </div>`;
          })
          .join("");
      }

      function renderAll() {
        const a = buildPerson(A);
        const b = buildPerson(B);
        const toneKey = toneSelect.value;
        const firedRules = evaluateRules(a, b);
        const sectionScores = calcSectionScores(firedRules);
        const totalScore = calcTotalFromSections(sectionScores);
        const coupleElements = combineElements(a.elements, b.elements);
        const coupleStats = getTopWeak(coupleElements);

        renderSummary(totalScore, firedRules, toneKey, coupleElements);
        renderTodayCoupleBox();
        renderRadar(sectionScores);
        renderRules(firedRules, toneKey, { topElem: coupleStats.top, weakElem: coupleStats.weak });
        renderMonthly({ elements: coupleElements });

        return { totalScore, firedRules, sectionScores, coupleElements };
      }

      /* ======================================================
  8. ê³µìœ  ì¹´ë“œ
====================================================== */
      function roundRect(ctx, x, y, w, h, r, fill) {
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.arcTo(x + w, y, x + w, y + h, r);
        ctx.arcTo(x + w, y + h, x, y + h, r);
        ctx.arcTo(x, y + h, x, y, r);
        ctx.arcTo(x, y, x + w, y, r);
        ctx.closePath();
        ctx.fillStyle = fill;
        ctx.fill();
      }

      function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        const words = text.split(" ");
        let line = "";
        for (let i = 0; i < words.length; i++) {
          const test = line + words[i] + " ";
          if (ctx.measureText(test).width > maxWidth && i > 0) {
            ctx.fillText(line, x, y);
            line = words[i] + " ";
            y += lineHeight;
          } else {
            line = test;
          }
        }
        ctx.fillText(line, x, y);
      }

      async function generateShareCard(payload) {
        const c = document.getElementById("shareCanvas");
        const ctx = c.getContext("2d");

        const g = ctx.createLinearGradient(0, 0, 0, c.height);
        g.addColorStop(0, "#0b1621");
        g.addColorStop(0.5, "#101f2e");
        g.addColorStop(1, "#14273b");
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, c.width, c.height);

        const pad = 70;
        const cardX = pad;
        const cardY = pad;
        const cardW = c.width - pad * 2;
        const cardH = c.height - pad * 2;
        roundRect(ctx, cardX, cardY, cardW, cardH, 40, "rgba(255,255,255,0.92)");

        ctx.fillStyle = "#0f172a";
        ctx.font = "800 52px IBM Plex Sans KR";
        ctx.fillText(payload.title, cardX + 50, cardY + 120);

        ctx.font = "700 30px IBM Plex Sans KR";
        ctx.fillStyle = "rgba(15,23,42,0.7)";
        ctx.fillText(payload.toneLabel, cardX + 50, cardY + 170);

        ctx.font = "800 130px IBM Plex Sans KR";
        ctx.fillStyle = "#0f172a";
        ctx.fillText(String(payload.score), cardX + 50, cardY + 320);
        ctx.font = "700 32px IBM Plex Sans KR";
        ctx.fillStyle = "rgba(15,23,42,0.7)";
        ctx.fillText("ê¶í•© ì ìˆ˜", cardX + 50, cardY + 370);

        ctx.font = "700 32px IBM Plex Sans KR";
        ctx.fillStyle = "rgba(15,23,42,0.85)";
        ctx.fillText(`í•µì‹¬ ì˜¤í–‰: ${payload.topElem}`, cardX + 50, cardY + 450);

        ctx.font = "700 32px IBM Plex Sans KR";
        ctx.fillStyle = "rgba(15,23,42,0.9)";
        wrapText(ctx, `ì´í‰: ${payload.summary}`, cardX + 50, cardY + 530, cardW - 100, 44);

        ctx.font = "700 28px IBM Plex Sans KR";
        ctx.fillStyle = "rgba(15,23,42,0.78)";
        wrapText(ctx, `ì˜¤ëŠ˜: ${payload.todayLine}`, cardX + 50, cardY + 720, cardW - 100, 40);

        ctx.font = "700 26px IBM Plex Sans KR";
        ctx.fillStyle = "rgba(15,23,42,0.6)";
        ctx.fillText("funnyfunny.cloud", cardX + 50, cardY + cardH - 70);

        return new Promise((resolve) => c.toBlob(resolve, "image/png", 1.0));
      }

      async function shareCard() {
        const toneKey = toneSelect.value;
        const state = renderAll();
        const topElem = getTopWeak(state.coupleElements).top;
        const blob = await generateShareCard({
          title: "ê¶í•© ë¦¬í¬íŠ¸",
          score: state.totalScore,
          summary: summaryMain.textContent,
          todayLine: todayCoupleLine.textContent,
          topElem,
          toneLabel: TONE[toneKey]?.title || "ì»¤í”Œ ëª¨ë“œ",
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `ê¶í•©ì¹´ë“œ_${new Date().toISOString().slice(0, 10)}.png`;
        a.click();

        try {
          await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]);
          shareStatus.textContent = "ì¹´ë“œë¥¼ ìƒì„±í•˜ê³  í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´.";
        } catch {
          shareStatus.textContent = "ì¹´ë“œë¥¼ ìƒì„±í–ˆì–´. ë‹¤ìš´ë¡œë“œë¥¼ í™•ì¸í•´ì¤˜.";
        }
      }

      /* ======================================================
  INIT
====================================================== */
      function init() {
        const cfg = loadTuneCfg();
        tuneStrength.value = String(cfg.strength ?? 1);
        tuneLabel.textContent = Number(tuneStrength.value).toFixed(1);
        updateTuneStatus();
        renderAll();
      }

      document.addEventListener("click", (e) => {
        const btn = e.target.closest(".like-btn");
        if (!btn) return;
        const ruleId = btn.dataset.rule;
        feedback(ruleId);
        btn.textContent = "ê³µê°ë¨ âœ”";
        btn.disabled = true;
      });

      tuneStrength.addEventListener("input", () => {
        const v = Number(tuneStrength.value);
        tuneLabel.textContent = v.toFixed(1);
        saveTuneCfg({ strength: v });
        updateTuneStatus();
        renderAll();
      });

      tuneReset.addEventListener("click", () => {
        localStorage.removeItem(TUNE_KEY);
        updateTuneStatus();
        renderAll();
      });

      toneSelect.addEventListener("change", renderAll);
      todayLuckBtn.addEventListener("click", renderTodayCoupleBox);
      shareBtn.addEventListener("click", shareCard);

      init();
    </script>
  </body>
</html>
