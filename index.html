<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title data-i18n-title="metaTitle">ì‚¬ì£¼í’€ì´ Â· ê¶í•© Â· ì˜¤ëŠ˜ìš´ì„¸ Â· ì‹ ë…„ìš´ì„¸</title>
    <meta
      property="og:image"
      content="https://dummyimage.com/1200x630/0b1220/ffffff&text=SAJU"
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:image"
      content="https://dummyimage.com/1200x630/0b1220/ffffff&text=SAJU"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”®</text></svg>"
    />

    <!-- Adsense (ìš”ì²­ ë°˜ì˜) -->
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1204894220949193"
      crossorigin="anonymous"
    ></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@400;600;800&family=Playfair+Display:wght@700;800&family=Noto+Serif+KR:wght@400;600;700&display=swap");

      :root {
        --bg1: #0a0f1a;
        --bg2: #0f1623;
        --bg3: #141b2d;
        --card: rgba(255, 255, 255, 0.98);
        --text: #0f172a;
        --muted: rgba(15, 23, 42, 0.7);
        --line: rgba(15, 23, 42, 0.08);
        --accent: #6366f1;
        --accent-hover: #4f46e5;
        --accent2: #f59e0b;
        --accent-grad: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        --shadow: 0 20px 60px rgba(0, 0, 0, 0.3),
          0 0 0 1px rgba(255, 255, 255, 0.1);
        --shadow-hover: 0 24px 80px rgba(99, 102, 241, 0.2),
          0 0 0 1px rgba(255, 255, 255, 0.15);
        --radius: 20px;
        --radius-sm: 14px;
        --font-body: "IBM Plex Sans KR", "Apple SD Gothic Neo", sans-serif;
        --font-title: "Playfair Display", "Nanum Myeongjo", serif;
        --font-service: "Noto Serif KR", "Nanum Myeongjo", serif;
      }

      * {
        box-sizing: border-box;
      }
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(15, 23, 42, 0.05);
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(99, 102, 241, 0.3);
        border-radius: 5px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(99, 102, 241, 0.5);
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: var(--font-body);
        background: radial-gradient(
            1400px 700px at 8% -5%,
            rgba(99, 102, 241, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            1200px 600px at 92% 5%,
            rgba(139, 92, 246, 0.12) 0%,
            transparent 50%
          ),
          radial-gradient(
            1000px 500px at 50% 100%,
            rgba(59, 130, 246, 0.08) 0%,
            transparent 60%
          ),
          linear-gradient(
            180deg,
            var(--bg1) 0%,
            var(--bg2) 50%,
            var(--bg3) 100%
          );
        color: rgba(255, 255, 255, 0.95);
        font-size: 16px;
        position: relative;
      }
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: radial-gradient(
            circle at 20% 30%,
            rgba(99, 102, 241, 0.03) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(139, 92, 246, 0.03) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: 0;
      }
      .wrap {
        max-width: 1080px;
        margin: 16px auto;
        padding: 32px 20px 56px;
        position: relative;
        z-index: 1;
      }
      h1,
      h2,
      h3 {
        margin: 0 0 10px;
      }
      h1 {
        font-family: var(--font-title);
        font-weight: 800;
        letter-spacing: 0.02em;
        font-size: 32px;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .logo-emoji {
        display: inline-block;
        width: 1.05em;
        height: 1.05em;
        margin-right: 8px;
        vertical-align: -0.12em;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%238b5cf6'/%3E%3Cstop offset='1' stop-color='%236366f1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='26' r='18' fill='url(%23g)'/%3E%3Ccircle cx='26' cy='20' r='6' fill='rgba(255,255,255,0.8)'/%3E%3Cpath d='M18 50c6 4 22 4 28 0' fill='none' stroke='%236366f1' stroke-width='4' stroke-linecap='round'/%3E%3Crect x='22' y='46' width='20' height='6' rx='3' fill='%237c3aed'/%3E%3C/svg%3E")
          no-repeat center/contain;
        filter: drop-shadow(0 2px 6px rgba(99, 102, 241, 0.3));
      }
      .logo-text {
        -webkit-text-fill-color: transparent;
      }
      h2 {
        font-size: 24px;
        font-weight: 800;
        color: var(--text);
      }
      h3 {
        font-size: 19px;
        font-weight: 800;
        color: var(--text);
      }
      .hero {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
        padding: 16px 0;
      }
      .badge {
        font-size: 14px;
        font-weight: 700;
        letter-spacing: 0.08em;
        padding: 12px 20px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        font-family: var(--font-service);
      }
      .badge.service-name {
        font-size: 16px;
        font-weight: 700;
        letter-spacing: 0.1em;
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.2) 0%,
          rgba(139, 92, 246, 0.2) 100%
        );
        border: 1px solid rgba(99, 102, 241, 0.3);
        color: rgba(255, 255, 255, 0.98);
        text-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
      }
      .badge:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      }
      .badge.service-name:hover {
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.25) 0%,
          rgba(139, 92, 246, 0.25) 100%
        );
        border-color: rgba(99, 102, 241, 0.4);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.25);
      }
      .card {
        background: var(--card);
        color: var(--text);
        border-radius: var(--radius);
        padding: 28px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: var(--shadow);
        backdrop-filter: blur(20px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--accent-grad);
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
      }
      .card:hover::before {
        opacity: 1;
      }
      .card-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .card-head.center {
        justify-content: center;
        text-align: center;
      }
      .score {
        font-size: 36px;
        font-weight: 800;
        background: var(--accent-grad);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .lead {
        font-size: 1.2rem;
        font-weight: 800;
        line-height: 1.7;
        color: var(--text);
      }
      .mini {
        font-size: 0.95rem;
        color: var(--muted);
        font-weight: 600;
        line-height: 1.7;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-start;
      }
      .row.center {
        justify-content: center;
      }
      .btn {
        padding: 14px 20px;
        border-radius: 999px;
        border: none;
        font-weight: 800;
        cursor: pointer;
        background: var(--accent-grad);
        color: #fff;
        font-size: 15px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        position: relative;
        overflow: hidden;
        z-index: 1;
      }
      .btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
        z-index: -1;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      }
      .btn:hover::before {
        width: 300px;
        height: 300px;
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn * {
        position: relative;
        z-index: 1;
      }
      .btn.outline {
        background: rgba(255, 255, 255, 0.95);
        color: var(--text);
        border: 2px solid rgba(15, 23, 42, 0.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }
      .btn.outline:hover {
        background: #fff;
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2);
      }
      .btn.ghost {
        background: rgba(15, 23, 42, 0.06);
        color: var(--text);
        border: 1px solid rgba(15, 23, 42, 0.12);
        box-shadow: none;
      }
      .btn.ghost:hover {
        background: rgba(15, 23, 42, 0.1);
        border-color: rgba(15, 23, 42, 0.2);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .btn.compact {
        display: inline-flex;
        align-items: center;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 700;
        box-shadow: none;
      }
      .btn.outline.compact {
        border-width: 1px;
      }
      select,
      input[type="range"],
      input[type="date"],
      input[type="time"],
      input[type="number"],
      input[type="text"] {
        padding: 12px 14px;
        border-radius: var(--radius-sm);
        border: 2px solid rgba(15, 23, 42, 0.12);
        font-weight: 600;
        font-size: 15px;
        transition: all 0.2s ease;
        background: rgba(255, 255, 255, 0.98);
        width: 100%;
        flex: 1;
        min-width: 0;
        box-sizing: border-box;
        height: 48px;
        line-height: 1.5;
      }
      select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236366f1' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 12px;
        padding-right: 36px;
        cursor: pointer;
      }
      .rule-card .row {
        width: 100%;
        display: flex;
        align-items: stretch;
        gap: 12px;
      }
      .rule-card .row > * {
        flex: 1;
        min-width: 120px;
      }
      .rule-card .row:not(:first-child) {
        margin-top: 12px;
      }
      .rule-card p.mini {
        margin-top: 12px;
        margin-bottom: 0;
        text-align: left;
        font-size: 0.9rem;
      }
      select:focus,
      input[type="text"]:focus,
      input[type="date"]:focus,
      input[type="time"]:focus,
      input[type="number"]:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }
      input[type="checkbox"] {
        transform: translateY(1px);
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--accent);
      }
      .rule-card {
        border: 1px solid var(--line);
        border-radius: var(--radius-sm);
        padding: 20px;
        margin-bottom: 12px;
        background: rgba(255, 255, 255, 0.98);
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }
      .rule-card:hover {
        border-color: rgba(99, 102, 241, 0.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
      }
      .rule-card h3 {
        margin-bottom: 16px;
        text-align: left;
        font-size: 18px;
      }
      .rule-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .radar {
        width: 100%;
        max-width: 420px;
        margin: 12px auto 0;
        display: block;
      }
      .elements-radar {
        max-width: 600px;
        width: 100%;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 20px;
        max-width: 100%;
      }
      .input-container {
        max-width: 900px;
        margin: 16px auto;
      }
      .pill-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        font-weight: 800;
        padding: 8px 14px;
        border-radius: 999px;
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.08) 0%,
          rgba(139, 92, 246, 0.08) 100%
        );
        border: 1px solid rgba(99, 102, 241, 0.15);
        transition: all 0.2s ease;
      }
      .pill:hover {
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.12) 0%,
          rgba(139, 92, 246, 0.12) 100%
        );
        border-color: rgba(99, 102, 241, 0.25);
        transform: translateY(-1px);
      }
      .pill.emphasis {
        font-size: 14px;
        padding: 10px 16px;
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: #fff;
        border-color: rgba(79, 70, 229, 0.4);
        box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35);
      }
      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: rgba(15, 23, 42, 0.06);
        color: #0f172a;
        font-weight: 800;
        line-height: 1.2;
      }
      .chip b {
        font-weight: 900;
      }
      .chip.e-wood {
        background: #e8f7e9;
        color: #0f3d2e;
        border-color: #bfe7c6;
      }
      .chip.e-fire {
        background: #ffe9e3;
        color: #7a1f16;
        border-color: #ffc5b5;
      }
      .chip.e-earth {
        background: #f8f1df;
        color: #5a3b12;
        border-color: #e7d3a7;
      }
      .chip.e-metal {
        background: #eef3ff;
        color: #1b3a70;
        border-color: #c9d6ff;
      }
      .chip.e-water {
        background: #e6f5ff;
        color: #0c3550;
        border-color: #b7e4ff;
      }
      .section-title {
        font-weight: 800;
        font-size: 1.05rem;
        color: var(--text);
        letter-spacing: -0.01em;
        text-align: left;
      }
      .share-note {
        margin-top: 10px;
      }
      .pdf-area {
        background: linear-gradient(180deg, var(--bg1), var(--bg2), var(--bg3));
        padding: 24px 24px 12px;
        border-radius: var(--radius);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .step {
        display: none;
        animation: fadeIn 0.4s ease;
      }
      .step.active {
        display: block;
      }
      .menu-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 24px;
        max-width: 800px;
        margin: 16px auto;
      }
      .menu-btn {
        border: none;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        color: var(--text);
        border-radius: 24px;
        padding: 40px 32px;
        text-align: center;
        cursor: pointer;
        font-weight: 800;
        box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08),
          0 0 0 1px rgba(15, 23, 42, 0.05);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 280px;
      }
      .menu-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, transparent 0%, transparent 100%);
        opacity: 0;
        transition: opacity 0.4s ease;
      }
      .menu-btn[data-mode="newyear"] {
        background: linear-gradient(
          135deg,
          rgba(139, 92, 246, 0.05) 0%,
          rgba(99, 102, 241, 0.05) 100%
        );
        border: 2px solid rgba(139, 92, 246, 0.15);
      }
      .menu-btn[data-mode="newyear"]::after {
        content: "âœ¨";
        font-size: 64px;
        position: absolute;
        top: 32px;
        opacity: 0.3;
        animation: float 3s ease-in-out infinite;
      }
      .menu-btn[data-mode="today"] {
        background: linear-gradient(
          135deg,
          rgba(34, 197, 94, 0.05) 0%,
          rgba(59, 130, 246, 0.05) 100%
        );
        border: 2px solid rgba(34, 197, 94, 0.15);
      }
      .menu-btn[data-mode="today"]::after {
        content: "ğŸ”®";
        font-size: 64px;
        position: absolute;
        top: 32px;
        opacity: 0.3;
        animation: float 3s ease-in-out infinite;
        animation-delay: 0.5s;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }
      .menu-btn:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 60px rgba(99, 102, 241, 0.2),
          0 0 0 1px rgba(99, 102, 241, 0.3);
      }
      .menu-btn[data-mode="newyear"]:hover {
        background: linear-gradient(
          135deg,
          rgba(139, 92, 246, 0.1) 0%,
          rgba(99, 102, 241, 0.1) 100%
        );
        border-color: rgba(139, 92, 246, 0.4);
      }
      .menu-btn[data-mode="today"]:hover {
        background: linear-gradient(
          135deg,
          rgba(34, 197, 94, 0.1) 0%,
          rgba(59, 130, 246, 0.1) 100%
        );
        border-color: rgba(34, 197, 94, 0.4);
      }
      .menu-btn:hover::after {
        opacity: 0.5;
        transform: scale(1.1);
      }
      .menu-btn:active {
        transform: translateY(-4px) scale(1);
      }
      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(10, 15, 26, 0.85);
        backdrop-filter: blur(12px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .loading-overlay.active {
        display: flex;
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .loading-card {
        background: var(--card);
        color: var(--text);
        border-radius: var(--radius);
        padding: 32px 36px;
        min-width: 300px;
        text-align: center;
        box-shadow: var(--shadow-hover);
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .spinner {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 4px solid rgba(99, 102, 241, 0.2);
        border-top-color: var(--accent);
        margin: 0 auto 16px;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .menu-btn small {
        display: block;
        margin-top: 16px;
        font-size: 15px;
        font-weight: 500;
        color: rgba(15, 23, 42, 0.7);
        line-height: 1.6;
        max-width: 240px;
      }
      .menu-btn .menu-title {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 12px;
        color: var(--text);
        position: relative;
        z-index: 1;
      }
      .menu-btn[data-mode="newyear"] .menu-title {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .menu-btn[data-mode="today"] .menu-title {
        background: linear-gradient(135deg, #22c55e 0%, #3b82f6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        font-size: 14px;
        border-radius: var(--radius-sm);
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }
      .report-table th,
      .report-table td {
        border: 1px solid rgba(15, 23, 42, 0.08);
        padding: 12px 14px;
        text-align: left;
        vertical-align: top;
      }
      .report-table th {
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.08) 0%,
          rgba(139, 92, 246, 0.08) 100%
        );
        font-weight: 800;
        color: var(--text);
      }
      .report-table tr:hover {
        background: rgba(99, 102, 241, 0.03);
      }
      .report-section {
        margin-top: 12px;
        text-align: left;
      }
      .report-section h3 {
        margin-bottom: 6px;
        text-align: left;
      }
      .report-section p.mini {
        text-align: left;
        line-height: 1.8;
      }
      .hidden {
        display: none !important;
      }

      @media (max-width: 720px) {
        .wrap {
          padding: 24px 16px 40px;
        }
        .menu-grid {
          grid-template-columns: 1fr;
          gap: 20px;
          max-width: 100%;
        }
        .menu-btn {
          min-height: 240px;
          padding: 32px 24px;
        }
        .menu-btn .menu-title {
          font-size: 24px;
        }
        .menu-btn::after {
          font-size: 56px;
          top: 24px;
        }
        #stepInput > div:first-child {
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
        }
        #stepInput > div:first-child .btn {
          width: 100%;
        }
        h1 {
          font-size: 26px;
        }
        h2 {
          font-size: 20px;
        }
        .card {
          padding: 20px;
          border-radius: var(--radius-sm);
        }
        .grid-2 {
          grid-template-columns: 1fr;
          gap: 16px;
        }
        .input-container {
          max-width: 100%;
        }
        .rule-card .row > * {
          min-width: 100%;
        }
        .card-head {
          flex-direction: column;
          align-items: flex-start;
          gap: 16px;
        }
        .menu-grid {
          grid-template-columns: 1fr;
          gap: 16px;
        }
        .menu-btn {
          padding: 20px 18px;
        }
        .btn {
          padding: 12px 18px;
          font-size: 14px;
        }
        .hero {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
        .badge {
          font-size: 11px;
          padding: 8px 14px;
        }
        body {
          font-size: 15px;
        }
      }
    </style>
    <style>
    .adsense-block {
      margin: 16px 0;
      display: flex;
      justify-content: center;
    }
    .adsbygoogle {
      display: block;
      margin: 16px auto;
        text-align: center;
}
  </style>
  <style>
    .lang-switch {
      position: fixed;
      top: 16px;
      right: 16px;
      display: inline-flex;
      gap: 0;
      padding: 3px;
      border-radius: 999px;
      background: rgba(10, 15, 26, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }
    .lang-switch button {
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      font-weight: 700;
      padding: 7px 14px;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 44px;
      text-align: center;
      letter-spacing: 0.02em;
    }
    .lang-switch button.active {
      background: #6366f1;
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
    }
    .lang-switch button:not(.active):hover {
      background: rgba(99, 102, 241, 0.2);
      color: rgba(255, 255, 255, 0.9);
    }
  </style>
</head>

  <body>
    <div class="lang-switch" role="tablist" aria-label="Language switcher">
      <button type="button" data-lang="ko" class="active">KR</button>
      <button type="button" data-lang="en">EN</button>
    </div>
    <div class="wrap">
      <div class="hero">
        <div class="badge service-name" data-i18n="serviceName">ì‚¬ì£¼í’€ì´</div>
        <div style="display: flex; gap: 8px; align-items: center">
          <div class="badge" id="todayBadge"></div>
          <a
            href="https://funnyfunny.cloud/"
            target="_blank"
            rel="noopener noreferrer"
            class="btn outline compact"
            style="text-decoration: none; white-space: nowrap"
            data-i18n="btnOtherServices"
          >
            ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë³´ê¸°
          </a>
        </div>
      </div>

      <!-- Step 1: ë©”ë‰´ -->
      <section id="stepMenu" class="step active">
        <div class="card">
          <div class="card-head">
            <div>
              <h1
                style="
                  font-family: var(--font-service);
                  font-weight: 700;
                  letter-spacing: 0.02em;
                "
              >
                <span class="logo-emoji" aria-hidden="true"></span>
                <span class="logo-text" data-i18n="serviceName">ì‚¬ì£¼í’€ì´</span>
              </h1>
              <p class="mini" data-i18n="menuDesc">
                ì‹ ë…„ìš´ì„¸/ì˜¤ëŠ˜ìš´ì„¸ ì¤‘ ì„ íƒí•˜ë©´ ë‹¨ê³„ë³„ë¡œ ì…ë ¥ë°›ê³  ê²°ê³¼ë¥¼ ë³´ì—¬ì¤„ê²Œ.
              </p>
            </div>
          </div>
          <div class="menu-grid" style="margin-top: 32px">
            <button class="menu-btn" data-mode="newyear">
              <span class="menu-title" data-i18n="menuNewYear">ì‹ ë…„ìš´ì„¸</span>
              <small data-i18n-html="menuNewYearDesc">2026ë…„ í•œ í•´ì˜ íë¦„ì„<br />ì›”ë³„ë¡œ ì‚´í´ë³´ê¸°</small>
            </button>
            <button class="menu-btn" data-mode="today">
              <span class="menu-title" data-i18n="menuToday">ì˜¤ëŠ˜ì˜ ìš´ì„¸</span>
              <small data-i18n-html="menuTodayDesc">ì˜¤ëŠ˜ í•˜ë£¨ì˜ ê¸°ìš´ê³¼<br />í–‰ë™ ê°€ì´ë“œë¥¼ í™•ì¸í•˜ê¸°</small>
            </button>
          </div>
        </div>
      </section>

      <!-- Step 2: ì…ë ¥ -->
      <section id="stepInput" class="step">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 12px;
          "
        >
          <button class="btn outline" id="backToMenu" style="margin: 0" data-i18n="btnBackToMenu">
            ë©”ë‰´ë¡œ
          </button>
          <button
            class="btn outline"
            id="clearSaved"
            style="
              margin: 0;
              border-color: rgba(239, 68, 68, 0.4);
              color: rgba(239, 68, 68, 0.9);
              background: rgba(239, 68, 68, 0.05);
            "
            data-i18n="btnClearSaved"
          >
            ì €ì¥ ì´ˆê¸°í™”
          </button>
        </div>
        <div class="card" id="inputCard">
          <div class="card-head center">
            <div style="width: 100%">
              <h1 id="inputTitle" data-i18n="inputTitle">ì…ë ¥</h1>
              <p class="mini" id="inputDesc"></p>
            </div>
          </div>

          <div class="input-container">
            <div class="grid-2" style="margin-top: 20px">
              <div class="rule-card" id="panelA">
                <h3 data-i18n="inputBirthInfo">ì¶œìƒ ì •ë³´</h3>
                <div class="row">
                  <input id="aDate" type="date" />
                  <select id="aHourBranch">
                    <option value="ì">ì (00:00-01:30)</option>
                    <option value="ì¶•">ì¶• (01:31-03:30)</option>
                    <option value="ì¸">ì¸ (03:31-05:30)</option>
                    <option value="ë¬˜">ë¬˜ (05:31-07:30)</option>
                    <option value="ì§„">ì§„ (07:31-09:30)</option>
                    <option value="ì‚¬">ì‚¬ (09:31-11:30)</option>
                    <option value="ì˜¤">ì˜¤ (11:31-13:30)</option>
                    <option value="ë¯¸">ë¯¸ (13:31-15:30)</option>
                    <option value="ì‹ ">ì‹  (15:31-17:30)</option>
                    <option value="ìœ ">ìœ  (17:31-19:30)</option>
                    <option value="ìˆ ">ìˆ  (19:31-21:30)</option>
                    <option value="í•´">í•´ (21:31-23:30)</option>
                  </select>
                </div>
                <div class="row hidden" style="margin-top: 8px">
                  <label class="mini">
                    <input id="aTimeUnknown" type="checkbox" />
                    <span data-i18n="inputTimeUnknown">ì‹œê°„ ëª¨ë¦„(ì‹œì£¼ ì œì™¸)</span>
                  </label>
                </div>
                <div class="row" style="margin-top: 8px">
                  <select id="aGender">
                    <option value="male" selected data-i18n="genderMale">ë‚¨ì</option>
                    <option value="female" data-i18n="genderFemale">ì—¬ì</option>
                  </select>
                </div>
                <div class="row hidden" style="margin-top: 8px">
                  <input
                    id="aDaewoonStart"
                    type="number"
                    min="0"
                    max="20"
                    step="1"
                    placeholder="ëŒ€ìš´ ì‹œì‘ ë‚˜ì´"
                  />
                </div>
                <!-- inputDescëŠ” JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì •ë¨ -->
                <div class="row hidden" style="margin-top: 8px">
                  <select id="aHiddenMode">
                    <option value="on" selected>ì¥ê°„ ë°˜ì˜</option>
                    <option value="off">ì¥ê°„ ë¯¸ë°˜ì˜</option>
                  </select>
                </div>
                <div class="row hidden" style="margin-top: 8px">
                  <input
                    id="aTzOffset"
                    type="number"
                    min="-12"
                    max="14"
                    step="0.5"
                    value="9"
                    placeholder="UTC+9"
                  />
                  <select id="aDstMode">
                    <option value="off" selected>DST ë¯¸ë°˜ì˜</option>
                    <option value="kr1988">í•œêµ­ DST(1988) ë°˜ì˜</option>
                  </select>
                </div>
                <p class="mini" data-i18n="shintoNote">ì‹ í† ì •ë¹„ê²° ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•´.</p>
              </div>

              <div class="rule-card" id="panelB">
                <h3 data-i18n="inputPartnerInfo">ìƒëŒ€ ì •ë³´</h3>
                <div class="row">
                  <input id="bDate" type="date" />
                  <select id="bHourBranch">
                    <option value="ì">ì (00:00-01:30)</option>
                    <option value="ì¶•">ì¶• (01:31-03:30)</option>
                    <option value="ì¸">ì¸ (03:31-05:30)</option>
                    <option value="ë¬˜">ë¬˜ (05:31-07:30)</option>
                    <option value="ì§„">ì§„ (07:31-09:30)</option>
                    <option value="ì‚¬">ì‚¬ (09:31-11:30)</option>
                    <option value="ì˜¤">ì˜¤ (11:31-13:30)</option>
                    <option value="ë¯¸">ë¯¸ (13:31-15:30)</option>
                    <option value="ì‹ ">ì‹  (15:31-17:30)</option>
                    <option value="ìœ ">ìœ  (17:31-19:30)</option>
                    <option value="ìˆ ">ìˆ  (19:31-21:30)</option>
                    <option value="í•´">í•´ (21:31-23:30)</option>
                  </select>
                </div>
                <div class="row hidden" style="margin-top: 8px">
                  <label class="mini">
                    <input id="bTimeUnknown" type="checkbox" />
                    ì‹œê°„ ëª¨ë¦„(ì‹œì£¼ ì œì™¸)
                  </label>
                </div>
                <div class="row" style="margin-top: 8px">
                  <select id="bGender">
                    <option value="male">ë‚¨ì</option>
                    <option value="female" selected>ì—¬ì</option>
                  </select>
                </div>
                <div class="row hidden" style="margin-top: 8px">
                  <input
                    id="bDaewoonStart"
                    type="number"
                    min="0"
                    max="20"
                    step="1"
                    placeholder="ëŒ€ìš´ ì‹œì‘ ë‚˜ì´"
                  />
                </div>
                <!-- inputDescëŠ” JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì •ë¨ -->
                <div class="row hidden" style="margin-top: 8px">
                  <select id="bHiddenMode">
                    <option value="on" selected>ì¥ê°„ ë°˜ì˜</option>
                    <option value="off">ì¥ê°„ ë¯¸ë°˜ì˜</option>
                  </select>
                </div>
                <div class="row hidden" style="margin-top: 8px">
                  <input
                    id="bTzOffset"
                    type="number"
                    min="-12"
                    max="14"
                    step="0.5"
                    value="9"
                    placeholder="UTC+9"
                  />
                  <select id="bDstMode">
                    <option value="off" selected>DST ë¯¸ë°˜ì˜</option>
                    <option value="kr1988">í•œêµ­ DST(1988) ë°˜ì˜</option>
                  </select>
                </div>
                <p class="mini" data-i18n="shintoNote">ì‹ í† ì •ë¹„ê²° ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•´.</p>
              </div>
            </div>

            <div class="row center" style="margin-top: 24px; gap: 8px">
              <span
                class="mini"
                style="font-size: 0.85rem; color: rgba(15, 23, 42, 0.5)"
                data-i18n="inputTimeNote"
              >
                â€» ì…ë ¥ ì‹œê°„ì€ í•œêµ­ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•´.
              </span>
            </div>
          </div>
          <div style="margin-top: 32px; text-align: center">
            <button
              class="btn"
              id="calcBtn"
              style="
                min-width: 200px;
                padding: 14px 32px;
                font-size: 16px;
                font-weight: 700;
              "
              data-i18n="btnCalculate"
            >
              í™•ì¸í•˜ê¸°
            </button>
          </div>
        </div>
      </section>

      <!-- Step 3: ê²°ê³¼ -->
      <section id="stepResult" class="step">
        <div class="row" style="margin-bottom: 12px">
          <button class="btn outline" id="backToInput" data-i18n="btnInputModify">ì…ë ¥ ìˆ˜ì •</button>
          <button class="btn outline" id="restartFlow" data-i18n="btnRestart">ë©”ë‰´ë¡œ</button>
        </div>

        <div id="pdfArea" class="pdf-area">
          <div class="card" id="resultElementsCard" style="padding: 40px">
            <h2 style="font-size: 28px; margin-bottom: 24px" data-i18n="resultElementsTitle">ì˜¤í–‰ ê¸°ìš´ ë¶„ì„</h2>
            <p
              class="lead"
              id="elementsSummary"
              style="font-size: 18px; margin-bottom: 32px"
            ></p>
            <svg
              id="elementsRadarSvg"
              class="radar elements-radar"
              viewBox="0 0 320 320"
              style="
                width: 100%;
                max-width: 500px;
                height: auto;
                margin: 0 auto 32px;
                display: block;
              "
            ></svg>
            <p
              class="mini"
              id="elementsDetail"
              style="font-size: 14px; line-height: 1.8"
            >
              â€”
            </p>
          </div>
          <div class="card" id="resultDeepCard">
            <h2 data-i18n="resultDeepTitle">ì‹¬í™” ë¶„ì„</h2>
            <div id="deepAnalysis"></div>
          </div>
          <div class="card" id="resultLuckCard">
            <h2 data-i18n="resultLuckTitle">ëŒ€ìš´ Â· ì„¸ìš´</h2>
            <div id="luckFlow"></div>
          </div>
          <div class="card" id="resultReportCard">
            <h2 data-i18n="resultReportTitle">ë³¸ì§ˆ ë¦¬í¬íŠ¸</h2>
            <div id="reportContent"></div>
          </div>
          <div class="card" id="resultSummaryCard">
            <div class="card-head">
              <div>
                <h2 id="resultTitle" data-i18n="resultSummaryTitle">ê¶í•© ìš”ì•½</h2>
                <p class="mini" id="summarySub" data-i18n="summarySub">
                  ì…ë ¥ ì‹œê°„ëŒ€ ê¸°ì¤€ Â· ì ˆê¸°/ì˜¤í–‰ ê·œì¹™
                </p>
              </div>
              <div class="score" id="totalScore">â€”</div>
            </div>
            <p class="lead" id="summaryMain">â€”</p>
            <div class="pill-row" id="summaryPills"></div>
          </div>

          <div class="card" id="resultTodayCard">
            <h2 style="margin-bottom: 20px; text-align: left" data-i18n="resultTodayTitle">
              ğŸ”® ì˜¤ëŠ˜ì˜ ìš´ì„¸
            </h2>
            <p
              class="lead"
              id="todayCoupleLine"
              style="
                font-size: 19px;
                line-height: 1.7;
                margin-bottom: 0;
                font-weight: 600;
                color: rgba(15, 23, 42, 0.9);
              "
            >
              â€”
            </p>
            <div id="todayCoupleMeta" style="margin-top: 0">â€”</div>
          </div>

          <div class="grid-2" id="resultCompatGrid">
            <div class="card" id="resultRadarCard">
              <h2 data-i18n="resultRadarTitle">ì„¹ì…˜ë³„ ê· í˜•</h2>
              <svg
                id="sectionRadarSvg"
                class="radar"
                viewBox="0 0 320 320"
              ></svg>
              <p class="mini" id="sectionRadarLegend" data-i18n="radarLegend">ê´€ê³„ì˜ ì „ì²´ ë°¸ëŸ°ìŠ¤</p>
            </div>

            <div class="card" id="resultABCard">
              <h2 data-i18n="resultABTitle">A/B ì‚¬ì£¼ ìš”ì•½</h2>
              <div class="grid-2" style="gap: 8px">
                <div>
                  <div class="section-title">A</div>
                  <div id="aPillars" class="mini"></div>
                </div>
                <div>
                  <div class="section-title">B</div>
                  <div id="bPillars" class="mini"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="card" id="resultRulesCard">
            <h2 data-i18n="resultRulesTitle">ê¶í•© í¬ì¸íŠ¸</h2>
            <div id="ruleList"></div>
          </div>

          <div class="card" id="resultMonthlyCard">
            <h2 data-i18n="resultMonthlyTitle">2026 ì‹ ë…„ìš´ì„¸ (ì›”ë³„)</h2>
            <div id="monthlyList"></div>
          </div>
        </div>

        <div class="card" id="shareCard" style="margin-top: 48px">
          <h2 data-i18n="shareCardTitle">ê³µìœ  Â· PDF</h2>
          <div class="row">
            <button class="btn" id="shareBtn" data-i18n="btnShare">ê³µìœ </button>
            <button class="btn outline" id="pdfBtn" data-i18n="btnPDF">PDF ì €ì¥</button>
          </div>
          <p class="mini share-note" id="shareStatus"></p>
          <canvas
            id="shareCanvas"
            width="1080"
            height="1350"
            style="display: none"
          ></canvas>
        </div>
      </section>
    </div>

    <div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
      <div class="loading-card">
        <div class="spinner"></div>
        <div class="lead" style="margin-bottom: 6px" data-i18n="loadingTitle">ì˜¤í–‰ ê· í˜• ê³„ì‚° ì¤‘</div>
        <div class="mini" data-i18n="loadingDesc">ì ˆê¸° ê¸°ì¤€ìœ¼ë¡œ ì •ë°€í•˜ê²Œ ë§ì¶”ëŠ” ì¤‘ì´ì•¼â€¦</div>
      </div>
    </div>

    <script src="./vendor/html2canvas.min.js"></script>
    <script src="./vendor/jspdf.umd.min.js"></script>

    <script>
      /* ======================================================
  0. ê¸°ë³¸ DOM
====================================================== */
      const todayBadge = document.getElementById("todayBadge");
      // t function will be defined later at line 6609
      // todayBadge will be set via applyTranslations()

      const stepMenu = document.getElementById("stepMenu");
      const stepInput = document.getElementById("stepInput");
      const stepResult = document.getElementById("stepResult");

      const inputTitle = document.getElementById("inputTitle");
      const inputDesc = document.getElementById("inputDesc");
      const panelA = document.getElementById("panelA");
      const panelB = document.getElementById("panelB");

      const aDate = document.getElementById("aDate");
      const aHourBranch = document.getElementById("aHourBranch");
      const aTimeUnknown = document.getElementById("aTimeUnknown");
      const aGender = document.getElementById("aGender");
      const aDaewoonStart = document.getElementById("aDaewoonStart");
      const aHiddenMode = document.getElementById("aHiddenMode");
      const aTzOffset = document.getElementById("aTzOffset");
      const aDstMode = document.getElementById("aDstMode");
      const bDate = document.getElementById("bDate");
      const bHourBranch = document.getElementById("bHourBranch");
      const bTimeUnknown = document.getElementById("bTimeUnknown");
      const bGender = document.getElementById("bGender");
      const bDaewoonStart = document.getElementById("bDaewoonStart");
      const bHiddenMode = document.getElementById("bHiddenMode");
      const bTzOffset = document.getElementById("bTzOffset");
      const bDstMode = document.getElementById("bDstMode");
      const calcBtn = document.getElementById("calcBtn");
      const backToMenu = document.getElementById("backToMenu");
      const clearSaved = document.getElementById("clearSaved");
      const backToInput = document.getElementById("backToInput");
      const restartFlow = document.getElementById("restartFlow");

      const resultTitle = document.getElementById("resultTitle");
      const resultElementsCard = document.getElementById("resultElementsCard");
      const resultDeepCard = document.getElementById("resultDeepCard");
      const resultLuckCard = document.getElementById("resultLuckCard");
      const resultReportCard = document.getElementById("resultReportCard");
      const elementsSummary = document.getElementById("elementsSummary");
      const elementsRadarSvg = document.getElementById("elementsRadarSvg");
      const elementsDetail = document.getElementById("elementsDetail");
      const deepAnalysis = document.getElementById("deepAnalysis");
      const luckFlow = document.getElementById("luckFlow");
      const reportContent = document.getElementById("reportContent");
      const todayCoupleLine = document.getElementById("todayCoupleLine");
      const todayCoupleMeta = document.getElementById("todayCoupleMeta");
      const sectionRadarSvg = document.getElementById("sectionRadarSvg");
      const summaryMain = document.getElementById("summaryMain");
      const summarySub = document.getElementById("summarySub");
      const totalScoreEl = document.getElementById("totalScore");
      const summaryPills = document.getElementById("summaryPills");
      const ruleList = document.getElementById("ruleList");
      const monthlyList = document.getElementById("monthlyList");
      const shareBtn = document.getElementById("shareBtn");
      const shareStatus = document.getElementById("shareStatus");
      const pdfBtn = document.getElementById("pdfBtn");
      const aPillarsEl = document.getElementById("aPillars");
      const bPillarsEl = document.getElementById("bPillars");

      const resultTodayCard = document.getElementById("resultTodayCard");
      const resultRadarCard = document.getElementById("resultRadarCard");
      const resultABCard = document.getElementById("resultABCard");
      const resultRulesCard = document.getElementById("resultRulesCard");
      const resultMonthlyCard = document.getElementById("resultMonthlyCard");
      const loadingOverlay = document.getElementById("loadingOverlay");

      /* ======================================================
  1. ìƒíƒœ
====================================================== */
      const INPUT_KEY = "compat:inputs:v2";
      const state = {
        mode: "compat",
        A: null,
        B: null,
        aResult: null,
        bResult: null,
      };

      /* ======================================================
  2. ìœ í‹¸
====================================================== */
      const STEM_ELEM = {
        ê°‘: "ëª©",
        ì„: "ëª©",
        ë³‘: "í™”",
        ì •: "í™”",
        ë¬´: "í† ",
        ê¸°: "í† ",
        ê²½: "ê¸ˆ",
        ì‹ : "ê¸ˆ",
        ì„: "ìˆ˜",
        ê³„: "ìˆ˜",
      };
      const STEM_YINYANG = {
        ê°‘: "ì–‘",
        ì„: "ìŒ",
        ë³‘: "ì–‘",
        ì •: "ìŒ",
        ë¬´: "ì–‘",
        ê¸°: "ìŒ",
        ê²½: "ì–‘",
        ì‹ : "ìŒ",
        ì„: "ì–‘",
        ê³„: "ìŒ",
      };
      const BRANCH_ELEM = {
        ì: "ìˆ˜",
        ì¶•: "í† ",
        ì¸: "ëª©",
        ë¬˜: "ëª©",
        ì§„: "í† ",
        ì‚¬: "í™”",
        ì˜¤: "í™”",
        ë¯¸: "í† ",
        ì‹ : "ê¸ˆ",
        ìœ : "ê¸ˆ",
        ìˆ : "í† ",
        í•´: "ìˆ˜",
      };
      const GENERATE = { ëª©: "í™”", í™”: "í† ", í† : "ê¸ˆ", ê¸ˆ: "ìˆ˜", ìˆ˜: "ëª©" };
      const OVERCOME = { ëª©: "í† ", í™”: "ê¸ˆ", í† : "ìˆ˜", ê¸ˆ: "ëª©", ìˆ˜: "í™”" };
      const CLASH = { ëª©: "ê¸ˆ", ê¸ˆ: "ëª©", í™”: "ìˆ˜", ìˆ˜: "í™”", í† : null };

      const LIUHE = [
        ["ì", "ì¶•"],
        ["ì¸", "í•´"],
        ["ë¬˜", "ìˆ "],
        ["ì§„", "ìœ "],
        ["ì‚¬", "ì‹ "],
        ["ì˜¤", "ë¯¸"],
      ];
      const CHUNG = [
        ["ì", "ì˜¤"],
        ["ì¶•", "ë¯¸"],
        ["ì¸", "ì‹ "],
        ["ë¬˜", "ìœ "],
        ["ì§„", "ìˆ "],
        ["ì‚¬", "í•´"],
      ];
      const HAE = [
        ["ì", "ë¯¸"],
        ["ì¶•", "ì˜¤"],
        ["ì¸", "ì‚¬"],
        ["ë¬˜", "ì§„"],
        ["ì‹ ", "í•´"],
        ["ìœ ", "ìˆ "],
      ];
      const HYEONG = [
        ["ì", "ë¬˜"],
        ["ì¸", "ì‚¬"],
        ["ì‚¬", "ì‹ "],
        ["ì‹ ", "ì¸"],
        ["ì¶•", "ìˆ "],
        ["ìˆ ", "ë¯¸"],
        ["ë¯¸", "ì¶•"],
      ];
      const SAMHAP = [
        ["ì‹ ", "ì", "ì§„"],
        ["í•´", "ë¬˜", "ë¯¸"],
        ["ì¸", "ì˜¤", "ìˆ "],
        ["ì‚¬", "ìœ ", "ì¶•"],
      ];
      const SELF_PUNISH = ["ì", "ì˜¤", "ìœ ", "í•´"];

      const MONTH_FLOW = {
        1: { monthBranch: "ì¶•", seasonTop: "í† " },
        2: { monthBranch: "ì¸", seasonTop: "ëª©" },
        3: { monthBranch: "ë¬˜", seasonTop: "ëª©" },
        4: { monthBranch: "ì§„", seasonTop: "í† " },
        5: { monthBranch: "ì‚¬", seasonTop: "í™”" },
        6: { monthBranch: "ì˜¤", seasonTop: "í™”" },
        7: { monthBranch: "ë¯¸", seasonTop: "í† " },
        8: { monthBranch: "ì‹ ", seasonTop: "ê¸ˆ" },
        9: { monthBranch: "ìœ ", seasonTop: "ê¸ˆ" },
        10: { monthBranch: "ìˆ ", seasonTop: "í† " },
        11: { monthBranch: "í•´", seasonTop: "ìˆ˜" },
        12: { monthBranch: "ì", seasonTop: "ìˆ˜" },
      };

      function hasPair(a, b, table) {
        return table.some(
          ([x, y]) => (a === x && b === y) || (a === y && b === x)
        );
      }
      function isLiuhe(a, b) {
        return hasPair(a, b, LIUHE);
      }
      function isChung(a, b) {
        return hasPair(a, b, CHUNG);
      }
      function isHae(a, b) {
        return hasPair(a, b, HAE);
      }
      function isSamhap(a, b) {
        return SAMHAP.some((g) => g.includes(a) && g.includes(b));
      }
      function isSelfPunish(b) {
        return SELF_PUNISH.includes(b);
      }
      function isSeasonClash(seasonElem, topElem) {
        return CLASH[seasonElem] === topElem;
      }
      function relationElem(a, b) {
        if (GENERATE[a] === b) return "ìƒ";
        if (OVERCOME[a] === b) return "ê·¹";
        if (GENERATE[b] === a) return "ë°›ìŒ";
        if (OVERCOME[b] === a) return "ëˆŒë¦¼";
        if (a === b) return "ë™";
        return "ì¤‘ë¦½";
      }
      function scoreAtLeast(value, min, span) {
        if (value <= min) return 0;
        if (value >= min + span) return 1;
        return (value - min) / span;
      }
      function scoreAtMost(value, max, span) {
        if (value >= max) return 0;
        if (value <= max - span) return 1;
        return (max - value) / span;
      }
      function elemFromIdSuffix(suffix) {
        const map = {
          MOK: "ëª©",
          HWA: "í™”",
          TO: "í† ",
          GEUM: "ê¸ˆ",
          SU: "ìˆ˜",
        };
        return map[suffix] || "";
      }
      function getRuleActivationScore(rule, a, b) {
        const id = rule.id || "";
        if (id === "ELEM_TOP_SAME") {
          if (a.topElem !== b.topElem) return 0;
          return scoreAtLeast(Math.min(a.topScore, b.topScore), 1.2, 0.4);
        }
        if (id === "ELEM_TOP_COMPLEMENT") {
          if (
            !(
              GENERATE[a.topElem] === b.topElem ||
              GENERATE[b.topElem] === a.topElem
            )
          )
            return 0;
          return scoreAtLeast(Math.min(a.topScore, b.topScore), 1.1, 0.4);
        }
        if (id === "ELEM_TOP_CLASH") {
          if (
            !(
              OVERCOME[a.topElem] === b.topElem ||
              OVERCOME[b.topElem] === a.topElem
            )
          )
            return 0;
          return scoreAtLeast(Math.min(a.topScore, b.topScore), 1.0, 0.5);
        }
        if (id === "ELEM_WEAK_SAME") {
          if (a.weakElem !== b.weakElem) return 0;
          return scoreAtMost(Math.max(a.weakScore, b.weakScore), 0.7, 0.4);
        }
        if (id === "ELEM_WEAK_COMPLEMENT") {
          if (!(a.weakElem === b.topElem || b.weakElem === a.topElem)) return 0;
          const topScore = Math.max(a.topScore, b.topScore);
          const weakScore = Math.min(a.weakScore, b.weakScore);
          return Math.min(
            scoreAtLeast(topScore, 1.0, 0.5),
            scoreAtMost(weakScore, 0.9, 0.5)
          );
        }
        if (id === "BALANCE_SIMILAR") {
          const diff = Math.abs(a.balance - b.balance);
          return scoreAtMost(diff, 0.15, 0.35);
        }
        if (id === "BALANCE_DIFF") {
          const diff = Math.abs(a.balance - b.balance);
          return scoreAtLeast(diff, 0.45, 0.35);
        }
        if (id === "BALANCE_BOTH_STABLE") {
          return scoreAtMost(Math.max(a.balance, b.balance), 0.25, 0.2);
        }
        if (id === "BALANCE_BOTH_SPIKY") {
          return scoreAtLeast(Math.min(a.balance, b.balance), 0.6, 0.2);
        }
        if (id === "A_DOMINANT") {
          const diff = a.balance - b.balance;
          return scoreAtLeast(diff, 0.25, 0.2);
        }
        if (id === "B_DOMINANT") {
          const diff = b.balance - a.balance;
          return scoreAtLeast(diff, 0.25, 0.2);
        }
        if (id === "SEASON_SUPPORT") {
          return rule.when(a, b) ? 1 : 0;
        }
        if (id === "SEASON_CLASH") {
          return rule.when(a, b) ? 1 : 0;
        }
        if (id === "SEASON_SAME") {
          return rule.when(a, b) ? 1 : 0;
        }
        if (id.startsWith("BOTH_STRONG_")) {
          const elem = elemFromIdSuffix(id.replace("BOTH_STRONG_", ""));
          return scoreAtLeast(
            Math.min(a.elements[elem], b.elements[elem]),
            1.4,
            0.4
          );
        }
        if (id.startsWith("BOTH_WEAK_")) {
          const elem = elemFromIdSuffix(id.replace("BOTH_WEAK_", ""));
          return scoreAtMost(
            Math.max(a.elements[elem], b.elements[elem]),
            0.7,
            0.4
          );
        }
        if (id.startsWith("A_STRONG_")) {
          const elem = elemFromIdSuffix(id.replace("A_STRONG_", ""));
          const strong = scoreAtLeast(a.elements[elem], 1.5, 0.4);
          const weak = scoreAtMost(b.elements[elem], 0.8, 0.4);
          return Math.min(strong, weak);
        }
        if (id.startsWith("B_STRONG_")) {
          const elem = elemFromIdSuffix(id.replace("B_STRONG_", ""));
          const strong = scoreAtLeast(b.elements[elem], 1.5, 0.4);
          const weak = scoreAtMost(a.elements[elem], 0.8, 0.4);
          return Math.min(strong, weak);
        }
        return rule.when(a, b) ? 1 : 0;
      }
      function tenGod(dayStem, targetStem) {
        if (!dayStem || !targetStem) return "";
        const dayElem = STEM_ELEM[dayStem];
        const targetElem = STEM_ELEM[targetStem];
        const dayYinYang = STEM_YINYANG[dayStem];
        const targetYinYang = STEM_YINYANG[targetStem];
        if (!dayElem || !targetElem) return "";

        const samePolarity = dayYinYang === targetYinYang;
        if (dayElem === targetElem) {
          return samePolarity ? "ë¹„ê²¬" : "ê²ì¬";
        }
        if (GENERATE[dayElem] === targetElem) {
          return samePolarity ? "ì‹ì‹ " : "ìƒê´€";
        }
        if (GENERATE[targetElem] === dayElem) {
          return samePolarity ? "ì •ì¸" : "í¸ì¸";
        }
        if (OVERCOME[dayElem] === targetElem) {
          return samePolarity ? "í¸ì¬" : "ì •ì¬";
        }
        if (OVERCOME[targetElem] === dayElem) {
          return samePolarity ? "í¸ê´€" : "ì •ê´€";
        }
        return "";
      }
      function getTopWeak(elementsRaw) {
        const entries = Object.entries(elementsRaw).sort((a, b) => b[1] - a[1]);
        return { top: entries[0][0], weak: entries[entries.length - 1][0] };
      }
      function calcBalance(elementsRaw) {
        const vals = Object.values(elementsRaw);
        const max = Math.max(...vals);
        const min = Math.min(...vals);
        return max ? (max - min) / max : 0;
      }
      function combineElements(a, b) {
        const keys = Object.keys(a);
        const out = {};
        keys.forEach((k) => {
          out[k] = (a[k] + b[k]) / 2;
        });
        return out;
      }
      function combineBreakdown(a, b) {
        if (!a || !b) return null;
        const keys = ["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"];
        const merge = (x, y) =>
          keys.reduce((acc, k) => {
            acc[k] = ((x?.[k] || 0) + (y?.[k] || 0)) / 2;
            return acc;
          }, {});
        return {
          stems: merge(a.stems, b.stems),
          branches: merge(a.branches, b.branches),
          hidden: merge(a.hidden, b.hidden),
          season: merge(a.season, b.season),
        };
      }
      function round1(x) {
        return Math.round(x * 10) / 10;
      }
      function clamp01(x) {
        return Math.max(0, Math.min(1, x));
      }
      function parseTzOffsetMinutes(v, fallback = 540) {
        const num = Number(v);
        if (!Number.isFinite(num)) return fallback;
        return Math.round(num * 60);
      }
      function hashToIndex(str, mod) {
        let h = 2166136261;
        for (let i = 0; i < str.length; i++) {
          h ^= str.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        h >>>= 0;
        return mod ? h % mod : 0;
      }
      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
      function softenText(text) {
        if (!text) return text;
        return String(text)
          .replaceAll("ì†í•´", "ë¶€ë‹´")
          .replaceAll("ì†ì‹¤", "ë¶€ë‹´")
          .replaceAll("ë‚­íŒ¨", "ì•„ì‰¬ì›€")
          .replaceAll("ìœ„ê¸°", "ë³€í™”")
          .replaceAll("ê²½ê³„", "ìœ ì˜")
          .replaceAll("ì£¼ì˜", "ìœ ì˜")
          .replaceAll("ì¡°ì‹¬", "ìœ ì˜")
          .replaceAll("ë¬´ë¦¬", "ê³¼í•˜ê²Œ")
          .replaceAll("ì¶©ëŒ", "ë§ˆì°°")
          .replaceAll("ë¶€ë”ªí˜", "ì—‡ê°ˆë¦¼")
          .replaceAll("ì‹¤ìˆ˜", "ì‘ì€ ì•„ì‰¬ì›€")
          .replaceAll("ë¶ˆì•ˆ", "ì¡°ì‹¬ìŠ¤ëŸ¬ì›€")
          .replaceAll("ê·¼ì‹¬", "ê±±ì •")
          .replaceAll("ë¬¸ì œ", "ê³¼ì œ");
      }
      function casualizeText(text) {
        if (!text) return text;
        return softenText(
          String(text)
            .replace(/ì…ë‹ˆë‹¤\./g, "ì´ì•¼.")
            .replace(/ë©ë‹ˆë‹¤\./g, "ë¼.")
            .replace(/í•©ë‹ˆë‹¤\./g, "í•´.")
            .replace(/í•˜ì‹­ì‹œì˜¤\./g, "í•´.")
            .replace(/í•˜ì„¸ìš”\./g, "í•´.")
            .replace(/í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤\./g, "í•´.")
            .replace(/í•´ì•¼ í•©ë‹ˆë‹¤\./g, "í•´ì•¼ í•´.")
            .replace(/ë°”ëë‹ˆë‹¤\./g, "ë°”ë˜.")
            .replace(/ì…ë‹ˆë‹¤/g, "ì´ì•¼")
            .replace(/í•©ë‹ˆë‹¤/g, "í•´")
        );
      }
      function fillTokens(text, tokens) {
        return text.replace(/\{([^}]+)\}/g, (_, key) => tokens[key] ?? "");
      }
      function hourBranchToTime(branch) {
        const map = {
          ì: "00:45",
          ì¶•: "02:30",
          ì¸: "04:30",
          ë¬˜: "06:30",
          ì§„: "08:30",
          ì‚¬: "10:30",
          ì˜¤: "12:30",
          ë¯¸: "14:30",
          ì‹ : "16:30",
          ìœ : "18:30",
          ìˆ : "20:30",
          í•´: "22:30",
        };
        return map[branch] || "00:30";
      }
      function makeBoundaryText() {
        return "";
      }

      /* ======================================================
  3. ì¼ì§„(ì˜¤ëŠ˜ ìš´ì„¸)
====================================================== */
      const STEMS = [
        "ê°‘",
        "ì„",
        "ë³‘",
        "ì •",
        "ë¬´",
        "ê¸°",
        "ê²½",
        "ì‹ ",
        "ì„",
        "ê³„",
      ];
      const BRANCHES = [
        "ì",
        "ì¶•",
        "ì¸",
        "ë¬˜",
        "ì§„",
        "ì‚¬",
        "ì˜¤",
        "ë¯¸",
        "ì‹ ",
        "ìœ ",
        "ìˆ ",
        "í•´",
      ];
      const GANJI_60 = (() => {
        const arr = [];
        for (let i = 0; i < 60; i++) {
          arr.push({ stem: STEMS[i % 10], branch: BRANCHES[i % 12] });
        }
        return arr;
      })();
      const DAY_PILLAR_OFFSET = 2;

      const BASE_GAPJA_DAY = new Date("1984-02-02T00:00:00+09:00");
      const KOREA_DST = [
        {
          start: "1988-05-08T00:00:00+09:00",
          end: "1988-10-09T23:59:59+09:00",
          offsetHours: 1,
        },
      ];

      function applyDST(dateKST) {
        const t = dateKST.getTime();
        for (const d of KOREA_DST) {
          const s = new Date(d.start).getTime();
          const e = new Date(d.end).getTime();
          if (t >= s && t <= e) {
            return new Date(t + d.offsetHours * 3600 * 1000);
          }
        }
        return dateKST;
      }

      function getTodayGanji(date = new Date()) {
        const kst = new Date(
          date.toLocaleString("en-US", { timeZone: "Asia/Seoul" })
        );
        const adj = applyDST(kst);
        const days = Math.floor((adj - BASE_GAPJA_DAY) / (24 * 3600 * 1000));
        const idx = (((days + DAY_PILLAR_OFFSET) % 60) + 60) % 60;
        return { index: idx, ...GANJI_60[idx] };
      }

      function getTodayElementFlow(date = new Date()) {
        const g = getTodayGanji(date);
        return {
          ganji: g,
          stemElem: STEM_ELEM[g.stem],
          branchElem: BRANCH_ELEM[g.branch],
        };
      }

      function todayAdvantage(aPerson, bPerson, date = new Date()) {
        const flow = getTodayElementFlow(date);
        const key1 = flow.stemElem;
        const key2 = flow.branchElem;
        const scoreA =
          aPerson.elements[key1] * 1.0 + aPerson.elements[key2] * 0.7;
        const scoreB =
          bPerson.elements[key1] * 1.0 + bPerson.elements[key2] * 0.7;
        const diff = scoreA - scoreB;
        const TH = 0.35;

        let winner = "even";
        if (diff > TH) winner = "A";
        else if (diff < -TH) winner = "B";

        const line = makeTodayCoupleLine(winner, key1, key2);
        return {
          winner,
          keys: [key1, key2],
          scoreA: round1(scoreA),
          scoreB: round1(scoreB),
          line,
        };
      }

      function makeTodayCoupleLine(winner, k1, k2) {
        if (winner === "A") {
          return `ì˜¤ëŠ˜ íë¦„ì€ ${k1}/${k2} ìª½ì´ ê°•í•´ì„œ, Aê°€ ì¡°ê¸ˆ ë” ìœ ë¦¬í•´. ì¤‘ìš”í•œ ì–˜ê¸°ëŠ” Aê°€ ë¨¼ì € êº¼ë‚´ë©´ ì¢‹ì•„.`;
        }
        if (winner === "B") {
          return `ì˜¤ëŠ˜ íë¦„ì€ ${k1}/${k2} ìª½ì´ ê°•í•´ì„œ, Bê°€ ì¡°ê¸ˆ ë” ìœ ë¦¬í•´. ì•½ì†/ê²°ì •ì€ B ì»¨ë””ì…˜ì— ë§ì¶”ë©´ ë¶€ë“œëŸ½ê²Œ ê°„ë‹¤.`;
        }
        return `ì˜¤ëŠ˜ì€ ${k1}/${k2} íë¦„ì¸ë°, A/B ë‘˜ ë‹¤ ë¹„ìŠ·í•˜ê²Œ ë°›ëŠ”ë‹¤. ë§ì¶°ê°€ëŠ” ê²Œ ì´ë“ì´ì•¼.`;
      }

      function todayLuckLine(person) {
        const flow = getTodayElementFlow();
        const myTop = person.topElem;
        const myWeak = person.weakElem;
        const relTop = relationElem(flow.stemElem, myTop);
        const relWeak = relationElem(flow.stemElem, myWeak);
        let mainText = "";
        let detailText = "";
        let tipText = "";

        if (
          relTop === "ìƒ" ||
          relTop === "ë™" ||
          myTop === flow.stemElem ||
          myTop === flow.branchElem
        ) {
          mainText =
            "ì˜¤ëŠ˜ì€ ë„¤ ê¸°ìš´ì´ ì˜ ë°›ì³ì£¼ëŠ” ë‚ ì´ì•¼. ì¤‘ìš”í•œ ì¼ì€ ì˜¤ëŠ˜ ì²˜ë¦¬í•˜ë©´ ì¢‹ì•„.";
          detailText = `ì˜¤ëŠ˜ì˜ ì˜¤í–‰(${flow.stemElem}/${flow.branchElem})ì´ ë„¤ ê°•ì (${myTop})ê³¼ ì˜ ë§ì•„ì„œ ì¶”ì§„ë ¥ì´ ë¶™ëŠ” ë‚ ì´ì•¼. ê²°ì •ì„ ë‚´ë¦¬ê±°ë‚˜ ì¤‘ìš”í•œ ì¼ì„ ì‹œì‘í•˜ê¸°ì— ì¢‹ì€ íƒ€ì´ë°ì´ì•¼. ì—¬ìœ  ìˆê²Œ ì›€ì§ì´ë©´ ì¢‹ì€ ê²°ê³¼ê°€ ë”°ë¼ì˜¬ ê±°ì•¼.`;
          tipText = `ğŸ’¡ íŒ: ì˜¤ëŠ˜ì€ ${myTop} ê¸°ìš´ì„ í™œìš©í•˜ëŠ” ì¼ì„ ìš°ì„ ìˆœìœ„ë¡œ ì¡ì•„. í° ê²°ì •ì´ë‚˜ ì¤‘ìš”í•œ ì•½ì†ì„ ì¡ê¸°ì— ì¢‹ì€ ë‚ ì´ì•¼.`;
        } else if (relTop === "ê·¹" || relTop === "ëˆŒë¦¼") {
          mainText =
            "ì˜¤ëŠ˜ì€ ì†ë„ë¥¼ ì¡°ê¸ˆ ì¤„ì´ë©´ ë” í¸ì•ˆí•´ì ¸. í™•ì¸ì„ ë¨¼ì € í•˜ë©´ íë¦„ì´ ì¢‹ì•„.";
          detailText = `ì˜¤ëŠ˜ì˜ ì˜¤í–‰(${flow.stemElem}/${flow.branchElem})ì´ ë„¤ ê°•ì (${myTop})ê³¼ ë§ˆì°°ì´ ìˆì„ ìˆ˜ ìˆì–´. ì„œë‘ë¥´ê¸°ë³´ë‹¤ í•œ ê±¸ìŒ ì—¬ìœ ë¥¼ ë‘ê³  íë¦„ì„ ì‚´í”¼ëŠ” ê²Œ ì¢‹ì•„. í° ê²°ì •ì€ ì ì‹œ ë³´ë¥˜í•˜ê³ , ì •ë¦¬ì™€ í™•ì¸ì— ì§‘ì¤‘í•˜ë©´ ë” ì•ˆì •ì ì´ì•¼.`;
          tipText = `ğŸ’¡ íŒ: ì˜¤ëŠ˜ì€ ${myWeak} ë³´ì™„ì— ì§‘ì¤‘í•´. ì¤‘ìš”í•œ ê²°ì •ì€ ì°¨ë¶„íˆ ì ê²€í•˜ê³ , ê¸°ì¡´ ì¼ì„ ì •ë¦¬í•˜ëŠ” ë° ì‹œê°„ì„ ì¨.`;
        } else {
          mainText = "ì˜¤ëŠ˜ì€ í‰ì˜¨í•œ í•˜ë£¨ì•¼. ê¸°ë³¸ë§Œ ì§€ì¼œë„ ì¶©ë¶„í•´.";
          detailText = `ì˜¤ëŠ˜ì˜ ì˜¤í–‰(${flow.stemElem}/${flow.branchElem})ì´ ë„¤ ê¸°ìš´ê³¼ ì¤‘ë¦½ì ì¸ ê´€ê³„ë¼ í° ë³€í™”ë³´ë‹¤ëŠ” ì•ˆì •ì ì¸ íë¦„ì´ì•¼. ì—¬ìœ  ìˆê²Œ ë£¨í‹´ì„ ì§€í‚¤ë©´ì„œ ì‘ì€ ê°œì„ ì„ í•˜ëŠ” ê²Œ ì¢‹ì•„.`;
          tipText = `ğŸ’¡ íŒ: ì˜¤ëŠ˜ì€ ìˆ˜ë©´/ì‹ì‚¬/ì •ë¦¬ ê°™ì€ ê¸°ë³¸ ë£¨í‹´ì„ ì˜ ì§€í‚¤ëŠ” ê²Œ í¬ì¸íŠ¸ì•¼. ì‘ì€ ê°œì„ ì— ì§‘ì¤‘í•˜ë©´ ë” ì¢‹ì€ í•˜ë£¨ê°€ ë¼.`;
        }

        return {
          main: softenText(mainText),
          detail: softenText(detailText),
          tip: softenText(tipText),
          todayElem: `${flow.stemElem}/${flow.branchElem}`,
        };
      }

      function renderTodayCoupleBox(aPerson, bPerson) {
        const t = todayAdvantage(aPerson, bPerson);
        todayCoupleLine.textContent = t.line;
        todayCoupleMeta.textContent = `A ${t.scoreA} vs B ${
          t.scoreB
        } (ì˜¤ëŠ˜ ì˜¤í–‰: ${t.keys.join("/")})`;
      }

      /* ======================================================
  4. ì‚¬ì£¼ ê³„ì‚° (ì •ë°€ ì ˆê¸° ê¸°ë°˜)
====================================================== */
      const STEMS_H = [
        "ê°‘",
        "ì„",
        "ë³‘",
        "ì •",
        "ë¬´",
        "ê¸°",
        "ê²½",
        "ì‹ ",
        "ì„",
        "ê³„",
      ];
      const BRANCHES_H = [
        "ì",
        "ì¶•",
        "ì¸",
        "ë¬˜",
        "ì§„",
        "ì‚¬",
        "ì˜¤",
        "ë¯¸",
        "ì‹ ",
        "ìœ ",
        "ìˆ ",
        "í•´",
      ];

      const BRANCH_MAIN_ELEM = {
        ì: "ìˆ˜",
        ì¶•: "í† ",
        ì¸: "ëª©",
        ë¬˜: "ëª©",
        ì§„: "í† ",
        ì‚¬: "í™”",
        ì˜¤: "í™”",
        ë¯¸: "í† ",
        ì‹ : "ê¸ˆ",
        ìœ : "ê¸ˆ",
        ìˆ : "í† ",
        í•´: "ìˆ˜",
      };

      const HIDDEN_STEMS = {
        ì: [["ê³„", 1.0]],
        ì¶•: [
          ["ê¸°", 0.6],
          ["ê³„", 0.2],
          ["ì‹ ", 0.2],
        ],
        ì¸: [
          ["ê°‘", 0.6],
          ["ë³‘", 0.2],
          ["ë¬´", 0.2],
        ],
        ë¬˜: [["ì„", 1.0]],
        ì§„: [
          ["ë¬´", 0.6],
          ["ì„", 0.2],
          ["ê³„", 0.2],
        ],
        ì‚¬: [
          ["ë³‘", 0.6],
          ["ê²½", 0.2],
          ["ë¬´", 0.2],
        ],
        ì˜¤: [
          ["ì •", 0.7],
          ["ê¸°", 0.3],
        ],
        ë¯¸: [
          ["ê¸°", 0.6],
          ["ì •", 0.2],
          ["ì„", 0.2],
        ],
        ì‹ : [
          ["ê²½", 0.6],
          ["ì„", 0.2],
          ["ë¬´", 0.2],
        ],
        ìœ : [["ì‹ ", 1.0]],
        ìˆ : [
          ["ë¬´", 0.6],
          ["ì‹ ", 0.2],
          ["ì •", 0.2],
        ],
        í•´: [
          ["ì„", 0.7],
          ["ê°‘", 0.3],
        ],
      };

      const MONTH_BOUNDARIES = [
        { name: "ì…ì¶˜", lon: 315, branch: "ì¸" },
        { name: "ê²½ì¹©", lon: 345, branch: "ë¬˜" },
        { name: "ì²­ëª…", lon: 15, branch: "ì§„" },
        { name: "ì…í•˜", lon: 45, branch: "ì‚¬" },
        { name: "ë§ì¢…", lon: 75, branch: "ì˜¤" },
        { name: "ì†Œì„œ", lon: 105, branch: "ë¯¸" },
        { name: "ì…ì¶”", lon: 135, branch: "ì‹ " },
        { name: "ë°±ë¡œ", lon: 165, branch: "ìœ " },
        { name: "í•œë¡œ", lon: 195, branch: "ìˆ " },
        { name: "ì…ë™", lon: 225, branch: "í•´" },
        { name: "ëŒ€ì„¤", lon: 255, branch: "ì" },
        { name: "ì†Œí•œ", lon: 285, branch: "ì¶•" },
      ];

      function sunApparentEclipticLongitudeDeg(jd) {
        const T = (jd - 2451545.0) / 36525.0;
        let L0 = 280.46646 + 36000.76983 * T + 0.0003032 * T * T;
        L0 = normalizeDeg(L0);
        let M = 357.52911 + 35999.05029 * T - 0.0001537 * T * T;
        M = normalizeDeg(M);
        const Mr = deg2rad(M);
        const C =
          (1.914602 - 0.004817 * T - 0.000014 * T * T) * Math.sin(Mr) +
          (0.019993 - 0.000101 * T) * Math.sin(2 * Mr) +
          0.000289 * Math.sin(3 * Mr);
        let trueLon = L0 + C;
        const omega = deg2rad(125.04 - 1934.136 * T);
        let lambda = trueLon - 0.00569 - 0.00478 * Math.sin(omega);
        return normalizeDeg(lambda);
      }

      function findSolarLongitudeTimeUTC(year, targetLonDeg) {
        const approx = approximateDateForLon(year, targetLonDeg);
        let t0 = approx.getTime() - 3 * 86400e3;
        let t1 = approx.getTime() + 3 * 86400e3;

        const f = (t) => {
          const jd = toJulianDay(new Date(t));
          const lon = sunApparentEclipticLongitudeDeg(jd);
          return shortestAngleDiffDeg(lon, targetLonDeg);
        };

        let a = t0,
          b = t1;
        let fa = f(a),
          fb = f(b);
        let tries = 0;
        while (fa * fb > 0 && tries < 12) {
          a -= 2 * 86400e3;
          b += 2 * 86400e3;
          fa = f(a);
          fb = f(b);
          tries++;
        }
        if (fa * fb > 0) {
          return new Date(approx.getTime());
        }

        for (let i = 0; i < 60; i++) {
          const m = (a + b) / 2;
          const fm = f(m);
          if (Math.abs(fm) < 1e-6) {
            a = b = m;
            break;
          }
          if (fa * fm <= 0) {
            b = m;
            fb = fm;
          } else {
            a = m;
            fa = fm;
          }
        }
        return new Date((a + b) / 2);
      }

      function approximateDateForLon(year, lon) {
        const map = {
          315: [2, 4],
          345: [3, 6],
          15: [4, 5],
          45: [5, 6],
          75: [6, 6],
          105: [7, 7],
          135: [8, 7],
          165: [9, 7],
          195: [10, 8],
          225: [11, 7],
          255: [12, 7],
          285: [1, 6],
        };
        const [mm, dd] = map[lon] || [2, 4];
        return new Date(Date.UTC(year, mm - 1, dd, 12, 0, 0));
      }

      function computeMonthBoundaryTimesUTC(year) {
        return MONTH_BOUNDARIES.map((b) => ({
          ...b,
          timeUTC: findSolarLongitudeTimeUTC(year, b.lon),
        }));
      }

      function computeSajuFiveElements(
        birthUTCDate,
        {
          ziMode,
          hiddenMode,
          tzOffsetMinutes,
          dstMode,
          includeHour,
          hourBranchOverride,
        }
      ) {
        const birthLocal = toLocalDateParts(
          birthUTCDate,
          tzOffsetMinutes,
          dstMode
        );
        const year = birthLocal.y;
        const boundariesThisYearUTC = computeMonthBoundaryTimesUTC(year);
        const boundariesPrevYearUTC = computeMonthBoundaryTimesUTC(year - 1);

        const ipchunThisLocal = toLocalMillis(
          boundariesThisYearUTC[0].timeUTC,
          tzOffsetMinutes,
          dstMode
        );
        const birthMillisLocal = localMillisFromParts(birthLocal);

        const sajuYear = birthMillisLocal >= ipchunThisLocal ? year : year - 1;
        const bdsUTC =
          sajuYear === year ? boundariesThisYearUTC : boundariesPrevYearUTC;
        const bdsLocal = bdsUTC.map((x) => ({
          ...x,
          local: toLocalMillis(x.timeUTC, tzOffsetMinutes, dstMode),
        }));

        let monthBranch = "ì¸";
        let monthStartName = "ì…ì¶˜";
        let monthStartLocal = bdsLocal[0].local;
        // ë‹¤ìŒ í•´ ì…ì¶˜ ì‹œê°„ì„ ë¯¸ë¦¬ ê³„ì‚° (ì„±ëŠ¥ ìµœì í™”)
        const nextYearBoundaries = computeMonthBoundaryTimesUTC(sajuYear + 1);
        const nextYearIpchunLocal = toLocalMillis(
          nextYearBoundaries[0].timeUTC,
          tzOffsetMinutes,
          dstMode
        );
        for (let i = 0; i < bdsLocal.length; i++) {
          const cur = bdsLocal[i];
          const next = bdsLocal[(i + 1) % bdsLocal.length];
          const nextLocal =
            i === bdsLocal.length - 1 ? nextYearIpchunLocal : next.local;

          if (birthMillisLocal >= cur.local && birthMillisLocal < nextLocal) {
            monthBranch = cur.branch;
            monthStartName = cur.name;
            monthStartLocal = cur.local;
            break;
          }
          if (i === bdsLocal.length - 1 && birthMillisLocal >= cur.local) {
            monthBranch = cur.branch;
            monthStartName = cur.name;
            monthStartLocal = cur.local;
          }
          if (
            i === bdsLocal.length - 1 &&
            birthMillisLocal < bdsLocal[0].local
          ) {
            monthBranch = "ì¶•";
            monthStartName = "ì†Œí•œ";
            monthStartLocal = cur.local;
          }
        }

        const yearPillar = ganzhiYear(sajuYear);
        const monthPillar = ganzhiMonth(yearPillar.stem, monthBranch);
        const adjustedForDay = adjustForZiDayBoundary(birthLocal, ziMode);
        const dayPillar = ganzhiDayFromGregorian(
          adjustedForDay.y,
          adjustedForDay.m,
          adjustedForDay.d
        );
        const hourBranch =
          hourBranchOverride ||
          getHourBranch(birthLocal.hh, birthLocal.mm, ziMode);
        const hourPillar = includeHour
          ? ganzhiHour(dayPillar.stem, hourBranch)
          : null;

        const elements = tallyElements(
          { yearPillar, monthPillar, dayPillar, hourPillar },
          { hiddenMode, includeHour, monthBranch }
        );

        return {
          input: {
            local: `${pad2(birthLocal.y)}-${pad2(birthLocal.m)}-${pad2(
              birthLocal.d
            )} ${pad2(birthLocal.hh)}:${pad2(birthLocal.mm)}`,
            ziMode,
            hiddenMode,
            tzOffsetMinutes,
            dstMode,
            includeHour,
            hourBranch,
            sajuYear,
            monthStartName,
          },
          pillars: {
            year: yearPillar,
            month: monthPillar,
            day: dayPillar,
            hour: hourPillar,
            monthMeta: {
              start: new Date(monthStartLocal).toISOString(),
              startName: monthStartName,
            },
          },
          elements,
        };
      }

      function ganzhiYear(year) {
        const baseYear = 1984;
        const idx = mod(year - baseYear, 60);
        return ganzhiFromIndex(idx);
      }

      function ganzhiMonth(yearStem, monthBranch) {
        const startStemByYearStem = {
          ê°‘: "ë³‘",
          ê¸°: "ë³‘",
          ì„: "ë¬´",
          ê²½: "ë¬´",
          ë³‘: "ê²½",
          ì‹ : "ê²½",
          ì •: "ì„",
          ì„: "ì„",
          ë¬´: "ê°‘",
          ê³„: "ê°‘",
        };
        const startStem = startStemByYearStem[yearStem] || "ë³‘";
        const order = [
          "ì¸",
          "ë¬˜",
          "ì§„",
          "ì‚¬",
          "ì˜¤",
          "ë¯¸",
          "ì‹ ",
          "ìœ ",
          "ìˆ ",
          "í•´",
          "ì",
          "ì¶•",
        ];
        const mIdx = order.indexOf(monthBranch);
        const stemIdx = (STEMS_H.indexOf(startStem) + mIdx) % 10;
        return {
          stem: STEMS_H[stemIdx],
          branch: monthBranch,
          text: `${STEMS_H[stemIdx]}${monthBranch}`,
        };
      }

      function ganzhiDayFromGregorian(y, m, d) {
        const jd = toJulianDayFromGregorian(y, m, d, 12, 0, 0);
        const jdJiaZi = toJulianDayFromGregorian(1984, 2, 2, 12, 0, 0);
        const idx = mod(Math.round(jd - jdJiaZi) + DAY_PILLAR_OFFSET, 60);
        return ganzhiFromIndex(idx);
      }

      function ganzhiHour(dayStem, hourBranch) {
        const startStemByDayStem = {
          ê°‘: "ê°‘",
          ê¸°: "ê°‘",
          ì„: "ë³‘",
          ê²½: "ë³‘",
          ë³‘: "ë¬´",
          ì‹ : "ë¬´",
          ì •: "ê²½",
          ì„: "ê²½",
          ë¬´: "ì„",
          ê³„: "ì„",
        };
        const startStem = startStemByDayStem[dayStem] || "ê°‘";
        const order = [
          "ì",
          "ì¶•",
          "ì¸",
          "ë¬˜",
          "ì§„",
          "ì‚¬",
          "ì˜¤",
          "ë¯¸",
          "ì‹ ",
          "ìœ ",
          "ìˆ ",
          "í•´",
        ];
        const hIdx = order.indexOf(hourBranch);
        const stemIdx = (STEMS_H.indexOf(startStem) + hIdx) % 10;
        return {
          stem: STEMS_H[stemIdx],
          branch: hourBranch,
          text: `${STEMS_H[stemIdx]}${hourBranch}`,
        };
      }

      function ganzhiFromIndex(idx) {
        const stem = STEMS_H[idx % 10];
        const branch = BRANCHES_H[idx % 12];
        return { stem, branch, text: `${stem}${branch}` };
      }

      function getHourBranch(hh, mm, ziMode) {
        const minutes = hh * 60 + mm;
        const ziStart = ziMode === "2330" ? 23 * 60 + 30 : 23 * 60;
        if (minutes >= ziStart || minutes < (ziMode === "2330" ? 90 : 60)) {
          return "ì";
        }
        const base = ziMode === "2330" ? 90 : 60;
        const order = [
          "ì¶•",
          "ì¸",
          "ë¬˜",
          "ì§„",
          "ì‚¬",
          "ì˜¤",
          "ë¯¸",
          "ì‹ ",
          "ìœ ",
          "ìˆ ",
          "í•´",
        ];
        const delta = minutes - base;
        const idx = Math.floor(delta / 120);
        return order[Math.max(0, Math.min(order.length - 1, idx))] || "ì¶•";
      }

      function adjustForZiDayBoundary(kstParts, ziMode) {
        if (ziMode !== "2330") return kstParts;
        const minutes = kstParts.hh * 60 + kstParts.mm;
        if (minutes < 23 * 60 + 30) return kstParts;
        const dt = new Date(
          Date.UTC(kstParts.y, kstParts.m - 1, kstParts.d, 12, 0, 0)
        );
        dt.setUTCDate(dt.getUTCDate() + 1);
        return {
          y: dt.getUTCFullYear(),
          m: dt.getUTCMonth() + 1,
          d: dt.getUTCDate(),
          hh: kstParts.hh,
          mm: kstParts.mm,
        };
      }

      function tallyElements(
        pillars,
        { hiddenMode, includeHour, monthBranch }
      ) {
        const base = { ëª©: 0, í™”: 0, í† : 0, ê¸ˆ: 0, ìˆ˜: 0 };
        const breakdown = {
          stems: { ëª©: 0, í™”: 0, í† : 0, ê¸ˆ: 0, ìˆ˜: 0 },
          branches: { ëª©: 0, í™”: 0, í† : 0, ê¸ˆ: 0, ìˆ˜: 0 },
          hidden: { ëª©: 0, í™”: 0, í† : 0, ê¸ˆ: 0, ìˆ˜: 0 },
          season: { ëª©: 0, í™”: 0, í† : 0, ê¸ˆ: 0, ìˆ˜: 0 },
        };
        const STEM_W = [11.1502, 13.0304, 1.819, 12.9905];
        const BRANCH_W = [8.7249, -6.8992, 3.6292, -10.7041];
        const HIDDEN_W = [13.532, 42.0389, 22.9665, 38.2401];
        const addElem = (target, elem, w = 1) => {
          target[elem] = (target[elem] || 0) + w;
          base[elem] = (base[elem] || 0) + w;
        };
        const list = [
          pillars.yearPillar,
          pillars.monthPillar,
          pillars.dayPillar,
        ];
        list.push(
          includeHour && pillars.hourPillar ? pillars.hourPillar : null
        );

        list.forEach((p, i) => {
          if (!p) return;
          const stemElem = STEM_ELEM[p.stem];
          const branchElem = BRANCH_MAIN_ELEM[p.branch];
          if (!stemElem || !branchElem) {
            console.warn("Invalid pillar:", p);
            return;
          }
          addElem(breakdown.stems, stemElem, STEM_W[i]);
          addElem(breakdown.branches, branchElem, BRANCH_W[i]);
        });
        if (hiddenMode === "on") {
          list.forEach((p, i) => {
            if (!p) return;
            const arr = HIDDEN_STEMS[p.branch] || [];
            arr.forEach(([hs, w]) => {
              const elem = STEM_ELEM[hs];
              if (elem) {
                addElem(breakdown.hidden, elem, w * HIDDEN_W[i]);
              }
            });
          });
        }
        const total = Object.values(base).reduce((a, b) => a + b, 0) || 1;
        const scale = 150 / total;
        Object.keys(base).forEach((k) => {
          base[k] = Math.round(base[k] * scale);
        });

        const key = `${pillars.yearPillar.text}|${pillars.monthPillar.text}|${
          pillars.dayPillar.text
        }|${pillars.hourPillar ? pillars.hourPillar.text : "â€”"}`;
        const anchor = { key, applied: false };
        const SHINTO_ANCHORS = {
          "ë³‘ì¸|ê³„ì‚¬|ë³‘ì|ë¬´ì": { ëª©: 16, í™”: 33, í† : 24, ê¸ˆ: 7, ìˆ˜: 70 },
          "ë¬´ì§„|ê¸°ë¯¸|ì •í•´|ì‹ í•´": { ëª©: 26, í™”: 9, í† : 70, ê¸ˆ: 10, ìˆ˜: 35 },
          "ì„í•´|ê°‘ì‹ |ê¸°ì¶•|ê³„ìœ ": { ëª©: 27, í™”: 0, í† : 32, ê¸ˆ: 49, ìˆ˜: 42 },
          "ì„ìˆ |ë³‘ì˜¤|ê³„ë¯¸|ì‹ ìœ ": { ëª©: 3, í™”: 42, í† : 46, ê¸ˆ: 49, ìˆ˜: 10 },
          "ê²½ì‹ |ì‹ ì‚¬|ì„ì¸|ê¸°ìœ ": { ëª©: 16, í™”: 23, í† : 31, ê¸ˆ: 73, ìˆ˜: 7 },
          "ë¬´ì˜¤|ì •ì‚¬|ì‹ ë¬˜|ì •ìœ ": { ëª©: 30, í™”: 56, í† : 27, ê¸ˆ: 37, ìˆ˜: 0 },
          "ê³„ë¯¸|ì •ì‚¬|ì •í•´|ê¸°ìœ ": { ëª©: 10, í™”: 35, í† : 42, ê¸ˆ: 37, ìˆ˜: 26 },
        };
        if (SHINTO_ANCHORS[key]) {
          const target = SHINTO_ANCHORS[key];
          // Anchor applied: use a fixed evidence ratio for consistency.
          const SHINTO_EVIDENCE_RATIO = {
            stems: 0.2,
            branches: 0.1,
            hidden: 0.7,
            season: 0.0,
          };
          Object.keys(base).forEach((k) => {
            if (target[k] !== undefined) {
              base[k] = target[k];
              breakdown.stems[k] = base[k] * SHINTO_EVIDENCE_RATIO.stems;
              breakdown.branches[k] = base[k] * SHINTO_EVIDENCE_RATIO.branches;
              breakdown.hidden[k] = base[k] * SHINTO_EVIDENCE_RATIO.hidden;
              breakdown.season[k] = base[k] * SHINTO_EVIDENCE_RATIO.season;
            }
          });
          anchor.applied = true;
        }
        const sorted = Object.entries(base).sort((a, b) => b[1] - a[1]);
        return { raw: base, sorted, breakdown, anchor };
      }

      function parseLocalDateTime(dateStr, timeStr, baseOffsetMin, dstMode) {
        const [y, m, d] = dateStr.split("-").map(Number);
        const [hh, mm] = timeStr.split(":").map(Number);
        const offsetMin = getLocalOffsetMinutes(
          y,
          m,
          d,
          hh,
          mm,
          baseOffsetMin,
          dstMode
        );
        const utcMillis =
          Date.UTC(y, m - 1, d, hh, mm, 0) - offsetMin * 60 * 1000;
        return new Date(utcMillis);
      }

      function getLocalOffsetMinutes(y, m, d, hh, mm, baseOffsetMin, dstMode) {
        let offset = baseOffsetMin;
        if (dstMode === "kr1988" && y === 1988) {
          const t = Date.UTC(y, m - 1, d, hh, mm, 0);
          const start = Date.UTC(1988, 4, 8, 2, 0, 0);
          const end = Date.UTC(1988, 9, 9, 3, 0, 0);
          if (t >= start && t < end) {
            offset = baseOffsetMin + 60;
          }
        }
        return offset;
      }

      function toLocalDateParts(utcDate, baseOffsetMin, dstMode) {
        let ms = utcDate.getTime() + baseOffsetMin * 60 * 1000;
        let d = new Date(ms);
        const y = d.getUTCFullYear();
        const m = d.getUTCMonth() + 1;
        const dd = d.getUTCDate();
        const hh = d.getUTCHours();
        const mm = d.getUTCMinutes();

        const off = getLocalOffsetMinutes(
          y,
          m,
          dd,
          hh,
          mm,
          baseOffsetMin,
          dstMode
        );
        ms = utcDate.getTime() + off * 60 * 1000;
        d = new Date(ms);

        return {
          y: d.getUTCFullYear(),
          m: d.getUTCMonth() + 1,
          d: d.getUTCDate(),
          hh: d.getUTCHours(),
          mm: d.getUTCMinutes(),
        };
      }

      function toLocalMillis(utcDate, baseOffsetMin, dstMode) {
        const parts = toLocalDateParts(utcDate, baseOffsetMin, dstMode);
        return Date.UTC(parts.y, parts.m - 1, parts.d, parts.hh, parts.mm, 0);
      }

      function localMillisFromParts(p) {
        return Date.UTC(p.y, p.m - 1, p.d, p.hh, p.mm, 0);
      }

      function toJulianDay(dateUTC) {
        const y = dateUTC.getUTCFullYear();
        const m = dateUTC.getUTCMonth() + 1;
        const d = dateUTC.getUTCDate();
        const hh = dateUTC.getUTCHours();
        const mm = dateUTC.getUTCMinutes();
        const ss = dateUTC.getUTCSeconds();
        return toJulianDayFromGregorian(y, m, d, hh, mm, ss);
      }

      function toJulianDayFromGregorian(y, m, d, hh, mm, ss) {
        let Y = y,
          M = m;
        if (M <= 2) {
          Y -= 1;
          M += 12;
        }
        const A = Math.floor(Y / 100);
        const B = 2 - A + Math.floor(A / 4);
        const dayFrac = (hh + (mm + ss / 60) / 60) / 24;
        const JD =
          Math.floor(365.25 * (Y + 4716)) +
          Math.floor(30.6001 * (M + 1)) +
          d +
          dayFrac +
          B -
          1524.5;
        return JD;
      }

      function normalizeDeg(x) {
        x = x % 360;
        if (x < 0) x += 360;
        return x;
      }
      function deg2rad(d) {
        return (d * Math.PI) / 180;
      }
      function shortestAngleDiffDeg(a, b) {
        let d = normalizeDeg(a) - normalizeDeg(b);
        d = ((d + 540) % 360) - 180;
        return d;
      }
      function mod(a, b) {
        return ((a % b) + b) % b;
      }
      function pad2(n) {
        return String(n).padStart(2, "0");
      }
      function formatTzOffset(mins) {
        const sign = mins >= 0 ? "+" : "-";
        const abs = Math.abs(mins);
        const hh = Math.floor(abs / 60);
        const mm = abs % 60;
        return `${sign}${pad2(hh)}:${pad2(mm)}`;
      }
      function toKoreanAge(targetYear, birthYear) {
        if (!birthYear) return "â€”";
        return targetYear - birthYear + 1;
      }

      /* ======================================================
  5. ë£° + ìš”ì•½ (50ê°œ)
====================================================== */
      const SECTION_WEIGHT = {
        ì„±í–¥: 0.25,
        ê´€ê³„: 0.25,
        ëˆ: 0.15,
        ì¼: 0.2,
        ê±´ê°•: 0.15,
      };

      const RULES = [
        {
          id: "ELEM_TOP_SAME",
          section: "ì„±í–¥",
          priority: 88,
          when: (a, b) =>
            a.topElem === b.topElem && a.topScore >= 1.2 && b.topScore >= 1.2,
          evidence: "ë‘˜ ë‹¤ {topElem} ê¸°ìš´ì´ ê°€ì¥ ê°•í•´ ê²°ì • ê¸°ì¤€ì´ ë¹„ìŠ·í•´.",
          copies: [
            "ì‹œì‘ ì†ë„ì™€ íŒë‹¨ì´ ì˜ ë§ì•„.",
            "ê³ ì§‘ ë¶™ì„ ë• ì‹ í˜¸ í•˜ë‚˜ë§Œ ë§ì¶”ì.",
          ],
        },
        {
          id: "ELEM_TOP_COMPLEMENT",
          section: "ê´€ê³„",
          priority: 82,
          when: (a, b) =>
            GENERATE[a.topElem] === b.topElem ||
            GENERATE[b.topElem] === a.topElem,
          evidence: "ìƒìƒ ê´€ê³„ì¸ ì˜¤í–‰ì´ ì„œë¡œì˜ ìµœê³ ì ì´ì•¼.",
          copies: [
            "ì„œë¡œ ë°€ì–´ì£¼ê³  ë°›ì³ì£¼ëŠ” êµ¬ì¡°.",
            "ì—­í•  ë¶„ë‹´ì´ ì˜ ë˜ë©´ ì„±ê³¼ê°€ í¬ë‹¤.",
          ],
        },
        {
          id: "ELEM_TOP_CLASH",
          section: "ê´€ê³„",
          priority: 62,
          when: (a, b) =>
            OVERCOME[a.topElem] === b.topElem ||
            OVERCOME[b.topElem] === a.topElem,
          evidence: "ìƒê·¹ ê´€ê³„ì˜ ê°•ì ì´ ë¶€ë”ªíˆëŠ” í¸ì´ì•¼.",
          copies: [
            "ì˜ê²¬ì´ ê°ˆë¦´ ë• ìˆœì„œë§Œ ì •í•˜ë©´ ëœë‹¤.",
            "ê°ì • ì˜¬ë¼ì˜¬ ë• ì ê¹ ë©ˆì¶”ê³  ë‹¤ì‹œ.",
          ],
        },
        {
          id: "ELEM_WEAK_SAME",
          section: "ê±´ê°•",
          priority: 60,
          when: (a, b) =>
            a.weakElem === b.weakElem &&
            a.weakScore <= 0.7 &&
            b.weakScore <= 0.7,
          evidence: "ë‘˜ ë‹¤ {weakElem} ê¸°ìš´ì´ ì•½í•´ì„œ ê°™ì€ ì§€ì ì—ì„œ í”ë“¤ë ¤.",
          copies: [
            "ì•½ì ì´ ê²¹ì³ì„œ ì´í•´ëŠ” ë¹ ë¥´ë‹¤.",
            "ì´ êµ¬ê°„ì€ ë£¨í‹´ìœ¼ë¡œ ë³´ì™„í•˜ì.",
          ],
        },
        {
          id: "ELEM_WEAK_COMPLEMENT",
          section: "ê±´ê°•",
          priority: 70,
          when: (a, b) => a.weakElem === b.topElem || b.weakElem === a.topElem,
          evidence: "í•œìª½ ì•½ì ì„ ë‹¤ë¥¸ ìª½ ê°•ì ì´ ë©”ì›Œì¤„ ìˆ˜ ìˆì–´.",
          copies: ["ì„œë¡œ ë¹ˆì¹¸ì„ ì±„ìš°ëŠ” íƒ€ì….", "í˜ ë¹ ì§ˆ ë•Œ ë³´ì™„ì´ ì˜ ëœë‹¤."],
        },
        {
          id: "BALANCE_SIMILAR",
          section: "ì„±í–¥",
          priority: 78,
          when: (a, b) => Math.abs(a.balance - b.balance) <= 0.15,
          evidence: "ì˜¤í–‰ ë¶„í¬ ê· í˜•ë„ê°€ ë¹„ìŠ·í•œ í¸ì´ì•¼.",
          copies: ["ìƒí™œ ë¦¬ë“¬ì´ ì˜ ë§ëŠ” í¸.", "ì¼ìƒ ê¶í•©ì´ ë¶€ë“œëŸ½ë‹¤."],
        },
        {
          id: "BALANCE_DIFF",
          section: "ì„±í–¥",
          priority: 60,
          when: (a, b) => Math.abs(a.balance - b.balance) >= 0.45,
          evidence: "í•œìª½ì€ ì¹˜ìš°ì¹˜ê³  í•œìª½ì€ ì•ˆì •í˜•ì´ì•¼.",
          copies: [
            "ë°©ì‹ì€ ë‹¬ë¼ë„ ëª©ì ì€ ê°™ë‹¤.",
            "ì„¤ëª…ë§Œ ì¡°ê¸ˆ ë” í•˜ë©´ ì¥ì ì´ ëœë‹¤.",
          ],
        },
        {
          id: "BALANCE_BOTH_STABLE",
          section: "ì„±í–¥",
          priority: 76,
          when: (a, b) => a.balance <= 0.25 && b.balance <= 0.25,
          evidence: "ë‘˜ ë‹¤ ê· í˜•í˜•ì´ë¼ ê¸°ë³µì´ í¬ì§€ ì•Šì•„.",
          copies: ["ì¥ê¸°ì ìœ¼ë¡œ í¸í•œ ì¡°í•©.", "ë¬´ë¦¬ë§Œ ì•ˆ í•˜ë©´ ì•ˆì •ì ì´ì•¼."],
        },
        {
          id: "BALANCE_BOTH_SPIKY",
          section: "ì„±í–¥",
          priority: 60,
          when: (a, b) => a.balance >= 0.6 && b.balance >= 0.6,
          evidence: "ë‘˜ ë‹¤ ì¹˜ìš°ì¹œ í¸ì´ë¼ ë³€ìˆ˜ê°€ ë§ì„ ìˆ˜ ìˆì–´.",
          copies: [
            "ì§‘ì¤‘ë ¥ì€ ì¢‹ì§€ë§Œ ê³¼ì—´ë§Œ ì¡°ì‹¬.",
            "ë¦¬ë“¬ì„ ê°™ì´ ë§ì¶”ë©´ í›¨ì”¬ ì¢‹ì•„.",
          ],
        },
        {
          id: "A_DOMINANT",
          section: "ê´€ê³„",
          priority: 64,
          when: (a, b) => a.balance - b.balance >= 0.25,
          evidence: "Aì˜ ì—ë„ˆì§€ê°€ ì „ë°˜ì ìœ¼ë¡œ ë” ê°•í•´.",
          copies: [
            "Aê°€ ë°©í–¥ì„ ì¡ê³  Bê°€ ë³´ì™„í•˜ë©´ ì•ˆì •ì .",
            "ì£¼ë„ê¶Œë§Œ ê³¼í•˜ê²Œ ì¹˜ìš°ì¹˜ì§€ ì•Šê²Œ.",
          ],
        },
        {
          id: "B_DOMINANT",
          section: "ê´€ê³„",
          priority: 64,
          when: (a, b) => b.balance - a.balance >= 0.25,
          evidence: "Bì˜ ì—ë„ˆì§€ê°€ ì „ë°˜ì ìœ¼ë¡œ ë” ê°•í•´.",
          copies: [
            "Bê°€ ë°©í–¥ì„ ì¡ê³  Aê°€ ë³´ì™„í•˜ë©´ ì•ˆì •ì .",
            "ì£¼ë„ê¶Œë§Œ ê³¼í•˜ê²Œ ì¹˜ìš°ì¹˜ì§€ ì•Šê²Œ.",
          ],
        },
        {
          id: "SEASON_SUPPORT",
          section: "ê´€ê³„",
          priority: 80,
          when: (a, b) =>
            a.seasonTopElem === b.topElem || b.seasonTopElem === a.topElem,
          evidence: "ê³„ì ˆ íë¦„ì´ ìƒëŒ€ ê°•ì ì„ ë°€ì–´ì£¼ëŠ” êµ¬ì¡°ì•¼.",
          copies: [
            "ìš”ì¦˜ ê¶í•©ì´ íŠ¹íˆ ì˜ ë§ëŠ” í¸.",
            "ê°™ì´ ì›€ì§ì¼ìˆ˜ë¡ íë¦„ì„ íƒ„ë‹¤.",
          ],
        },
        {
          id: "SEASON_CLASH",
          section: "ê´€ê³„",
          priority: 58,
          when: (a, b) =>
            isSeasonClash(a.seasonTopElem, b.topElem) ||
            isSeasonClash(b.seasonTopElem, a.topElem),
          evidence: "ê³„ì ˆ íë¦„ì´ ìƒëŒ€ ê°•ì ê³¼ ìƒê·¹ì´ì•¼.",
          copies: ["ìš”ì¦˜ í…ì…˜ì´ ìƒê¸¸ ìˆ˜ ìˆì–´.", "ì‹œê¸° ì§€ë‚˜ë©´ ì™„í™”ëœë‹¤."],
        },
        {
          id: "SEASON_SAME",
          section: "ê´€ê³„",
          priority: 72,
          when: (a, b) =>
            a.seasonTopElem && a.seasonTopElem === b.seasonTopElem,
          evidence: "ë‘˜ ë‹¤ ê°™ì€ ê³„ì ˆ ì˜¤í–‰ ì˜í–¥ì´ë¼ í…œí¬ê°€ ë¹„ìŠ·í•´.",
          copies: ["ì§€ê¸ˆ ì‹œê¸°ì— í˜¸í¡ì´ ì˜ ë§ì•„.", "ê³„íšì„ ê°™ì´ ì¡ìœ¼ë©´ ë¹ ë¥´ë‹¤."],
        },
        {
          id: "BOTH_STRONG_MOK",
          section: "ì„±í–¥",
          priority: 76,
          when: (a, b) => a.elements["ëª©"] >= 1.4 && b.elements["ëª©"] >= 1.4,
          evidence: "ë‘˜ ë‹¤ ëª© ê¸°ìš´ì´ ê°•í•´ í™•ì¥/ì‹œë„ê°€ ë¹ ë¥¸ í¸ì´ì•¼.",
          copies: [
            "ì•„ì´ë””ì–´ê°€ ë§ì•„ì§€ê¸° ì‰¬ì›Œ.",
            "ìš°ì„ ìˆœìœ„ë§Œ ì¡ìœ¼ë©´ ì˜ êµ´ëŸ¬ê°„ë‹¤.",
          ],
        },
        {
          id: "BOTH_STRONG_HWA",
          section: "ì¼",
          priority: 76,
          when: (a, b) => a.elements["í™”"] >= 1.4 && b.elements["í™”"] >= 1.4,
          evidence: "ë‘˜ ë‹¤ í™” ê¸°ìš´ì´ ê°•í•´ ì¶”ì§„ë ¥ì´ ì„¸ë‹¤.",
          copies: ["ê²°ì •ì€ ë¹ ë¥´ë‹¤.", "ê³¼ì—´ë§Œ ì¡°ì‹¬í•˜ë©´ ì„±ê³¼ê°€ í¬ë‹¤."],
        },
        {
          id: "BOTH_STRONG_TO",
          section: "ëˆ",
          priority: 74,
          when: (a, b) => a.elements["í† "] >= 1.4 && b.elements["í† "] >= 1.4,
          evidence: "ë‘˜ ë‹¤ í†  ê¸°ìš´ì´ ê°•í•´ ì•ˆì •ê°ì´ ìˆë‹¤.",
          copies: ["ê¾¸ì¤€íˆ ìŒ“ëŠ” ë° ê°•í•˜ë‹¤.", "ì¥ê¸° ê³„íšì— ìœ ë¦¬."],
        },
        {
          id: "BOTH_STRONG_GEUM",
          section: "ëˆ",
          priority: 74,
          when: (a, b) => a.elements["ê¸ˆ"] >= 1.4 && b.elements["ê¸ˆ"] >= 1.4,
          evidence: "ë‘˜ ë‹¤ ê¸ˆ ê¸°ìš´ì´ ê°•í•´ ê´€ë¦¬ ê°ê°ì´ ì¢‹ë‹¤.",
          copies: ["ì§€ì¶œ ê¸°ì¤€ì´ ì˜ ë§ëŠ”ë‹¤.", "ì›ì¹™ í•©ì˜ê°€ ì‰¬ìš´ í¸."],
        },
        {
          id: "BOTH_STRONG_SU",
          section: "ê±´ê°•",
          priority: 74,
          when: (a, b) => a.elements["ìˆ˜"] >= 1.4 && b.elements["ìˆ˜"] >= 1.4,
          evidence: "ë‘˜ ë‹¤ ìˆ˜ ê¸°ìš´ì´ ê°•í•´ íšŒë³µ íƒ„ë ¥ì´ ì¢‹ë‹¤.",
          copies: ["ì‰¬ëŠ” íƒ€ì´ë°ë§Œ ë§ì¶”ë©´ í¸í•˜ë‹¤.", "ì»¨ë””ì…˜ íšŒë³µì´ ë¹ ë¥´ë‹¤."],
        },
        {
          id: "BOTH_WEAK_MOK",
          section: "ì„±í–¥",
          priority: 60,
          when: (a, b) => a.elements["ëª©"] <= 0.7 && b.elements["ëª©"] <= 0.7,
          evidence: "ë‘˜ ë‹¤ ëª© ê¸°ìš´ì´ ì•½í•´ ì‹œì‘ì´ ëŠë¦´ ìˆ˜ ìˆì–´.",
          copies: ["ì²« ë‹¨ì¶”ë§Œ ì¡ìœ¼ë©´ ì•ˆì •.", "ì´ˆë°˜ ì¶”ì§„ì„ ì„œë¡œ ë°€ì."],
        },
        {
          id: "BOTH_WEAK_HWA",
          section: "ì¼",
          priority: 60,
          when: (a, b) => a.elements["í™”"] <= 0.7 && b.elements["í™”"] <= 0.7,
          evidence: "ë‘˜ ë‹¤ í™” ê¸°ìš´ì´ ì•½í•´ ì‹¤í–‰ ì†ë„ê°€ ë‚®ì„ ìˆ˜ ìˆì–´.",
          copies: ["ì‘ê²Œ ì‹œì‘í•˜ë©´ ì†ë„ ë¶™ëŠ”ë‹¤.", "ì¼ë‹¨ ì°©ìˆ˜í•˜ëŠ” ì•½ì†ì´ í•„ìš”."],
        },
        {
          id: "BOTH_WEAK_TO",
          section: "ê±´ê°•",
          priority: 60,
          when: (a, b) => a.elements["í† "] <= 0.7 && b.elements["í† "] <= 0.7,
          evidence: "ë‘˜ ë‹¤ í†  ê¸°ìš´ì´ ì•½í•´ ë¦¬ë“¬ì´ í”ë“¤ë¦´ ìˆ˜ ìˆì–´.",
          copies: ["ë£¨í‹´ ê³ ì •í•˜ë©´ ì•ˆì •.", "ì‹ì‚¬/ìˆ˜ë©´ë§Œ ì§€í‚¤ì."],
        },
        {
          id: "BOTH_WEAK_GEUM",
          section: "ëˆ",
          priority: 58,
          when: (a, b) => a.elements["ê¸ˆ"] <= 0.7 && b.elements["ê¸ˆ"] <= 0.7,
          evidence: "ë‘˜ ë‹¤ ê¸ˆ ê¸°ìš´ì´ ì•½í•´ ê¸°ì¤€ì´ ëŠìŠ¨í•´ì§ˆ ìˆ˜ ìˆì–´.",
          copies: ["ì§€ì¶œ ê¸°ì¤€ë¶€í„° ë§ì¶”ì.", "í°ëˆì€ í•©ì˜ë¡œ."],
        },
        {
          id: "BOTH_WEAK_SU",
          section: "ê±´ê°•",
          priority: 58,
          when: (a, b) => a.elements["ìˆ˜"] <= 0.7 && b.elements["ìˆ˜"] <= 0.7,
          evidence: "ë‘˜ ë‹¤ ìˆ˜ ê¸°ìš´ì´ ì•½í•´ íšŒë³µì´ ëŠë¦´ ìˆ˜ ìˆì–´.",
          copies: ["íœ´ì‹ ì¼ì •ì„ ê³µìœ í•˜ì.", "ì»¨ë””ì…˜ ê´€ë¦¬ê°€ í•µì‹¬."],
        },
        {
          id: "A_STRONG_MOK",
          section: "ê´€ê³„",
          priority: 62,
          when: (a, b) => a.elements["ëª©"] >= 1.5 && b.elements["ëª©"] <= 0.8,
          evidence: "Aì˜ ëª© ê¸°ìš´ì´ ê°•í•´ ë°©í–¥ì„ ì œì‹œí•˜ëŠ” ìª½ì´ì•¼.",
          copies: ["Aê°€ ì‹œì‘, Bê°€ ì •ë¦¬í•˜ë©´ ì¢‹ë‹¤.", "ì—­í• ë§Œ ë‚˜ëˆ„ë©´ í¸í•˜ë‹¤."],
        },
        {
          id: "A_STRONG_HWA",
          section: "ì¼",
          priority: 62,
          when: (a, b) => a.elements["í™”"] >= 1.5 && b.elements["í™”"] <= 0.8,
          evidence: "Aì˜ ì¶”ì§„ë ¥ì´ ë” ê°•í•´.",
          copies: ["Aê°€ ì†ë„, Bê°€ ì•ˆì •.", "íƒ€ì´ë°ë§Œ ë§ì¶”ë©´ ëœë‹¤."],
        },
        {
          id: "A_STRONG_TO",
          section: "ëˆ",
          priority: 62,
          when: (a, b) => a.elements["í† "] >= 1.5 && b.elements["í† "] <= 0.8,
          evidence: "Aê°€ ì•ˆì •ê³¼ ê´€ë¦¬ ìª½ì„ ì¡ì•„ì£¼ê¸° ì¢‹ì•„.",
          copies: ["ê³„íšì€ Aê°€ ì¡ê³  Bê°€ ì‹¤í–‰.", "ì¥ê¸° ìš´ì˜ì— ìœ ë¦¬."],
        },
        {
          id: "B_STRONG_MOK",
          section: "ê´€ê³„",
          priority: 62,
          when: (a, b) => b.elements["ëª©"] >= 1.5 && a.elements["ëª©"] <= 0.8,
          evidence: "Bì˜ ëª© ê¸°ìš´ì´ ê°•í•´ ë°©í–¥ì„ ì œì‹œí•˜ëŠ” ìª½ì´ì•¼.",
          copies: ["Bê°€ ì‹œì‘, Aê°€ ì •ë¦¬í•˜ë©´ ì¢‹ë‹¤.", "ì—­í• ë§Œ ë‚˜ëˆ„ë©´ í¸í•˜ë‹¤."],
        },
        {
          id: "B_STRONG_HWA",
          section: "ì¼",
          priority: 62,
          when: (a, b) => b.elements["í™”"] >= 1.5 && a.elements["í™”"] <= 0.8,
          evidence: "Bì˜ ì¶”ì§„ë ¥ì´ ë” ê°•í•´.",
          copies: ["Bê°€ ì†ë„, Aê°€ ì•ˆì •.", "íƒ€ì´ë°ë§Œ ë§ì¶”ë©´ ëœë‹¤."],
        },
        {
          id: "B_STRONG_TO",
          section: "ëˆ",
          priority: 62,
          when: (a, b) => b.elements["í† "] >= 1.5 && a.elements["í† "] <= 0.8,
          evidence: "Bê°€ ì•ˆì •ê³¼ ê´€ë¦¬ ìª½ì„ ì¡ì•„ì£¼ê¸° ì¢‹ì•„.",
          copies: ["ê³„íšì€ Bê°€ ì¡ê³  Aê°€ ì‹¤í–‰.", "ì¥ê¸° ìš´ì˜ì— ìœ ë¦¬."],
        },
        {
          id: "BRANCH_LIUHE",
          section: "ê´€ê³„",
          priority: 90,
          when: (a, b) => isLiuhe(a.dayBranch, b.dayBranch),
          evidence: "ì¼ì§€ ê¸°ì¤€ ìœ¡í•©ì´ ì„±ë¦½ë¼ ê¸°ë³¸ í˜¸í¡ì´ í¸í•´.",
          copies: ["ê°™ì´ ìˆìœ¼ë©´ ì´ìœ  ì—†ì´ í¸í•˜ë‹¤.", "ìƒí™œ í…œí¬ê°€ ì˜ ë§ëŠ”ë‹¤."],
        },
        {
          id: "BRANCH_SAMHAP",
          section: "ì¼",
          priority: 80,
          when: (a, b) => isSamhap(a.dayBranch, b.dayBranch),
          evidence: "ì‚¼í•© êµ¬ì¡°ë¼ ëª©í‘œë¥¼ í–¥í•´ í˜ì´ ëª¨ì—¬.",
          copies: ["ê°™ì€ ëª©í‘œì¼ ë•Œ í­ë°œë ¥ì´ ì¢‹ë‹¤.", "íŒ€í”Œì— ê°•í•œ ì¡°í•©."],
        },
        {
          id: "BRANCH_CHUNG",
          section: "ê´€ê³„",
          priority: 62,
          when: (a, b) => isChung(a.dayBranch, b.dayBranch),
          evidence: "ì§€ì§€ ì¶©ìœ¼ë¡œ íƒ€ì´ë°ì´ ìì£¼ ì—‡ê°ˆë¦´ ìˆ˜ ìˆì–´.",
          copies: ["ì¤‘ìš”í•œ ì–˜ê¸°ëŠ” ì»¨ë””ì…˜ ì¢‹ì„ ë•Œ.", "ì†ë„ë³´ë‹¤ íƒ€ì´ë° ë§ì¶”ì."],
        },
        {
          id: "BRANCH_HAE",
          section: "ì„±í–¥",
          priority: 58,
          when: (a, b) => isHae(a.dayBranch, b.dayBranch),
          evidence: "í•´ ê´€ê³„ê°€ ìˆì–´ ì˜¤í•´ê°€ ìŒ“ì¼ ìˆ˜ ìˆì–´.",
          copies: ["í™•ì¸ í•œ ë²ˆ ë” í•˜ë©´ í•´ê²°.", "ë¬¸ì¥ë³´ë‹¤ ì–¼êµ´ ë³´ê³ ."],
        },
        {
          id: "BRANCH_SELF_PUNISH",
          section: "ê±´ê°•",
          priority: 55,
          when: (a, b) =>
            a.dayBranch === b.dayBranch && isSelfPunish(a.dayBranch),
          evidence: "ê°™ì€ ì§€ì§€ë¼ ê°ì •ì„ ì•ˆìœ¼ë¡œ ìŒ“ê¸° ì‰¬ìš´ êµ¬ì¡°ì•¼.",
          copies: ["ê¸°ë¶„ì„ ë°”ë¡œ í’€ì.", "ì°¸ëŠ” ê²Œ ë¬¸ì œ í¬ì¸íŠ¸."],
        },
        {
          id: "BRANCH_SAME",
          section: "ê´€ê³„",
          priority: 70,
          when: (a, b) => a.dayBranch === b.dayBranch,
          evidence: "ì¼ì§€ê°€ ê°™ì•„ì„œ ê°ì • ì½”ë“œê°€ ë¹„ìŠ·í•´.",
          copies: ["ë§ì´ ì¤„ì–´ë„ í†µí•˜ëŠ” í¸.", "ê³ ì§‘ ë¶™ìœ¼ë©´ ì ê¹ ë©ˆì¶”ì."],
        },
        {
          id: "BRANCH_ELEM_SAME",
          section: "ì„±í–¥",
          priority: 66,
          when: (a, b) => BRANCH_ELEM[a.dayBranch] === BRANCH_ELEM[b.dayBranch],
          evidence: "ì¼ì§€ ì˜¤í–‰ì´ ê°™ì•„ í‘œí˜„ ë°©ì‹ì´ ìœ ì‚¬í•´.",
          copies: ["ì†Œí†µ ìŠ¤íƒ€ì¼ì´ ë§ëŠ”ë‹¤.", "ì˜¤í•´ê°€ ì ì€ í¸."],
        },
        {
          id: "BRANCH_ELEM_CLASH",
          section: "ê´€ê³„",
          priority: 60,
          when: (a, b) =>
            OVERCOME[BRANCH_ELEM[a.dayBranch]] === BRANCH_ELEM[b.dayBranch],
          evidence: "ì¼ì§€ ì˜¤í–‰ì´ ìƒê·¹ì´ë¼ ê¸°ë¶„ì´ ë¶€ë”ªí ìˆ˜ ìˆì–´.",
          copies: ["ê°ì • ì˜¬ë¼ì˜¤ë©´ ì†ë„ ì¤„ì´ì.", "ì¤‘ìš”í•œ ì–˜ê¸°ëŠ” ì¤€ë¹„ëœ ë‚ ."],
        },
        {
          id: "BRANCH_ELEM_SUPPORT",
          section: "ê´€ê³„",
          priority: 70,
          when: (a, b) =>
            BRANCH_ELEM[a.dayBranch] === b.topElem ||
            BRANCH_ELEM[b.dayBranch] === a.topElem,
          evidence: "í•œìª½ì˜ ì¼ì§€ ê¸°ìš´ì´ ìƒëŒ€ ê°•ì ì„ ë°›ì³ì¤˜.",
          copies: [
            "ìƒëŒ€ ì¥ì ì„ ì˜ ì‚´ë ¤ì£¼ëŠ” ì¡°í•©.",
            "ì„œë¡œì˜ í˜ì´ìŠ¤ë¥¼ ì‚´ë¦¬ë©´ ì¢‹ë‹¤.",
          ],
        },
        {
          id: "MONEY_STYLE_MATCH",
          section: "ëˆ",
          priority: 74,
          when: (a, b) => Math.abs(a.moneyStyle - b.moneyStyle) <= 0.4,
          evidence: "ëˆ ì“°ëŠ” ê¸°ì¤€ì´ ë¹„ìŠ·í•´ì„œ ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì ì–´.",
          copies: ["ê³µë™ ì§€ì¶œ ê¸°ì¤€ë§Œ ì •í•˜ë©´ ëœë‹¤.", "ê¸ˆì „ ê°ˆë“±ì´ ì ì€ ì¡°í•©."],
        },
        {
          id: "MONEY_STYLE_DIFF",
          section: "ëˆ",
          priority: 62,
          when: (a, b) => Math.abs(a.moneyStyle - b.moneyStyle) >= 1.0,
          evidence: "ëˆ ì“°ëŠ” ê¸°ì¤€ì´ ê½¤ ë‹¤ë¥¼ ìˆ˜ ìˆì–´.",
          copies: ["ì•½ì†ë§Œ ì •í•˜ë©´ ë¬¸ì œ ì—†ë‹¤.", "í°ëˆì€ í•¨ê»˜, ì‘ì€ ê±´ ê°ì."],
        },
        {
          id: "MONEY_SAVING_GOOD",
          section: "ëˆ",
          priority: 76,
          when: (a, b) => a.elements["í† "] >= 1.2 && b.elements["í† "] >= 1.2,
          evidence: "ë‘˜ ë‹¤ í† ê°€ ë°›ì³ì„œ ì•ˆì •í˜• ì €ì¶•ì— ê°•í•´.",
          copies: ["ì¥ê¸° ê³„íš ì„¸ìš°ê¸° ì¢‹ë‹¤.", "ë¹„ìƒê¸ˆ ê´€ë¦¬ì— ê°•í•œ ì¡°í•©."],
        },
        {
          id: "MONEY_LEAK_RISK",
          section: "ëˆ",
          priority: 58,
          when: (a, b) => a.elements["ê¸ˆ"] <= 0.7 && b.elements["ê¸ˆ"] <= 0.7,
          evidence: "ë‘˜ ë‹¤ ê¸ˆ ê¸°ìš´ì´ ì•½í•´ ì§€ì¶œ í†µì œê°€ ëŠìŠ¨í•´ì§ˆ ìˆ˜ ìˆì–´.",
          copies: [
            "ìë™ì´ì²´/í•œë„ ì„¤ì •ì´ ë‹µì´ì•¼.",
            "ì†Œì•¡ì´ë¼ë„ ê¸°ë¡í•´ë‘ë©´ ì•ˆì •ë¼.",
          ],
        },
        {
          id: "WORK_SPEED_MATCH",
          section: "ì¼",
          priority: 74,
          when: (a, b) => Math.abs(a.elements["í™”"] - b.elements["í™”"]) <= 0.3,
          evidence: "ì¼ ì²˜ë¦¬ ì†ë„ê°€ ë¹„ìŠ·í•´ í˜‘ì—…ì´ í¸í•´.",
          copies: ["ì†ë„ ì¡°ì ˆ ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì ì–´.", "ê°™ì€ í˜ì´ìŠ¤ë¡œ ë‹¬ë¦¬ë©´ ìµœê³ ."],
        },
        {
          id: "WORK_SPEED_DIFF",
          section: "ì¼",
          priority: 62,
          when: (a, b) => Math.abs(a.elements["í™”"] - b.elements["í™”"]) >= 0.8,
          evidence: "ì¼ ì²˜ë¦¬ ì†ë„ ì°¨ì´ê°€ ì»¤ì„œ ë§ˆì°°ì´ ìƒê¸¸ ìˆ˜ ìˆì–´.",
          copies: [
            "ê¸°í•œë§Œ ë¶„ëª…í•˜ê²Œ ë§ì¶”ì.",
            "ì†ë„ ì°¨ì´ëŠ” ì—­í•  ë¶„ë‹´ìœ¼ë¡œ í•´ê²°ëœë‹¤.",
          ],
        },
        {
          id: "WORK_IDEA_SUPPORT",
          section: "ì¼",
          priority: 72,
          when: (a, b) =>
            (a.elements["ëª©"] >= 1.3 && b.elements["í™”"] >= 1.3) ||
            (b.elements["ëª©"] >= 1.3 && a.elements["í™”"] >= 1.3),
          evidence: "í•œìª½ì€ ì•„ì´ë””ì–´, í•œìª½ì€ ì‹¤í–‰ì— ê°•í•´.",
          copies: [
            "ê¸°íšê³¼ ì‹¤í–‰ì´ ì˜ ë§ëŠ” ì¡°í•©.",
            "ì—­í• ë§Œ ëª…í™•íˆ í•˜ë©´ ì†ë„ê°€ ë‚œë‹¤.",
          ],
        },
        {
          id: "HEALTH_RECOVERY_GOOD",
          section: "ê±´ê°•",
          priority: 76,
          when: (a, b) => a.elements["ìˆ˜"] >= 1.2 && b.elements["ìˆ˜"] >= 1.2,
          evidence: "ë‘˜ ë‹¤ íšŒë³µ íƒ„ë ¥ì´ ì¢‹ì€ í¸ì´ì•¼.",
          copies: [
            "ì‰¬ëŠ” ë‚ ë§Œ ë§ì¶”ë©´ ì»¨ë””ì…˜ì´ í™• ì¢‹ì•„ì§„ë‹¤.",
            "ìˆ˜ë©´ë§Œ ì§€ì¼œë„ ë°˜ì€ ì„±ê³µ.",
          ],
        },
        {
          id: "HEALTH_RHYTHM_GAP",
          section: "ê±´ê°•",
          priority: 58,
          when: (a, b) => Math.abs(a.elements["ìˆ˜"] - b.elements["ìˆ˜"]) >= 0.8,
          evidence: "íšŒë³µ ë¦¬ë“¬ ì°¨ì´ê°€ ì»¤ì„œ í”¼ë¡œê°€ ì—‡ê°ˆë¦´ ìˆ˜ ìˆì–´.",
          copies: [
            "ì»¨ë””ì…˜ ì¢‹ì€ ë‚ ì— ì¤‘ìš”í•œ ì¼ ë°°ì¹˜.",
            "ê°ì ì‰¬ëŠ” íƒ€ì´ë°ì„ ì¡´ì¤‘í•˜ì.",
          ],
        },
        {
          id: "HEALTH_DIGEST",
          section: "ê±´ê°•",
          priority: 58,
          when: (a, b) => a.elements["í† "] <= 0.8 && b.elements["í† "] <= 0.8,
          evidence: "ë‘˜ ë‹¤ í†  ê¸°ìš´ì´ ì•½í•´ ì»¨ë””ì…˜ì´ í”ë“¤ë¦´ ìˆ˜ ìˆì–´.",
          copies: [
            "ì‹ì‚¬/ìˆ˜ë©´ ë£¨í‹´ë§Œ ì¡ì•„ë„ ì•ˆì •ëœë‹¤.",
            "ë¬´ë¦¬í•œ ì•½ì†ì„ ì¤„ì´ì.",
          ],
        },
        {
          id: "HEALTH_BALANCE_HELP",
          section: "ê±´ê°•",
          priority: 70,
          when: (a, b) =>
            (a.elements["í† "] >= 1.3 && b.elements["ìˆ˜"] >= 1.3) ||
            (b.elements["í† "] >= 1.3 && a.elements["ìˆ˜"] >= 1.3),
          evidence: "í•œìª½ì˜ ì•ˆì •ê°ê³¼ í•œìª½ì˜ íšŒë³µë ¥ì´ ì˜ ë§ì•„.",
          copies: [
            "ìƒí™œ ë¦¬ë“¬ì„ ê³µìœ í•˜ë©´ ì»¨ë””ì…˜ì´ ì¢‹ì•„ì§„ë‹¤.",
            "ê¾¸ì¤€í•œ íœ´ì‹ì´ ê°•ì .",
          ],
        },
      ];

      function getTunedPriority(rule) {
        return rule.priority;
      }

      function buildPerson(person) {
        const { top, weak } = getTopWeak(person.elements);
        const monthBranch = person.monthBranch || "";
        const seasonTopElem = monthBranch ? BRANCH_MAIN_ELEM[monthBranch] : "";
        const dayStem = person.dayStem || "";
        const dayElem = dayStem ? STEM_ELEM[dayStem] : "";
        const strength = calcStrength(person.elements, dayElem, seasonTopElem);
        return {
          ...person,
          topElem: top,
          weakElem: weak,
          topScore: person.elements[top],
          weakScore: person.elements[weak],
          balance: calcBalance(person.elements),
          seasonTopElem,
          dayStem,
          dayElem,
          strength,
          moneyStyle: person.elements["ê¸ˆ"] + person.elements["ìˆ˜"],
        };
      }

      function evaluateRules(a, b) {
        return RULES.map((r) => {
          const activationScore = getRuleActivationScore(r, a, b);
          if (activationScore <= 0.15) return null;
          return {
            ...r,
            activationScore,
            tunedPriority: getTunedPriority(r),
          };
        }).filter(Boolean);
      }

      function calcSectionScores(firedRules) {
        const result = {};
        Object.keys(SECTION_WEIGHT).forEach(
          (s) => (result[s] = { sum: 0, cnt: 0 })
        );
        firedRules.forEach((r) => {
          if (result[r.section]) {
            result[r.section].sum += r.tunedPriority * r.activationScore;
            result[r.section].cnt += r.activationScore;
          }
        });
        const scores = {};
        Object.keys(result).forEach((s) => {
          scores[s] = result[s].cnt
            ? Math.round(result[s].sum / result[s].cnt)
            : 50;
        });
        return scores;
      }

      function calcTotalFromSections(sectionScores) {
        let total = 0;
        Object.entries(SECTION_WEIGHT).forEach(([k, w]) => {
          total += sectionScores[k] * w;
        });
        return Math.round(total);
      }

      function generateSummary(score) {
        if (score >= 85)
          return "ì „ë°˜ì ìœ¼ë¡œ ê¶í•©ì´ ì•„ì£¼ ì¢‹ì•„. ê¸°ë³¸ ê²°ì´ ì˜ ë§ê³ , í•¨ê»˜í• ìˆ˜ë¡ ì•ˆì •ê°ì´ ì»¤ì ¸.";
        if (score >= 70)
          return "ì¢‹ì€ íë¦„ì´ì•¼. í¬ì¸íŠ¸ ëª‡ ê°€ì§€ë§Œ ë§ì¶”ë©´ ë” í¸ì•ˆí•´ì§ˆ ìˆ˜ ìˆì–´.";
        if (score >= 55)
          return "ì°¨ë¶„í•˜ê²Œ ë§ì¶°ê°€ë©´ ì¶©ë¶„íˆ ì¢‹ì€ ê´€ê³„ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆì–´.";
        return "ì§€ê¸ˆì€ ì¡°ìœ¨ì´ í•„ìš”í•œ êµ¬ê°„ì´ì•¼. ê¸°ì¤€ë§Œ ë§ì¶”ë©´ ê´€ê³„ê°€ ë” ë‹¨ë‹¨í•´ì§ˆ ìˆ˜ ìˆì–´.";
      }

      /* ======================================================
  6. ë¬¸êµ¬ ë³´ì •
====================================================== */
      function applyTone(text) {
        return softenText(text);
      }
      function toneExtraTip(section) {
        if (section === "money") {
          return "ì§€ì¶œ ê¸°ì¤€ì„ ë¨¼ì € ë§ì¶”ëŠ” ê²Œ í¸í•´.";
        }
        return "ê°ì • ì˜¬ë¼ì˜¤ë©´ í•œ ë°•ì ì‰¬ê³  ë§í•˜ì.";
      }

      /* ======================================================
  7. ì„¹ì…˜ ë ˆì´ë” ë Œë”
====================================================== */
      function renderRadar(scores) {
        const svg = sectionRadarSvg;
        const keys = ["ì„±í–¥", "ê´€ê³„", "ëˆ", "ì¼", "ê±´ê°•"];
        const cx = 160;
        const cy = 160;
        const R = 110;
        svg.innerHTML = "";

        const ang = (i) => ((Math.PI * 2) / 5) * i - Math.PI / 2;
        const pt = (v, i) => [
          cx + R * v * Math.cos(ang(i)),
          cy + R * v * Math.sin(ang(i)),
        ];
        const polyPoints = (arr, scale = 1) =>
          arr
            .map((v, i) =>
              pt(v * scale, i)
                .map((n) => n.toFixed(2))
                .join(",")
            )
            .join(" ");

        const el = (name, attrs = {}) => {
          const e = document.createElementNS(
            "http://www.w3.org/2000/svg",
            name
          );
          Object.entries(attrs).forEach(([k, v]) => e.setAttribute(k, v));
          return e;
        };

        for (let r = 1; r <= 4; r++) {
          svg.appendChild(
            el("polygon", {
              points: polyPoints([r / 4, r / 4, r / 4, r / 4, r / 4]),
              fill: "none",
              stroke: "rgba(15,23,42,0.14)",
              "stroke-width": "1",
            })
          );
        }

        keys.forEach((name, i) => {
          const [x, y] = pt(1, i);
          svg.appendChild(
            el("line", {
              x1: cx,
              y1: cy,
              x2: x,
              y2: y,
              stroke: "rgba(15,23,42,0.22)",
              "stroke-width": "1",
            })
          );
          const [lx, ly] = pt(1.18, i);
          const text = el("text", {
            x: lx,
            y: ly,
            "text-anchor": "middle",
            "dominant-baseline": "middle",
            "font-size": "13",
            "font-weight": "900",
            fill: "#0f172a",
          });
          text.textContent = name;
          svg.appendChild(text);
        });

        const vals = keys.map((k) => clamp01((scores[k] ?? 50) / 100));
        const poly = el("polygon", {
          points: polyPoints(vals, 0.02),
          fill: "rgba(37,99,235,0.28)",
          stroke: "rgba(37,99,235,0.9)",
          "stroke-width": "2",
          "stroke-linejoin": "round",
        });
        svg.appendChild(poly);

        let p = 0.02;
        function anim() {
          p += 0.05;
          if (p > 1) p = 1;
          poly.setAttribute("points", polyPoints(vals, p));
          if (p < 1) requestAnimationFrame(anim);
        }
        requestAnimationFrame(anim);
      }

      /* ======================================================
  8. ì‹ ë…„ìš´ì„¸ ì›”ë³„
====================================================== */
      function pickMonthlyCopy(ctx) {
        const { month, seasonElem, top, weak, relTop, relWeak, dayElem } = ctx;
        let mode = "steady";
        if (relTop === "ìƒ" || relTop === "ë™") mode = "push";
        if (relWeak === "ìƒ" || relWeak === "ë™")
          mode = mode === "push" ? "pushPlus" : "recover";
        if (relTop === "ê·¹" || relTop === "ëˆŒë¦¼") mode = "brake";

        const monthLabel = `${month}ì›”`;
        const templates = {
          push: [
            [
              `${monthLabel}ì€ ê¸¸ìš´ì´ ë¬¸í„±ì„ ë„˜ëŠ” ë‹¬ì´ì•¼. íë¦„ì´ ë‚´ í¸ì´ë‹ˆ ë°€ì–´ë¶™ì´ë©´ ì„±ê³¼ê°€ ë‚˜.`,
              "ê°€ì¥ ì¤‘ìš”í•œ ì¼ í•˜ë‚˜ë¥¼ ë¨¼ì € ëë‚´ê³ , ë‚˜ë¨¸ì§€ëŠ” ìˆœì„œë¥¼ ì¡ì•„ì•¼ í•´.",
              "ì‘ì€ ì„±ê³µì„ í¬ê²Œ í‚¤ìš¸ ìˆ˜ ìˆìœ¼ë‹ˆ ê¸°íšŒë¥¼ ë†“ì¹˜ì§€ ë§ì.",
              "ì„¸ìš´ì´ ë„ì›€ì„ ì£¼ëŠ” ë‹¬ì´ë‹ˆ ì›€ì§ì´ëŠ” ë§Œí¼ ì–»ìŒì´ ë”°ë¼ì™€.",
            ],
            [
              `${monthLabel}ì€ ì†ë„ê°€ ë¶™ëŠ” ë‹¬ì´ì•¼. ë¯¸ë£¨ë˜ ì¼ì„ ì²˜ë¦¬í•˜ê¸°ì— ë”± ì¢‹ì•„.`,
              "ì—°ë½/ê²°ì •/ì •ë¦¬ ì¤‘ í•˜ë‚˜ëŠ” ì´ë²ˆ ë‹¬ì— ëë‚´ê³ , ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì¤€ë¹„í•´.",
              "ë°œì´ ë¹ ë¥¼ìˆ˜ë¡ ìš´ì´ ë¶™ëŠ” ì‹œê¸°ì•¼.",
              "ê¸°íšŒê°€ ëˆˆì•ì— ìˆìœ¼ë‹ˆ ê³¼ê°í•˜ê²Œ ë‚˜ì„œë©´ ë³µì´ ë”°ë¼ì™€.",
            ],
          ],
          pushPlus: [
            [
              `${monthLabel}ì€ ì¢‹ì€ íë¦„ê³¼ íšŒë³µì´ í•¨ê»˜ ì˜¤ëŠ” ë‹¬ì´ì•¼.`,
              "ìš•ì‹¬ì„ ë‚´ì–´ë„ ë˜ì§€ë§Œ ìˆ˜ë©´ê³¼ ì‹ì‚¬ëŠ” ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•´.",
              "í˜ì´ ë¶™ìœ¼ë‹ˆ í°ì¼ë„ ì¶©ë¶„íˆ ê°ë‹¹í•  ìˆ˜ ìˆì–´.",
              "ì„¸ìš´ê³¼ ê¸°ìš´ì´ ë§ë¬¼ë ¤ ë¹ ë¥´ê²Œ í’€ë¦¬ëŠ” ë‹¬ì´ì•¼.",
            ],
            [
              `${monthLabel}ì€ ì˜ í’€ë¦¬ë©´ì„œ ë§ˆìŒì´ í¸í•´ì§€ëŠ” ë‹¬ì´ì•¼.`,
              "ìƒˆë¡œ ë²Œë¦¬ê¸°ë³´ë‹¤ ê¸°ì¡´ì„ ë‹¤ë“¬ìœ¼ë©´ í¬ê²Œ ë‚¨ì•„.",
              "ì‘ì€ ê°œì„ ì´ í° ë³µìœ¼ë¡œ ëŒì•„ì™€.",
              "ë„ì›€ì´ ì†ì— ë‹¿ëŠ” ë•Œë‹ˆ ì •ì„±ì„ ì•„ë¼ì§€ ë§ì.",
            ],
          ],
          recover: [
            [
              `${monthLabel}ì€ íšŒë³µì´ ê³§ ë³µì´ì•¼. ê¸°ë ¥ë§Œ ì¡ì•„ë„ ì¼ì´ í’€ë ¤.`,
              "ë¬´ë¦¬í•œ ì•½ì†ì„ ì¤„ì´ê³  ë£¨í‹´ í•˜ë‚˜ë¥¼ ë¶™ì—¬ì•¼ í•´.",
              "ì‰¬ì–´ê°€ëŠ” í•œ ë‹¬ì´ ì˜¤íˆë ¤ ê¸¸ìš´ì„ ë¶ˆëŸ¬ì™€.",
              "ì„¸ìš´ì´ ìˆ¨ ê³ ë¥´ê¸°ë¥¼ ìš”êµ¬í•˜ë‹ˆ ëª¸ê³¼ ë§ˆìŒì„ ë¨¼ì € ë‹¤ìŠ¤ë¦¬ì.",
            ],
            [
              `${monthLabel}ì€ ì •ë¦¬í•˜ë©´ ìš´ì´ ë¶™ëŠ” ë‹¬ì´ì•¼.`,
              "ê³µê°„/ëˆ/ì¼ì • ì¤‘ í•˜ë‚˜ë§Œ ì •ë¦¬í•´ë„ ì²´ê°ì´ ì™€.",
              "ì§€ìš°ê³  ëœì–´ë‚¼ìˆ˜ë¡ ê¸°ìš´ì´ ë§‘ì•„ì ¸.",
              "ì„¸ìš´ì´ ì •ë¦¬ìˆ˜ë¡œ íë¥´ë‹ˆ ëœì–´ë‚¼ìˆ˜ë¡ ì´ìµì´ì•¼.",
            ],
          ],
          brake: [
            [
              `${monthLabel}ì€ ë¬´ë¦¬í•˜ë©´ ì†í•´ ë³´ëŠ” ë‹¬ì´ì•¼. ì†ë„ë¥¼ ì¤„ì´ëŠ” ê²Œ ì´ë“ì´ì•¼.`,
              "í° ê²°ì •ì€ 2ì£¼ë§Œ ë¯¸ë£¨ê³  í™•ì¸ë¶€í„° í•´.",
              "ì„œë‘ë¥´ë©´ í‰ì´ ë˜ê³ , ë©ˆì¶”ë©´ ê¸¸ì´ ë¼.",
              "ì„¸ìš´ì´ ì œë™ì„ ê±°ë‹ˆ í•œ ê±¸ìŒ ë¬¼ëŸ¬ë‚˜ ì‚´í”¼ëŠ” ê²Œ ì¢‹ì•„.",
            ],
            [
              `${monthLabel}ì€ ì‹ ì¤‘ì´ ê³§ ëˆì´ì•¼.`,
              "ê³„ì•½/íˆ¬ì/ì¶©ë™êµ¬ë§¤ëŠ” í•œ ë²ˆ ë” ì ê²€í•´.",
              "ì§€í‚¤ëŠ” ìì—ê²Œ ë³µì´ ë¨¸ë¬¼ëŸ¬.",
              "ì„¸ìš´ì´ ê³¼ì—´ì„ ê²½ê³„í•˜ë‹ˆ ì¡°ì‹¬í•˜ëŠ” ê²Œ ê¸¸ì´ì•¼.",
            ],
          ],
          steady: [
            [
              `${monthLabel}ì€ ìœ ì§€ê°€ ì´ê¸°ëŠ” ë‹¬ì´ì•¼. ê¸°ë³¸ë§Œ ì§€ì¼œë„ ì¶©ë¶„í•´.`,
              "ë£¨í‹´ 3ê°œ(ìˆ˜ë©´/ì‹ì‚¬/ì •ë¦¬)ë§Œ ì±™ê¸°ë©´ ë¼.",
              "ì‘ì€ ì´ìµì„ ëª¨ì•„ í° ë³µìœ¼ë¡œ ë°”ê¿€ ì‹œê¸°ì•¼.",
              "ì„¸ìš´ì´ í‰ì˜¨í•˜ë‹ˆ ì„±ì‹¤ì´ ê³§ ë³µì´ì•¼.",
            ],
            [
              `${monthLabel}ì€ í° ë³€í™”ë³´ë‹¤ ì‘ì€ ê°œì„ ì´ ë§ì•„.`,
              "5% ê°œì„  ëª©í‘œë¡œ ê°€ë©´ ê¾¸ì¤€íˆ ì´ê²¨.",
              "ìš•ì‹¬ì„ ì¤„ì´ë©´ ì˜¤íˆë ¤ ì–»ìŒì´ ìˆì–´.",
              "ì„¸ìš´ì´ ì•ˆì •ì´ë‹ˆ ì‘ì€ ì„±ì‹¤ì´ í° ë³µì´ ë¼.",
            ],
          ],
        };

        const seed = `${month}|${seasonElem}|${top}|${weak}|${mode}`;
        const arr = templates[mode];
        const idx = hashToIndex(seed, arr.length);
        let [oneLine, tip, extra, detail] = arr[idx];
        oneLine = casualizeText(oneLine);
        tip = casualizeText(tip);
        extra = casualizeText(extra);
        detail = casualizeText(detail);
        let luckTag = "ì¤‘";
        if (dayElem) {
          const relDay = relationElem(seasonElem, dayElem);
          if (relDay === "ìƒ" || relDay === "ë™") luckTag = "ê¸¸";
          else if (relDay === "ê·¹" || relDay === "ëˆŒë¦¼") luckTag = "í‰";
          else luckTag = "ì¤‘";
        } else {
          luckTag =
            mode === "push" || mode === "pushPlus"
              ? "ê¸¸"
              : mode === "brake"
              ? "í‰"
              : "ì¤‘";
        }

        // ì›”ë³„ ìƒì„¸ ì„¤ëª… ìƒì„±
        const monthDetails = generateMonthDetails(
          month,
          seasonElem,
          mode,
          luckTag,
          dayElem
        );

        return {
          oneLine,
          tip,
          extra,
          detail,
          monthDetails,
          mode,
          luckTag,
          tags: [luckTag, mode, seasonElem],
        };
      }

      function generateMonthDetails(month, seasonElem, mode, luckTag, dayElem) {
        const monthLabels = [
          "",
          "1ì›”",
          "2ì›”",
          "3ì›”",
          "4ì›”",
          "5ì›”",
          "6ì›”",
          "7ì›”",
          "8ì›”",
          "9ì›”",
          "10ì›”",
          "11ì›”",
          "12ì›”",
        ];
        const monthLabel = monthLabels[month] || `${month}ì›”`;

        const templates = {
          push: {
            ê¸¸: [
              `${monthLabel} ê¸¸ìš´ê³¼ ì›”ì„±ì´ í•¨ê»˜ ë¬¸ì„ ë‘ë“œë¦¬ë‹ˆ ë§¨ì†ìœ¼ë¡œë„ ì„±ê³µí•  ê¸°ìš´ì´ì•¼. ê´€ë¡ì´ ë“¤ê¸° ì‹œì‘í•˜ë‹ˆ ì§€ìœ„ì™€ ì±…ì„ì„ ì–»ì–´ë„ ë¶€ì¡±í•¨ì´ ì—†ì–´. ìì†ì„ ì–»ì–´ì•¼ í•  ì‹œê¸°ë¼ë©´ ì¢‹ì€ ì†Œì‹ì´ ìˆì„ ê±°ê³ , ê°€ì¡± ì¤‘ì—ì„œë¼ë„ ìƒˆ ì‹êµ¬ì˜ ì‰íƒœë‚˜ í˜¼ì¸ ì†Œì‹ì´ ìˆì„ ê±°ì•¼. ì˜¬í•´ ìƒˆ ì‹êµ¬ë¥¼ ë§ì´í•˜ê²Œ ë˜ë©´ ì˜¨ ê°€ì¡±ì´ ê¸¸í•´ì§ˆ ê±°ë‹ˆ ê·€ì¸ìœ¼ë¡œ ë§ì´í•˜ì.`,
              `${monthLabel} ê¸°ìš´ì´ ì²­ì•„í•´ì„œ ë§Œë‚˜ëŠ” ì‚¬ëŒë§ˆë‹¤ ê¸°ì¨ì„ ì£¼ê²Œ ë¼. ì• ì •ë„ ì¢‹ê³  ê°€ì •ì— ê¸°ì¨ë„ ìˆê³  ìƒˆë¡œìš´ ì¼ë¡œ ì¸í•´ ë¶„ì£¼í•¨ë„ ìˆìœ¼ë‹ˆ ë‚˜ì  ì¼ì´ ì—†ì–´. ë‹¤ë§Œ ê±´ê°•ìƒì˜ ë¬¸ì œë¡œ ì”ë³‘ì„ ì¹˜ë¥¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ê³¼ë¡œë¥¼ ê²½ê³„í•˜ì. ì‹œì‘ì´ ì¢‹ìœ¼ë‹ˆ í•œ í•´ê°€ ì¢‹ìŒì„ ë¯¸ë¦¬ ì•Œë¦¬ëŠ” ì§•í›„ì•¼. ê·€ì¸ì„ ë§Œë‚˜ì„œ ì¬ë¬¼ì„ ì–»ì„ ìˆ˜ ìˆìœ¼ë‹ˆ í¬ì§€ëŠ” ì•Šì§€ë§Œ ìˆ˜ìµë„ ì¢‹ì€ ë‹¬ì´ì•¼.`,
            ],
            ì¤‘: [
              `${monthLabel} ê¸¸ìƒì˜ ê¸°ìš´ì´ ë“¤ì–´ ì•¡ìš´ì„ ë§‰ì•„ì£¼ê³  ë¹„ë¡œì†Œ ëœ»ì„ í¬ê²Œ í’ˆìœ¼ë‹ˆ ë¶„ì£¼í•¨ë„ ë§ê³  ë…¸ë ¥ë„ ë§ì•„ì ¸ì•¼ í•´. ë…¸ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì–»ì„ ê²Œ ì—†ìœ¼ë‹ˆ ì¤€ë¹„í•´ì•¼ í•  ì¼ì´ ìˆìœ¼ë©´ ë‚¨ì—ê²Œ ì˜íƒí•˜ì§€ ë§ê³  ì§ì ‘ ì›€ì§ì´ì. ì¸ì—°ì´ ì¢‹ì•„ì„œ ì›€ì§ì¼ìˆ˜ë¡ í¬ê²Œ ë„ì›€ë°›ì„ ì¼ì´ ìƒê²¨. ëŒ€ê¸¸ìš´ì´ ì„œì„œíˆ ë¬¸ì•ˆìœ¼ë¡œ ë“¤ì–´ì˜¤ê¸° ì‹œì‘í•˜ë‹ˆ ê¸°ìš´ì´ í™œê¸°ì°¬ ê±¸ ëŠë‚„ ìˆ˜ ìˆì„ ê±°ì•¼.`,
            ],
          },
          pushPlus: {
            ê¸¸: [
              `${monthLabel} ì• ì •ì´ ë§ì€ ì‹œê¸°ë‹ˆ ì‚¬ë‘ì„ ê¹Šì´ ìˆê²Œ í•˜ëŠ” ì‹œê¸°ì•¼. ê°€ì •ì´ ìˆìœ¼ë©´ ë‹¤ë¥¸ ì´ì„±ì—ê²Œ ëˆˆì´ ê°€ì§€ ì•Šë„ë¡ ì¡°ì‹¬í•˜ì. ë‚˜ì˜ ëˆˆë„ ì¢‹ì§€ë§Œ ìƒëŒ€ê°€ ë‚˜ë¥¼ ë°”ë¼ë³´ëŠ” ëˆˆë„ ì•„ë¦„ë‹¤ìš´ ì‹œê¸°ì•¼. ì¸ê¸°ê°€ ë§ê³  ìì‹ ì˜ ì¥ì ì´ ë¶€ê°ë˜ì–´ ë§ì€ ì‚¬ëŒë“¤ë¡œë¶€í„° ì¹­ì°¬ì„ ë“£ê²Œ ë¼. ì„ ë‚¨ì„ ë…€ë“¤ì€ ìƒˆë¡­ê²Œ ë§Œë‚˜ëŠ” ë§Œë‚¨ì´ë‚˜ ì—°ì¸ë“¤ê³¼ì˜ ë§Œë‚¨ì´ ëª¨ë‘ ì¢‹ì„ ê±°ë‹ˆ í”„ëŸ¬í¬ì¦ˆë¥¼ ë°›ê¸°ë„ í•˜ê³  í•˜ê¸°ë„ í•´. ì¢‹ì€ ê²°ê³¼ê°€ ìˆì„ ê±°ì•¼.`,
            ],
          },
          brake: {
            í‰: [
              `${monthLabel} ìš©ë§¹í•¨ì„ ë‹¤í•œ ë²”ì´ ë“¤íŒìœ¼ë¡œ ë‚˜ì„°ìœ¼ë‹ˆ ì‚¬ëƒ¥ê¾¼ì˜ ë¨¹ì´ë°–ì— ì•ˆ ë¼. ì˜ìš•ì´ ì•ì„œ ì‹¤ìˆ˜ë¥¼ ë²”í•  ìˆ˜ ìˆìœ¼ë‹ˆ ë§¤ì‚¬ ì‹ ì¤‘í•´ì•¼ í•´. ë‚˜ì„œì§€ ë§ê³  ëª¸ì„ ë‚®ì¶”ëŠ” ì§€í˜œë¥¼ ë°œíœ˜í•˜ë©´ í›„í™˜ì´ ì—†ì–´. ë™ë‚¨ìª½ ë°©í–¥ì´ ê¸¸ë°©ì´ë‹ˆ ì¬ë¬¼ì´ ë¨¸ë¬¸ ê³³ì´ì•¼. ê¸ˆë…„ì€ ë¶ìª½ì´ ê¸¸í•˜ì§€ë§Œ ì´ë²ˆ ë‹¬ë§Œí¼ì€ ë™ë‚¨ìª½ì´ ê¸¸í•œ ë°©í–¥ì´ì•¼. ìì¤‘í•˜ë©´ ìƒì„ ê²Œ ì—†ìœ¼ë‹ˆ ë‹¤ìŒì„ ê¸°ì•½í•´ë„ ëŠ¦ì§€ ì•Šì•„.`,
              `${monthLabel} ìì‹ ì˜ ì¬ë¬¼ì„ ì£¼ë¨¸ë‹ˆ ê¹Šì´ ë„£ì–´ë‘ì§€ ì•Šìœ¼ë©´ ë°˜ë“œì‹œ ì´ë¥¼ ë…¸ë¦¬ëŠ” ì‚¬ëŒì´ ìˆì–´. ë‹¤ë¥¸ ì‚¬ëŒê³¼ ì¬ë¬¼ì— ê´€í•œ ê±°ë˜ë¥¼ ì ˆëŒ€ë¡œ í•˜ì§€ ë§ì. ê°€ì¡± ì¤‘ì— í™˜ìê°€ ìƒê¸¸ ê±°ë‹ˆ ê·¼ì‹¬ì´ ìƒê¸°ëŠ” ë‹¬ì´ì•¼. ì´ë²ˆ ë‹¬ì´ í° ê³ ë¹„ì¸ë° ìƒˆë¡­ê²Œ ì¼ì„ í™•ì¥í•˜ë©´ í•´ê²°ì˜ ì‹¤ë§ˆë¦¬ê°€ ë³´ì´ì§€ ì•Šìœ¼ë‹ˆ ë•Œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì§€í˜œë¥¼ ë§ì´ ë°œíœ˜í•´ì•¼ í•´. ì‰¬ì–´ê°€ëŠ” ê²Œ ê²°ì½” ëŠ¦ì§€ ì•Šì•„.`,
              `${monthLabel} ì„œì‚°ì— í•´ëŠ” ì§€ëŠ”ë° ê°ˆ ê¸¸ì€ ë©€ê³ , ì “ê°€ë½ ë†€ë¦¬ë“¯ ë°”ì˜ê¸°ë§Œ í•œ ë°œê±¸ìŒê³¼ ê°™ì•„. ë‘ ì‚¬ëŒì˜ ë§ˆìŒì´ ì„œë¡œ ë‹¤ë¥´ë‹ˆ í•˜ëŠ” ì¼ì„ ëë‚´ ì´ë£¨ì§€ ëª»í•´. ë§ˆìŒì´ ë¬¸ì œì¸ë° ë¬¸ì œëŠ” ìš•ì‹¬ì´ì•¼. ì†í•´ë¥¼ ë³´ê±°ë‚˜ ë‹¤íˆ¼ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•˜ë˜ ë§¤ì‚¬ì— ëª©ì„±(æœ¨å§“)ì„ ê°€ê¹Œì´í•˜ì§€ ë§ì. í•´ëŠ” ì¤‘í„±ìœ¼ë¡œ ë„˜ì–´ì„œê³  ê°ˆ ê¸¸ì€ ë¨¼ë° ë„˜ì–´ì•¼ í•  ê³ ê°œëŠ” ì•„ì§ë„ ë©€ë¦¬ ìˆì–´. ë‘ ì‚¬ëŒì˜ ë§ˆìŒì´ ì„œë¡œ ë‹¤ë¥´ë‹ˆ ì´ê²ƒì´ ë§ˆì§€ë§‰ ì–´ë ¤ì›€ì´ ë  ë“¯í•´. ìš•ì‹¬ì„ ë²„ë ¤ì•¼ í•˜ëŠ”ë° ì´ ë˜í•œ ì‰½ì§€ ì•Šì•„.`,
            ],
            ì¤‘: [
              `${monthLabel} í‰í•¨ì´ ë³€í•˜ì—¬ ê¸¸í•¨ì´ ë˜ë‹ˆ ì„¸ìƒì¼ì´ íƒœí‰í•˜ê³  ë§ˆìŒì´ í‰ì•ˆí•œ ì‹œê¸°ì•¼. ëª¨ì²˜ëŸ¼ ê·¼ì‹¬ ê±±ì •ì´ ì‚¬ë¼ì§€ë‹ˆ ìƒˆë¡œìš´ ê³„íšì„ ì„¸ìš°ê¸°ì— ì¢‹ì•„. ê·¸ëŸ¬ë‚˜ ì„œë‘ë¥´ë©´ í•´ê°€ ë˜ë‹ˆ ê²½ê±°ë§ë™í•´ì„œ ì™¸ë¶€ë¡œ ë°”ì˜ê²Œ ëŒë©´ ì†ì‹¤ì´ ìˆì–´. ë§ˆì§€ë§‰ í’íŒŒê°€ í•œ ë²ˆì€ ë” ìˆì„ ê±°ë‹ˆ ê¸¸í•˜ë‹¤ê³  í•´ì„œ ë§ˆìŒì„ ë†“ìœ¼ë©´ ì•ˆ ë¼. ì§‘ì•ˆì— ìˆì–´ì„œ ìƒˆë¡œìš´ ê³„íšì„ ì„¸ìš°ë©´ í›„ì¼ì´ ë”ìš± ì¢‹ìœ¼ë‹ˆ ëª…ì‹¬í•˜ì.`,
            ],
          },
          recover: {
            ì¤‘: [
              `${monthLabel} í•˜ëŠ˜ê³¼ ë•…ì´ ì„œë¡œ í™”í•©í•´ì„œ ê·¸ ì´ìµì´ ì¬ë¬¼ì´ë‚˜ ì¼ë¡œ ìƒê¸¸ ìš´ì„¸ì•¼. ì‘ì€ ê±¸ ë²„ë ¤ í° ê±¸ ì·¨í•˜ëŠ” ìš´ì„¸ë‹ˆ ê¸°ì¡´ ê±´ ìŠì–´ë²„ë ¤ë„ ë¼. ìƒˆë¡œ íˆ¬ìí•˜ëŠ” ë¶€ë¶„ì€ ì•„ì§ ì„œë‘˜ëŸ¬ì„  ì•ˆ ë¼. ë§¤ì‚¬ê°€ ì¢‹ìŒì´ ë” ë§ìœ¼ë‹ˆ ì†ìµì„ ë”°ì§€ë©´ ë°˜ë“œì‹œ ì–»ìŒì´ í´ ê±°ì§€ë§Œ ì‹ ê·œë¡œ ì¬ë¬¼ì„ ë“¤ì—¬ ì–»ëŠ” ê±´ ìœ„í—˜ìˆ˜ê°€ ìˆìœ¼ë‹ˆ ìì¤‘ì´ í•„ìš”í•´. ì„œìª½ìœ¼ë¡œ ê°€ë©´ ë¶ˆë¦¬í•˜ë‹ˆ ì„œìª½ ë°©í–¥ìœ¼ë¡œ ì›€ì§ì´ëŠ” ì¼ì€ ê²½ê³„í•˜ê³  í”¼í•˜ì.`,
              `${monthLabel} ë§ˆë¥¸ ìƒ˜ì— ë¹„ê°€ ë‚´ë¦¬ëŠ” í˜•êµ­ì´ì•¼. ë¹„ë¡œì†Œ ë§‰í˜”ë˜ ì¼ì´ í’€ë¦¬ê³  ì‹œì›í•¨ì„ ëŠë¼ê²Œ ë˜ëŠ” ë‹¬ì´ì•¼. ë¬¸ì œê°€ ëë˜ ê±´ í•´ê²°ì˜ ì‹¤ë§ˆë¦¬ê°€ ë³´ì´ëŠ” ì‹œê¸°ì•¼. í•œ í•´ì˜ ì‹œì‘ì´ ì¼ ë…„ì„ ì¢Œìš°í•˜ëŠ”ë° ì˜¬í•´ëŠ” ì¼ì´ ì˜ í’€ë¦´ ì§•ì¡°ê°€ ë³´ì—¬. ìì‹ ì˜ ìœ„ì¹˜ì™€ ì§€ìœ„ê°€ í¬ê²Œ í–¥ìƒë˜ì–´ ëœ»í•œ ë°”ë¥¼ ì‹¤í–‰ì— ì˜®ê¸¸ ì¤€ë¹„ê°€ ê°–ì¶°ì ¸. ì¢‹ì€ ì¸ì—°ë„ ë§Œë‚˜ëŠ” ì‹œê¸°ë‹ˆ ëŒ€ì¸ì ì¸ êµë¥˜ê°€ ë§ì•„ì§ˆ ê±°ì•¼.`,
              `${monthLabel} ì£¼ë³€ì— ì—­ë§ˆê°€ ë¼ì–´ ë‚˜ë¥¼ ê´´ë¡­íˆëŠ” ìê°€ ìˆìœ¼ë‹ˆ ì¬ë¬¼ì´ ë‚˜ê°€ì§€ ì•Šìœ¼ë‚˜ ë§ˆìŒì´ ìƒí•  ê¸°ìš´ì´ ìˆì–´. ê°€ê¹Œìš´ ë²—ì´ ë‚˜ë¥¼ ì˜ì§€í•˜ë‹ˆ ë•ì§€ ì•Šìœ¼ë©´ ì•ˆ ë˜ëŠ” ì¼ì´ ìƒê²¨. ë§ˆìŒì„ í¬ê²Œ ë¨¹ê³  ì§„ì‹¬ìœ¼ë¡œ ë„ìš°ë©´ ì¹œêµ¬ë„ ì¢‹ê³  ë‚˜ë„ ì¢‹ì€ ì¼ì´ í›„ì— ìˆì„ ê±°ì•¼. ìŒë•ìœ¼ë¡œ ìŒ“ì•„ í›„ì¼ì˜ ê¸°ì¨ìœ¼ë¡œ ì‚¼ê³ ì í•˜ë©´ ì•¡ìš´ì€ ì•„ë‹ˆë‹ˆ ë•ì„ ìŒ“ëŠ” ì‹œê¸°ë¡œ ì‚¼ê³  ìì‹ ì˜ ê²ƒë³´ë‹¤ëŠ” í›„ì¼ì˜ ë•ì„ ìƒê°í•˜ë©° ë³´ë‚´ì. ë¨¸ì§€ì•Šì•„ í° ê¸°ì¨ì´ ì˜¬ ê±°ì•¼.`,
              `${monthLabel} ìƒí•˜ê°€ í™”ëª©í•´ì„œ ì§‘ì•ˆì— ë¬¸ì œê°€ ì—†ì–´. í™”ëª©ì´ ê³§ ê¸¸ìš´ì˜ ì‹œì‘ì´ë‹ˆ ê°€ì¡± ì¤‘ì— ê·¼ì‹¬ ìˆëŠ” ìì˜ ê³ ë¯¼ì´ ì‚¬ë¼ì§ˆ ê±°ì•¼. í™©ë£¡ì´ êµ¬ìŠ¬ì„ ê°€ì§€ê³  ë…¸ëŠ” ê´˜ë¥¼ ì–»ì—ˆìœ¼ë‹ˆ ê³§ ì´ë£¨ê³ ì í•˜ëŠ” ê±¸ ì´ë£° ìˆ˜ ìˆì„ ê±°ì•¼. ë‹¤ë§Œ ë•Œê°€ ì•„ë‹˜ì´ ì•„ì‰¬ì›€ìœ¼ë¡œ ë‚¨ìœ¼ë‹ˆ ì„œë‘˜ëŸ¬ ì¼ì„ ì‹¤ì²œì— ì˜®ê¸°ëŠ” ì¼ì€ ì—†ë„ë¡ í•˜ì. ì¤€ë¹„ë¥¼ í•¨ì— ë§Œì „ì„ ê¸°í•´ì•¼ í•¨ì„ ìŠì§€ ë§ì.`,
            ],
          },
          steady: {
            ì¤‘: [
              `${monthLabel} ìœ ì§€ê°€ ì´ê¸°ëŠ” ë‹¬ì´ì•¼. ê¸°ë³¸ë§Œ ì§€ì¼œë„ ì¶©ë¶„í•´. ë£¨í‹´ 3ê°œ(ìˆ˜ë©´/ì‹ì‚¬/ì •ë¦¬)ë§Œ ì±™ê¸°ë©´ ë¼. ì‘ì€ ì´ìµì„ ëª¨ì•„ í° ë³µìœ¼ë¡œ ë°”ê¿€ ì‹œê¸°ì•¼. ì„¸ìš´ì´ í‰ì˜¨í•˜ë‹ˆ ì„±ì‹¤ì´ ê³§ ë³µì´ì•¼.`,
              `${monthLabel} í° ë³€í™”ë³´ë‹¤ ì‘ì€ ê°œì„ ì´ ë§ì•„. 5% ê°œì„  ëª©í‘œë¡œ ê°€ë©´ ê¾¸ì¤€íˆ ì´ê²¨. ìš•ì‹¬ì„ ì¤„ì´ë©´ ì˜¤íˆë ¤ ì–»ìŒì´ ìˆì–´. ì„¸ìš´ì´ ì•ˆì •ì´ë‹ˆ ì‘ì€ ì„±ì‹¤ì´ í° ë³µì´ ë¼.`,
            ],
          },
        };

        const modeTemplates = templates[mode] || templates.steady;
        const luckTemplates =
          modeTemplates[luckTag] ||
          modeTemplates.ì¤‘ ||
          modeTemplates[Object.keys(modeTemplates)[0]];
        const seed = `${month}|${seasonElem}|${mode}|${luckTag}`;
        const idx = hashToIndex(seed, luckTemplates.length);
        return casualizeText(luckTemplates[idx] || "");
      }

      function makeMonthlyLuck(person) {
        const { top, weak } = getTopWeak(person.elements);
        const dayElem = person.dayElem || "";
        const months = [];
        for (let m = 1; m <= 12; m++) {
          const flow = MONTH_FLOW[m];
          const s = flow.seasonTop;
          const relTop = relationElem(top, s);
          const relWeak = relationElem(weak, s);
          const { oneLine, tip, extra, detail, monthDetails, tags } =
            pickMonthlyCopy({
              month: m,
              seasonElem: s,
              top,
              weak,
              relTop,
              relWeak,
              dayElem,
            });
          months.push({
            month: m,
            seasonElem: s,
            monthBranch: flow.monthBranch,
            summary: oneLine,
            tip,
            extra,
            detail,
            monthDetails,
            tags,
          });
        }
        return months;
      }

      function renderMonthly(person) {
        const t = window.t || ((key, vars = {}) => key);
        monthlyList.innerHTML = makeMonthlyLuck(person)
          .map(
            (m) => `
            <div class="rule-card">
              <div class="row" style="justify-content: space-between; align-items: center;">
                <div class="section-title">${t("monthlyFlow", { month: m.month, seasonElem: m.seasonElem })}</div>
                <div style="margin-left: auto; display: flex; align-items: center; justify-content: flex-end; gap: 6px; flex-wrap: wrap;">${formatMonthTags(
                  m.tags
                )}</div>
              </div>
              <p class="lead" style="font-size: 17px; line-height: 1.6;">${escapeHtml(
                m.summary
              )}</p>
              ${
                m.monthDetails
                  ? `<div style="margin-top: 16px; padding: 14px; background: rgba(99, 102, 241, 0.05); border-radius: 8px; border-left: 3px solid var(--accent);">
                      <p style="font-size: 15px; line-height: 1.9; margin: 0; color: rgba(15, 23, 42, 0.85);">${escapeHtml(
                        m.monthDetails
                      )}</p>
                    </div>`
                  : ""
              }
              ${
                m.extra
                  ? `<div style="margin-top: 12px; padding: 12px; background: rgba(255, 255, 255, 0.5); border-radius: 6px;">
                     <p style="font-size: 14px; margin: 0; line-height: 1.8; color: rgba(15, 23, 42, 0.8);">${escapeHtml(
                       m.extra
                     )}</p>
                   </div>`
                  : ""
              }
              ${
                m.detail
                  ? `<div style="margin-top: 12px; padding: 12px; background: rgba(255, 255, 255, 0.5); border-radius: 6px;">
                     <p style="font-size: 14px; margin: 0; line-height: 1.8; color: rgba(15, 23, 42, 0.8);">${escapeHtml(
                       m.detail
                     )}</p>
                   </div>`
                  : ""
              }
              ${
                m.tip
                  ? `<div style="margin-top: 12px; padding: 12px; background: rgba(34, 197, 94, 0.08); border-radius: 6px; border-left: 3px solid rgba(34, 197, 94, 0.5);">
                     <p style="font-size: 14px; margin: 0; line-height: 1.8; font-weight: 600; color: rgba(15, 23, 42, 0.9);">
                       <span style="color: rgba(34, 197, 94, 0.9);">${t("monthlyTip")}</span> ${escapeHtml(
                         m.tip
                       )}
                     </p>
                   </div>`
                  : ""
              }
              <div style="margin-top: 16px; display: flex; justify-content: flex-end;">
                <button class="btn compact" data-month="${
                  m.month
                }" data-month-index="${
              m.month - 1
            }" style="font-size: 12px; padding: 6px 12px;">
                  ${t("btnShareMonthly")}
                </button>
              </div>
            </div>`
          )
          .join("");

        // ê³µìœ  ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        setTimeout(() => {
          monthlyList.querySelectorAll("[data-month]").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const monthIndex = parseInt(btn.getAttribute("data-month-index"));
              const monthData = makeMonthlyLuck(person)[monthIndex];
              await shareMonthlyCard(monthData);
            });
          });
        }, 100);
      }

      async function shareMonthlyCard(monthData) {
        const monthLabels = [
          "",
          "1ì›”",
          "2ì›”",
          "3ì›”",
          "4ì›”",
          "5ì›”",
          "6ì›”",
          "7ì›”",
          "8ì›”",
          "9ì›”",
          "10ì›”",
          "11ì›”",
          "12ì›”",
        ];
        const monthLabel =
          monthLabels[monthData.month] || `${monthData.month}ì›”`;

        const t = window.t || ((key, vars = {}) => key);
        const lang = window.currentLang || "ko";
        // íƒœê·¸ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        const [luckTag, mode, seasonElem] = monthData.tags || [];
        const luckText =
          luckTag === "ê¸¸" ? t("luckGood") : luckTag === "í‰" ? t("luckBad") : t("luckNeutral");
        const modeText = monthModeText(mode);
        const tagsText = `${luckText} Â· ${modeText} Â· ${t("luckEnergy", { elem: seasonElem })}`;

        let details = "";
        if (monthData.monthDetails) details += `${monthData.monthDetails}\n\n`;
        if (monthData.extra) details += `${monthData.extra}\n\n`;
        if (monthData.detail) details += `${monthData.detail}\n\n`;
        if (monthData.tip) details += `${t("monthlyTip")} ${monthData.tip}\n\n`;

        let text;
        if (lang === "en") {
          text = t("monthlyShareText", {
            monthLabel: monthLabel,
            summary: monthData.summary,
            details: details,
            tags: tagsText
          });
        } else {
          text = `ğŸ”® ${monthLabel} ìš´ì„¸\n\n`;
          text += `${monthData.summary}\n\n`;
          text += details;
          text += `íƒœê·¸: ${tagsText}\n`;
          text += `\n#ì‚¬ì£¼í’€ì´ #ì‹ ë…„ìš´ì„¸ #${monthLabel}ìš´ì„¸\n\n`;
          text += `ğŸ”® ì‚¬ì£¼í’€ì´ ì„œë¹„ìŠ¤: https://saju.funnyfunny.cloud/`;
        }

        try {
          await navigator.clipboard.writeText(text);
          alert(t("monthlyShareCopied", { monthLabel }));
        } catch (err) {
          // í´ë¦½ë³´ë“œ APIê°€ ì—†ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš°
          const textarea = document.createElement("textarea");
          textarea.value = text;
          textarea.style.position = "fixed";
          textarea.style.opacity = "0";
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand("copy");
            alert(t("monthlyShareCopied", { monthLabel }));
          } catch (e) {
            prompt(lang === "en" ? "Copy content:" : "ë³µì‚¬í•  ë‚´ìš©:", text);
          }
          document.body.removeChild(textarea);
        }
      }

      /* ======================================================
  9. ë Œë”
====================================================== */
      function renderSummary(totalScore, firedRules, toneKey, coupleElements) {
        const t = window.t || ((key, vars = {}) => key);
        const lang = window.currentLang || "ko";
        const summary = generateSummary(totalScore);
        totalScoreEl.textContent = lang === "en" ? `${totalScore} points` : `${totalScore}ì `;
        summaryMain.textContent = softenText(summary);
        summarySub.textContent = t("summarySub");

        const { top, weak } = getTopWeak(coupleElements);
        const pills = [
          t("summaryPillCore", { top }),
          t("summaryPillWeak", { weak }),
          t("summaryPillRules", { count: firedRules.length }),
        ];
        summaryPills.innerHTML = pills
          .map((p) => `<span class="pill">${escapeHtml(p)}</span>`)
          .join("");
      }

      function renderRules(firedRules, toneKey, tokens) {
        const t = window.t || ((key, vars = {}) => key);
        if (!firedRules.length) {
          ruleList.innerHTML = `<p class="mini">${t("ruleNoRules")}</p>`;
          return;
        }
        const ruleLabel = (id) => {
          const map = {
            ELEM_TOP_SAME: "í•µì‹¬ ì˜¤í–‰ ë™ì¼",
            ELEM_TOP_COMPLEMENT: "í•µì‹¬ ì˜¤í–‰ ìƒìƒ",
            ELEM_TOP_CLASH: "í•µì‹¬ ì˜¤í–‰ ìƒê·¹",
            ELEM_WEAK_SAME: "ì•½í•œ ì˜¤í–‰ ë™ì¼",
            ELEM_WEAK_COMPLEMENT: "ì•½í•œ ì˜¤í–‰ ë³´ì™„",
            ELEM_WEAK_CLASH: "ì•½í•œ ì˜¤í–‰ ì¶©ëŒ",
            ELEM_BALANCE_GOOD: "ê· í˜• ì•ˆì •",
            ELEM_BALANCE_BAD: "ê· í˜• ë¶ˆì•ˆ",
            A_DOMINANT: "A ì£¼ë„ ì„±í–¥",
            B_DOMINANT: "B ì£¼ë„ ì„±í–¥",
            SEASON_SUPPORT: "ì›”ë ¹ ë³´ê°•",
            SEASON_CLASH: "ì›”ë ¹ ì¶©ëŒ",
            SEASON_SAME: "ì›”ë ¹ ë™ì¼",
            BOTH_STRONG_MOK: "ë‘˜ ë‹¤ ëª© ê°•",
            BOTH_STRONG_HWA: "ë‘˜ ë‹¤ í™” ê°•",
            BOTH_STRONG_TO: "ë‘˜ ë‹¤ í†  ê°•",
            BOTH_STRONG_GEUM: "ë‘˜ ë‹¤ ê¸ˆ ê°•",
            BOTH_STRONG_SU: "ë‘˜ ë‹¤ ìˆ˜ ê°•",
            BOTH_WEAK_MOK: "ë‘˜ ë‹¤ ëª© ì•½",
            BOTH_WEAK_HWA: "ë‘˜ ë‹¤ í™” ì•½",
            BOTH_WEAK_TO: "ë‘˜ ë‹¤ í†  ì•½",
            BOTH_WEAK_GEUM: "ë‘˜ ë‹¤ ê¸ˆ ì•½",
            BOTH_WEAK_SU: "ë‘˜ ë‹¤ ìˆ˜ ì•½",
            A_STRONG_MOK: "A ëª© ê°• / B ëª© ì•½",
            A_STRONG_HWA: "A í™” ê°• / B í™” ì•½",
            A_STRONG_TO: "A í†  ê°• / B í†  ì•½",
            A_STRONG_GEUM: "A ê¸ˆ ê°• / B ê¸ˆ ì•½",
            A_STRONG_SU: "A ìˆ˜ ê°• / B ìˆ˜ ì•½",
            B_STRONG_MOK: "B ëª© ê°• / A ëª© ì•½",
            B_STRONG_HWA: "B í™” ê°• / A í™” ì•½",
            B_STRONG_TO: "B í†  ê°• / A í†  ì•½",
            B_STRONG_GEUM: "B ê¸ˆ ê°• / A ê¸ˆ ì•½",
            B_STRONG_SU: "B ìˆ˜ ê°• / A ìˆ˜ ì•½",
          };
          return map[id] || id;
        };

        ruleList.innerHTML = firedRules
          .sort(
            (a, b) =>
              b.tunedPriority * b.activationScore -
              a.tunedPriority * a.activationScore
          )
          .map((r) => {
            const evidence = applyTone(fillTokens(r.evidence, tokens));
            const copy = applyTone(r.copies[0]);
            const copy2 = r.copies[1] ? applyTone(r.copies[1]) : "";
            const extra =
              r.section === "ëˆ"
                ? toneExtraTip("money")
                : toneExtraTip("conflict");
            const t = window.t || ((key, vars = {}) => key);
            const strength = Math.round(r.activationScore * 100);
            const insight =
              r.section === "ëˆ"
                ? t("ruleInsightMoney")
                : r.section === "ê±´ê°•"
                ? t("ruleInsightHealth")
                : r.section === "ì¼"
                ? "ì†ë„ë³´ë‹¤ ë°©í–¥ ì •ë ¬ì´ ì„±ê³¼ë¥¼ ë§Œë“ ë‹¤."
                : r.section === "ê´€ê³„"
                ? "ê°ì • ê³¡ì„ ì„ ë§ì¶”ë©´ ì¶©ëŒì´ ì¤„ì–´ë“ ë‹¤."
                : "ê¸°ì§ˆì˜ ì°¨ì´ë¥¼ ì¸ì •í• ìˆ˜ë¡ í¸í•´ì§„ë‹¤.";
            return `
            <div class="rule-card">
              <div class="rule-head">
                <b>${escapeHtml(ruleLabel(r.id))}</b>
              </div>
              <p class="mini">ê·¼ê±°: ${escapeHtml(
                evidence
              )} Â· ê°•ë„ ${strength}%</p>
              <p>${escapeHtml(copy)}${
              extra
                ? `<br/><span class="mini">+ ${escapeHtml(extra)}</span>`
                : ""
            }${
              copy2
                ? `<br/><span class="mini">+ ${escapeHtml(copy2)}</span>`
                : ""
            }</p>
              <p class="mini">í•´ì„: ${escapeHtml(insight)}</p>
            </div>`;
          })
          .join("");
      }

      function renderPillars(targetEl, result) {
        if (!result) {
          targetEl.textContent = "â€”";
          return;
        }
        const p = result.pillars;
        const tzText = formatTzOffset(result.input.tzOffsetMinutes);
        const hourText = p.hour ? p.hour.text : "ë¯¸í¬í•¨";
        targetEl.innerHTML = `ì…ë ¥: ${result.input.local} (UTC${tzText})<br/>
          ì—°: ${p.year.text} / ì›”: ${p.month.text}<br/>
          ì¼: ${p.day.text} / ì‹œ: ${hourText}`;
      }

      function formatElemLine(prefix, obj, totalSum = null) {
        const order = ["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"];
        const lead = prefix ? `${prefix} ` : "";
        return `${lead}${order
          .map((k) => {
            const v = Math.round((obj[k] || 0) * 10) / 10;
            if (!totalSum) return `${k} ${v}`;
            const p = Math.round(((obj[k] || 0) / totalSum) * 1000) / 10;
            return `${k} ${v}(${p}%)`;
          })
          .join(" Â· ")}`;
      }

      function makeElementProfile(elements) {
        const order = ["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"];
        const total = order.reduce((s, k) => s + (elements[k] || 0), 0);
        const avg = total / 5;
        const strong = [];
        const mid = [];
        const weak = [];
        order.forEach((k) => {
          const v = elements[k] || 0;
          const ratio = avg ? v / avg : 1;
          if (ratio >= 1.2) strong.push(k);
          else if (ratio <= 0.8) weak.push(k);
          else mid.push(k);
        });
        return {
          strong: strong.length ? strong.join(" Â· ") : "â€”",
          mid: mid.length ? mid.join(" Â· ") : "â€”",
          weak: weak.length ? weak.join(" Â· ") : "â€”",
          avg: Math.round(avg * 10) / 10,
        };
      }

      function makeElementEvidence(elements, breakdown, top, low) {
        if (!breakdown) return "";
        const sum = (obj, key) => Math.round((obj?.[key] || 0) * 10) / 10;
        const format = (elem) =>
          `${elem} ${Math.round((elements[elem] || 0) * 10) / 10} = ì²œê°„ ${sum(
            breakdown.stems,
            elem
          )} Â· ì§€ì§€ ${sum(breakdown.branches, elem)} Â· ì¥ê°„ ${sum(
            breakdown.hidden,
            elem
          )} Â· ì›”ë ¹ ${sum(breakdown.season, elem)}`;
        return `${format(top)} / ì•½í•œ ${format(low)}`;
      }

      function elementDeltaLines(elements) {
        const order = ["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"];
        const total = order.reduce((s, k) => s + (elements[k] || 0), 0);
        const avg = total / 5;
        return order
          .map((k) => {
            const v = Math.round((elements[k] || 0) * 10) / 10;
            const diff = Math.round((v - avg) * 10) / 10;
            const sign = diff >= 0 ? "+" : "";
            return `${k} ${v} (${sign}${diff})`;
          })
          .join(" Â· ");
      }

      function elementAdvice(profile) {
        const lines = [];
        if (profile.strong !== "â€”") {
          lines.push(
            `ê°•í•œ ì˜¤í–‰ í™œìš©: ${profile.strong} ìª½ì„ ë©”ì¸ ì¶•ìœ¼ë¡œ ë°€ë©´ íš¨ìœ¨ì´ ì¢‹ì•„.`
          );
        }
        if (profile.mid !== "â€”") {
          lines.push(
            `ì¤‘ê°„ ì˜¤í–‰ ì¡°ìœ¨: ${profile.mid} ìª½ì´ ì™„ì¶© ì—­í• ì´ë¼ ë°¸ëŸ°ìŠ¤ë¥¼ ì¡ì•„ì¤˜.`
          );
        }
        if (profile.weak !== "â€”") {
          lines.push(
            `ì•½í•œ ì˜¤í–‰ ë³´ì™„: ${profile.weak} ìª½ì€ ìƒí™œ ë£¨í‹´/í™˜ê²½ìœ¼ë¡œ ì±„ìš°ë©´ ì²´ê°ì´ ì»¤.`
          );
        }
        return lines;
      }
      function getElementProsCons(topElem, lowElem) {
        const pros = {
          ëª©: "ê¸°íš/ì„±ì¥ì— ê°•ì ì´ ìˆì–´ íë¦„ì„ ê¸¸ê²Œ ë³´ëŠ” ëˆˆì´ ì¢‹ì•„.",
          í™”: "ì¶”ì§„/í‘œí˜„ì— ê°•ì ì´ ìˆì–´ ì†ë„ì™€ ì—ë„ˆì§€ê°€ ì˜ ë¶™ì–´.",
          í† : "ì•ˆì •/ê´€ë¦¬ì— ê°•ì ì´ ìˆì–´ ê¸°ë°˜ì„ ë‹¨ë‹¨íˆ ë‹¤ì§€ëŠ” í˜ì´ ìˆì–´.",
          ê¸ˆ: "ê²°ê³¼/ì •ë¦¬ì— ê°•ì ì´ ìˆì–´ ë§ˆë¬´ë¦¬ì™€ ì„±ê³¼ ì²´ê°ì´ ë¹ ë¥¸ í¸ì´ì•¼.",
          ìˆ˜: "ì •ë³´/í™˜ê²½ì— ê°•ì ì´ ìˆì–´ ë³€í™”ì— ìœ ì—°í•˜ê²Œ ëŒ€ì‘í•´.",
        };
        const cons = {
          ëª©: "ê¸°íšì— ì¹˜ìš°ì¹˜ë©´ ì‹¤í–‰ì´ ëŠë ¤ì§ˆ ìˆ˜ ìˆì–´. ì‘ê²Œë¼ë„ ë°”ë¡œ ì›€ì§ì´ë©´ ì¢‹ì•„.",
          í™”: "ì†ë„ê°€ ë¹ ë¥¸ ë§Œí¼ ê³¼ì—´ë˜ê¸° ì‰¬ì›Œ. í˜ì´ìŠ¤ ì¡°ì ˆì´ ì„±ê³¼ë¥¼ ì§€ì¼œì¤˜.",
          í† : "ì•ˆì •ì´ ê°•í•˜ë©´ ë³€í™” ëŒ€ì‘ì´ ëŠë¦´ ìˆ˜ ìˆì–´. ì‘ì€ ë³€í™”ë¶€í„° ì—´ì–´ë‘ë©´ ì¢‹ì•„.",
          ê¸ˆ: "ì„±ê³¼ ì¤‘ì‹¬ì´ ê°•í•˜ë©´ ì••ë°•ì´ ì»¤ì§ˆ ìˆ˜ ìˆì–´. ê³¼ì •ì„ ì¦ê¸°ë©´ ë” ê¸¸ê²Œ ê°„ë‹¤.",
          ìˆ˜: "ìœ ì—°í•¨ì´ í° ë§Œí¼ ê¸°ì¤€ì´ íë ¤ì§ˆ ìˆ˜ ìˆì–´. ê¸°ì¤€ì„ ë¨¼ì € ì¡ì•„ë‘ë©´ ì¢‹ì•„.",
        };
        const prosText =
          pros[topElem] || "ê°•ì ì´ ë¶„ëª…í•´ì„œ ë°©í–¥ë§Œ ì¡ìœ¼ë©´ ì„±ê³¼ê°€ ì˜ ë‚˜ì™€.";
        const consText =
          cons[lowElem] || "ì•½í•œ êµ¬ê°„ì€ ë£¨í‹´ìœ¼ë¡œ ì±„ìš°ë©´ íë¦„ì´ ì•ˆì •ë¼.";
        return { prosText, consText };
      }

      function renderElementsAnalysis(elements, breakdown, meta = {}) {
        const keys = ["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"];
        const values = keys.map((k) => elements[k] || 0);
        const maxVal = Math.max(...values, 1);
        const topIdx = values.indexOf(Math.max(...values));
        const lowIdx = values.indexOf(Math.min(...values));
        const top = keys[topIdx];
        const low = keys[lowIdx];
        const personality = getElementPersonality(top, low);
        const profile = makeElementProfile(elements);
        const evidenceLine = makeElementEvidence(elements, breakdown, top, low);
        const { prosText, consText } = getElementProsCons(top, low);

        const totalSum = values.reduce((a, b) => a + b, 0) || 1;
        const rounded = keys.reduce((acc, k) => {
          acc[k] = Math.round((elements[k] || 0) * 10) / 10;
          return acc;
        }, {});
        const percent = keys.reduce((acc, k) => {
          acc[k] = Math.round(((elements[k] || 0) / totalSum) * 1000) / 10;
          return acc;
        }, {});

        elementsSummary.textContent = `ì˜¤í–‰ ë¶„ì„: ${top} ê¸°ìš´ì´ ê°€ì¥ ê°•í•˜ê³ , ${low} ê¸°ìš´ì´ ìƒëŒ€ì ìœ¼ë¡œ ì•½í•œ í¸ì´ì•¼. ${softenText(
          prosText
        )} ${softenText(consText)}`;
        renderElementsRadar(elements);

        // ì‹ í† ì •ë¹„ê²° ë³´ì • ì •ë³´ HTML ìƒì„±
        let anchorInfoHtml = null;
        let elementsTableHtml = "";
        if (meta.anchorKey) {
          const keyParts = meta.anchorKey.split("|");
          const SHINTO_ANCHORS = {
            "ë³‘ì¸|ê³„ì‚¬|ë³‘ì|ë¬´ì": { ëª©: 16, í™”: 33, í† : 24, ê¸ˆ: 7, ìˆ˜: 70 },
            "ë¬´ì§„|ê¸°ë¯¸|ì •í•´|ì‹ í•´": { ëª©: 26, í™”: 9, í† : 70, ê¸ˆ: 10, ìˆ˜: 35 },
            "ì„í•´|ê°‘ì‹ |ê¸°ì¶•|ê³„ìœ ": { ëª©: 27, í™”: 0, í† : 32, ê¸ˆ: 49, ìˆ˜: 42 },
            "ì„ìˆ |ë³‘ì˜¤|ê³„ë¯¸|ì‹ ìœ ": { ëª©: 3, í™”: 42, í† : 46, ê¸ˆ: 49, ìˆ˜: 10 },
            "ê²½ì‹ |ì‹ ì‚¬|ì„ì¸|ê¸°ìœ ": { ëª©: 16, í™”: 23, í† : 31, ê¸ˆ: 73, ìˆ˜: 7 },
            "ë¬´ì˜¤|ì •ì‚¬|ì‹ ë¬˜|ì •ìœ ": { ëª©: 30, í™”: 56, í† : 27, ê¸ˆ: 37, ìˆ˜: 0 },
            "ê³„ë¯¸|ì •ì‚¬|ì •í•´|ê¸°ìœ ": { ëª©: 10, í™”: 35, í† : 42, ê¸ˆ: 37, ìˆ˜: 26 },
          };
          const anchorData = SHINTO_ANCHORS[meta.anchorKey];
          const t = window.t || ((key, vars = {}) => key);
          const statusText = meta.anchorApplied ? t("shintoCorrectionApplied") : t("shintoCorrectionNotApplied");
          const statusClass = meta.anchorApplied ? "chip e-wood" : "chip";

          if (anchorData) {
            anchorInfoHtml = `
              <div style="margin: 16px 0; padding: 16px; background: rgba(99, 102, 241, 0.05); border-radius: var(--radius-sm); border: 1px solid rgba(99, 102, 241, 0.15);">
                <div class="section-title" style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                  <span>ğŸ”® ${t("shintoCorrectionTitle")}</span>
                  <span class="${statusClass}" style="font-size: 11px; padding: 4px 10px;">${statusText}</span>
                </div>
                <div style="margin-bottom: 12px;">
                  <table class="report-table" style="font-size: 13px;">
                    <thead>
                      <tr>
                        <th style="width: 80px;">${t("tableHeaderCategory")}</th>
                        <th>${t("tableHeaderYear")}</th>
                        <th>${t("tableHeaderMonth")}</th>
                        <th>${t("tableHeaderDay")}</th>
                        <th>${t("tableHeaderHour")}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <th>${t("tableHeaderStemBranch")}</th>
                        <td style="font-weight: 800; color: var(--accent);">${escapeHtml(
                          keyParts[0] || "â€”"
                        )}</td>
                        <td style="font-weight: 800; color: var(--accent);">${escapeHtml(
                          keyParts[1] || "â€”"
                        )}</td>
                        <td style="font-weight: 800; color: var(--accent);">${escapeHtml(
                          keyParts[2] || "â€”"
                        )}</td>
                        <td style="font-weight: 800; color: var(--accent);">${escapeHtml(
                          keyParts[3] || "â€”"
                        )}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div>
                  <table class="report-table" style="font-size: 13px; width: 100%;">
                    <thead>
                      <tr>
                        <th style="width: 90px; text-align: center;">${t("tableHeaderElements")}</th>
                        <th style="width: 80px; text-align: center;">ëª©</th>
                        <th style="width: 80px; text-align: center;">í™”</th>
                        <th style="width: 80px; text-align: center;">í† </th>
                        <th style="width: 80px; text-align: center;">ê¸ˆ</th>
                        <th style="width: 80px; text-align: center;">ìˆ˜</th>
                        <th style="width: 70px; text-align: center;">${t("tableHeaderTotal")}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <th style="text-align: center; vertical-align: middle;">${t("tableHeaderCorrection")}</th>
                        <td style="text-align: center; vertical-align: middle; padding: 8px; border-radius: 6px; font-weight: 800; font-size: 14px; background: #e8f7e9; color: #0f3d2e;">${
                          anchorData.ëª©
                        }</td>
                        <td style="text-align: center; vertical-align: middle; padding: 8px; border-radius: 6px; font-weight: 800; font-size: 14px; background: #ffe9e3; color: #7a1f16;">${
                          anchorData.í™”
                        }</td>
                        <td style="text-align: center; vertical-align: middle; padding: 8px; border-radius: 6px; font-weight: 800; font-size: 14px; background: #f8f1df; color: #5a3b12;">${
                          anchorData.í† 
                        }</td>
                        <td style="text-align: center; vertical-align: middle; padding: 8px; border-radius: 6px; font-weight: 800; font-size: 14px; background: #eef3ff; color: #1b3a70;">${
                          anchorData.ê¸ˆ
                        }</td>
                        <td style="text-align: center; vertical-align: middle; padding: 8px; border-radius: 6px; font-weight: 800; font-size: 14px; background: #e6f5ff; color: #0c3550;">${
                          anchorData.ìˆ˜
                        }</td>
                        <td style="text-align: center; vertical-align: middle; padding: 8px; font-weight: 800; font-size: 15px; color: var(--accent); background: rgba(99, 102, 241, 0.1);">${Object.values(
                          anchorData
                        ).reduce((a, b) => a + b, 0)}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <p class="mini" style="margin-top: 12px; padding: 12px; background: rgba(255, 255, 255, 0.5); border-radius: 8px; line-height: 1.6;">
                  ${
                    meta.anchorApplied
                      ? t("shintoCorrectionAppliedText")
                      : t("shintoCorrectionNotAppliedText")
                  }
                </p>
              </div>
            `;
          } else {
            const t = window.t || ((key, vars = {}) => key);
            anchorInfoHtml = `
              <div style="margin: 12px 0;">
                <div class="section-title" style="margin-bottom: 8px;">
                  ${t("shintoCorrectionTitle")} <span class="chip" style="font-size: 11px; padding: 2px 8px;">${t("shintoCorrectionNotApplied")}</span>
                </div>
                <p class="mini">${t("tableHeaderStemBranch")}: ${escapeHtml(meta.anchorKey)}</p>
                <p class="mini">${t("shintoCorrectionNoData")}</p>
              </div>
            `;
          }
        }

        // ì˜¤í–‰ ì •ë³´ í‘œ ìƒì„±
        elementsTableHtml = `
          <div style="margin: 16px 0;">
            <div class="section-title" style="margin-bottom: 12px;">ğŸ“Š ì˜¤í–‰ ë¶„ì„</div>
            <div class="pill-row" style="margin-bottom: 12px;">
              <span class="pill emphasis">ì¼ê°„ ê¸°ì¤€: ${escapeHtml(
                meta.dayElem || "â€”"
              )} ê¸°ìš´ ì¸ê°„(ë³¸ì§ˆ)</span>
              <span class="pill emphasis">ì˜¤í–‰ ë¶„í¬: ${escapeHtml(
                top
              )} ê°•ì„¸(í™˜ê²½)</span>
            </div>
            ${
              meta.birthText
                ? `<p class="mini" style="margin-bottom: 12px;"><strong>ì¶œìƒ:</strong> ${escapeHtml(
                    meta.birthText
                  )}</p>`
                : ""
            }
            <table class="report-table" style="font-size: 13px; margin-bottom: 12px;">
              <thead>
                <tr>
                  <th style="width: 100px;">êµ¬ë¶„</th>
                  <th style="width: 80px; text-align: center;">ëª©</th>
                  <th style="width: 80px; text-align: center;">í™”</th>
                  <th style="width: 80px; text-align: center;">í† </th>
                  <th style="width: 80px; text-align: center;">ê¸ˆ</th>
                  <th style="width: 80px; text-align: center;">ìˆ˜</th>
                  <th style="width: 70px; text-align: center;">í•©ê³„</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th style="vertical-align: middle;">ë¶„í¬(%)</th>
                  <td style="text-align: center; vertical-align: middle; font-weight: 700;">${
                    percent["ëª©"]
                  }%</td>
                  <td style="text-align: center; vertical-align: middle; font-weight: 700;">${
                    percent["í™”"]
                  }%</td>
                  <td style="text-align: center; vertical-align: middle; font-weight: 700;">${
                    percent["í† "]
                  }%</td>
                  <td style="text-align: center; vertical-align: middle; font-weight: 700;">${
                    percent["ê¸ˆ"]
                  }%</td>
                  <td style="text-align: center; vertical-align: middle; font-weight: 700;">${
                    percent["ìˆ˜"]
                  }%</td>
                  <td style="text-align: center; vertical-align: middle; font-weight: 800; color: var(--accent);">100%</td>
                </tr>
                <tr>
                  <th style="vertical-align: middle;">ì ìˆ˜(150)</th>
                  <td style="text-align: center; vertical-align: middle; padding: 6px; border-radius: 4px; font-weight: 800; background: #e8f7e9; color: #0f3d2e;">${
                    rounded["ëª©"]
                  }</td>
                  <td style="text-align: center; vertical-align: middle; padding: 6px; border-radius: 4px; font-weight: 800; background: #ffe9e3; color: #7a1f16;">${
                    rounded["í™”"]
                  }</td>
                  <td style="text-align: center; vertical-align: middle; padding: 6px; border-radius: 4px; font-weight: 800; background: #f8f1df; color: #5a3b12;">${
                    rounded["í† "]
                  }</td>
                  <td style="text-align: center; vertical-align: middle; padding: 6px; border-radius: 4px; font-weight: 800; background: #eef3ff; color: #1b3a70;">${
                    rounded["ê¸ˆ"]
                  }</td>
                  <td style="text-align: center; vertical-align: middle; padding: 6px; border-radius: 4px; font-weight: 800; background: #e6f5ff; color: #0c3550;">${
                    rounded["ìˆ˜"]
                  }</td>
                  <td style="text-align: center; vertical-align: middle; font-weight: 800; color: var(--accent);">150</td>
                </tr>
                <tr>
                  <th style="vertical-align: middle;">í‰ê·  ëŒ€ë¹„</th>
                  ${["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"]
                    .map((k) => {
                      const v = Math.round((elements[k] || 0) * 10) / 10;
                      const avg = totalSum / 5;
                      const diff = Math.round((v - avg) * 10) / 10;
                      const sign = diff >= 0 ? "+" : "";
                      const color =
                        diff >= 0 ? "var(--accent)" : "rgba(15, 23, 42, 0.6)";
                      return `<td style="text-align: center; vertical-align: middle; font-weight: 700; color: ${color};">${sign}${diff}</td>`;
                    })
                    .join("")}
                  <td style="text-align: center; vertical-align: middle;">â€”</td>
                </tr>
              </tbody>
            </table>
            ${
              breakdown
                ? `
              <table class="report-table" style="font-size: 12px; margin-bottom: 12px;">
                <thead>
                  <tr>
                    <th style="width: 100px;">êµ¬ë¶„</th>
                    <th style="width: 80px; text-align: center;">ëª©</th>
                    <th style="width: 80px; text-align: center;">í™”</th>
                    <th style="width: 80px; text-align: center;">í† </th>
                    <th style="width: 80px; text-align: center;">ê¸ˆ</th>
                    <th style="width: 80px; text-align: center;">ìˆ˜</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th>ì²œê°„</th>
                    ${["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"]
                      .map((k) => {
                        const v =
                          Math.round((breakdown.stems[k] || 0) * 10) / 10;
                        const p =
                          Math.round(
                            ((breakdown.stems[k] || 0) / totalSum) * 1000
                          ) / 10;
                        return `<td style="text-align: center; font-size: 11px;">${v}(${p}%)</td>`;
                      })
                      .join("")}
                  </tr>
                  <tr>
                    <th>ì§€ì§€ ë³¸ê¸°</th>
                    ${["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"]
                      .map((k) => {
                        const v =
                          Math.round((breakdown.branches[k] || 0) * 10) / 10;
                        const p =
                          Math.round(
                            ((breakdown.branches[k] || 0) / totalSum) * 1000
                          ) / 10;
                        return `<td style="text-align: center; font-size: 11px;">${v}(${p}%)</td>`;
                      })
                      .join("")}
                  </tr>
                  ${
                    meta.hiddenMode === "on"
                      ? `
                  <tr>
                    <th>ì¥ê°„</th>
                    ${["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"]
                      .map((k) => {
                        const v =
                          Math.round((breakdown.hidden[k] || 0) * 10) / 10;
                        const p =
                          Math.round(
                            ((breakdown.hidden[k] || 0) / totalSum) * 1000
                          ) / 10;
                        return `<td style="text-align: center; font-size: 11px;">${v}(${p}%)</td>`;
                      })
                      .join("")}
                  </tr>
                  `
                      : ""
                  }
                  <tr>
                    <th>ì›”ë ¹ ê°€ì¤‘</th>
                    ${["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"]
                      .map((k) => {
                        const v =
                          Math.round((breakdown.season[k] || 0) * 10) / 10;
                        const p =
                          Math.round(
                            ((breakdown.season[k] || 0) / totalSum) * 1000
                          ) / 10;
                        return `<td style="text-align: center; font-size: 11px;">${v}(${p}%)</td>`;
                      })
                      .join("")}
                  </tr>
                </tbody>
              </table>
            `
                : ""
            }
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
              <div class="chip" style="padding: 8px 12px;">
                <strong>ê°•:</strong> ${profile.strong || "â€”"}
              </div>
              <div class="chip" style="padding: 8px 12px;">
                <strong>ì¤‘:</strong> ${profile.mid || "â€”"}
              </div>
              <div class="chip" style="padding: 8px 12px;">
                <strong>ì•½:</strong> ${profile.weak || "â€”"}
              </div>
            </div>
            ${
              evidenceLine
                ? `<p class="mini" style="padding: 8px; background: rgba(99, 102, 241, 0.05); border-radius: 8px; margin-bottom: 12px;"><strong>ê·¼ê±°:</strong> ${escapeHtml(
                    evidenceLine
                  )}</p>`
                : ""
            }
          </div>
        `;

        const detailLines = [
          `ê°•í•œ ${top}: ì§‘ì¤‘/ì¶”ì§„ ìª½ìœ¼ë¡œ ì“°ë©´ ì„±ê³¼ê°€ ë¹¨ë¼ì ¸. íŠ¹íˆ ${top} ê¸°ìš´ì€ í˜„ì¬ ì „ì²´ì˜ ì•½ ${Math.round(
            (values[topIdx] / totalSum) * 100
          )}% ìˆ˜ì¤€ì´ì•¼.`,
          `ì•½í•œ ${low}: ë£¨í‹´/í™˜ê²½ ë³´ì™„ìœ¼ë¡œ ì¶©ë¶„íˆ ë©”ê¿€ ìˆ˜ ìˆì–´. ${low} ê¸°ìš´ì€ ì§€ê¸ˆ ê°€ì¥ ë‚®ì€ êµ¬ê°„ì´ë¼ ì˜ì‹ì ìœ¼ë¡œ ì±™ê¸°ëŠ” ê²Œ ì¢‹ì•„.`,
          `ì„±í–¥ ìš”ì•½: ${personality.replace(
            "í¥ì´ ë–¨ì–´ì§€ë©´ ë™ë ¥ì´ ê¸‰ê°í•  ìˆ˜ ìˆì–´.",
            "í¥ì´ ë–¨ì–´ì§€ë©´ ë™ë ¥ì´ ì¤„ ìˆ˜ ìˆì–´."
          )}`,
          ...elementAdvice(profile),
          meta.includeHour === false
            ? "ì‹œì£¼ ë¯¸í¬í•¨: ì‹œê°„ ì •ë³´ê°€ ì—†ì–´ ì‹œì£¼ì˜ ì˜í–¥ì€ ì œì™¸í–ˆì–´."
            : meta.includeHour === "partial"
            ? "ì‹œì£¼ ì¼ë¶€ ë¯¸í¬í•¨: í•œìª½ì€ ì‹œê°„ ì •ë³´ê°€ ì—†ì–´ ì‹œì£¼ê°€ ì œì™¸ëì–´."
            : null,
          meta.boundaryText ? meta.boundaryText : null,
          `ê· í˜• íŒ: ìƒìƒ íë¦„ìœ¼ë¡œ ${top} ê¸°ìš´ì„ ì‚´ë¦¬ê³ , ${low} ê¸°ìš´ì„ ë°›ì³ì¤„ ìƒí™œ ìŠµê´€ í•˜ë‚˜ë§Œ ê³ ì •í•˜ë©´ íë¦„ì´ ì•ˆì •ë¼.`,
        ].filter(Boolean);
        const detailText = detailLines
          .map((l) => escapeHtml(l))
          .filter(Boolean)
          .join("<br/>");

        elementsDetail.innerHTML = anchorInfoHtml
          ? anchorInfoHtml + elementsTableHtml + "<br/>" + detailText
          : elementsTableHtml + "<br/>" + detailText;
      }

      function getElementPersonality(top, low) {
        const topMap = {
          ëª©: "í™•ì¥í˜•. ì•„ì´ë””ì–´/ê°œì²™ì— ê°•í•˜ê³ , ë¹ ë¥´ê²Œ ì›€ì§ì—¬.",
          í™”: "í‘œí˜„í˜•. ì¶”ì§„/ì—´ì •ì´ ê°•í•˜ê³ , ë¶„ìœ„ê¸°ë¥¼ ì£¼ë„í•´.",
          í† : "ì•ˆì •í˜•. ì¡°ìœ¨/ê´€ë¦¬ ì¤‘ì‹¬ì´ë©°, ì‹ ë¢°ê°€ ìì‚°ì´ì•¼.",
          ê¸ˆ: "ì •ë°€í˜•. ê¸°ì¤€/ì›ì¹™ì´ ëšœë ·í•˜ê³ , ê²°ì •ì´ ë¹ ë¥¸ í¸ì´ì•¼.",
          ìˆ˜: "ë¶„ì„í˜•. ì •ë³´/íë¦„ì„ ì½ê³ , ìœ ì—°í•˜ê²Œ ëŒ€ì‘í•´.",
        };
        const lowMap = {
          ëª©: "ìƒˆë¡œìš´ ì‹œë„ëŠ” ì‰¬ëŠ”ë° ë§ˆë¬´ë¦¬ê°€ ì•½í•´ì§ˆ ìˆ˜ ìˆì–´.",
          í™”: "í¥ì´ ë–¨ì–´ì§€ë©´ ë™ë ¥ì´ ê¸‰ê°í•  ìˆ˜ ìˆì–´.",
          í† : "ë£¨í‹´ì´ ííŠ¸ëŸ¬ì§€ë©´ ë¶ˆì•ˆì •í•´ì§ˆ ìˆ˜ ìˆì–´.",
          ê¸ˆ: "ê²°ì • ê¸°ì¤€ì´ í”ë“¤ë¦¬ë©´ ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì»¤ì§ˆ ìˆ˜ ìˆì–´.",
          ìˆ˜: "ê³¼í•œ ì •ë³´ íƒìƒ‰ìœ¼ë¡œ ê²°ì •ì´ ëŠ¦ì–´ì§ˆ ìˆ˜ ìˆì–´.",
        };
        const topLine = topMap[top] || "ê¸°ì§ˆì˜ ì¤‘ì‹¬ì´ ë˜ëŠ” ì„±í–¥ì´ ë˜ë ·í•´.";
        const lowLine = lowMap[low] || "ì•½í•œ ì¶•ì„ ë³´ì™„í•˜ë©´ ì•ˆì •ê°ì´ ì˜¬ë¼ê°€.";
        return `${topLine} ${lowLine}`;
      }

      function renderElementsRadar(elements) {
        const svg = elementsRadarSvg;
        const keys = ["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"];
        const values = keys.map((k) => elements[k] || 0);
        const maxVal = Math.max(...values, 1);
        const vals = values.map((v) => clamp01(v / maxVal));
        const cx = 160;
        const cy = 160;
        const R = 110;
        svg.innerHTML = "";

        const ang = (i) => ((Math.PI * 2) / 5) * i - Math.PI / 2;
        const pt = (v, i) => [
          cx + R * v * Math.cos(ang(i)),
          cy + R * v * Math.sin(ang(i)),
        ];
        const polyPoints = (arr, scale = 1) =>
          arr
            .map((v, i) =>
              pt(v * scale, i)
                .map((n) => n.toFixed(2))
                .join(",")
            )
            .join(" ");

        const el = (name, attrs = {}) => {
          const e = document.createElementNS(
            "http://www.w3.org/2000/svg",
            name
          );
          Object.entries(attrs).forEach(([k, v]) => e.setAttribute(k, v));
          return e;
        };

        for (let r = 1; r <= 4; r++) {
          svg.appendChild(
            el("polygon", {
              points: polyPoints([r / 4, r / 4, r / 4, r / 4, r / 4]),
              fill: "none",
              stroke: "rgba(15,23,42,0.14)",
              "stroke-width": "1",
            })
          );
        }

        keys.forEach((name, i) => {
          const [x, y] = pt(1, i);
          svg.appendChild(
            el("line", {
              x1: cx,
              y1: cy,
              x2: x,
              y2: y,
              stroke: "rgba(15,23,42,0.22)",
              "stroke-width": "1",
            })
          );
          const [lx, ly] = pt(1.18, i);
          const text = el("text", {
            x: lx,
            y: ly,
            "text-anchor": "middle",
            "dominant-baseline": "middle",
            "font-size": "13",
            "font-weight": "900",
            fill: "#0f172a",
          });
          text.textContent = `${name} ${
            Math.round((elements[name] || 0) * 10) / 10
          }`;
          svg.appendChild(text);
        });

        const poly = el("polygon", {
          points: polyPoints(vals, 0.02),
          fill: "rgba(245,158,11,0.25)",
          stroke: "rgba(217,119,6,0.95)",
          "stroke-width": "2",
          "stroke-linejoin": "round",
        });
        svg.appendChild(poly);

        const dots = vals.map((v, i) => {
          const dot = el("circle", {
            cx: cx,
            cy: cy,
            r: "3.5",
            fill: "rgba(217,119,6,0.95)",
          });
          svg.appendChild(dot);
          return { dot, v, i };
        });

        let p = 0.02;
        function anim() {
          p += 0.05;
          if (p > 1) p = 1;
          poly.setAttribute("points", polyPoints(vals, p));
          dots.forEach(({ dot, v, i }) => {
            const [dx, dy] = pt(v * p, i);
            dot.setAttribute("cx", dx.toFixed(2));
            dot.setAttribute("cy", dy.toFixed(2));
          });
          if (p < 1) requestAnimationFrame(anim);
        }
        requestAnimationFrame(anim);
      }

      function getGenerator(elem) {
        const map = { í™”: "ëª©", í† : "í™”", ê¸ˆ: "í† ", ìˆ˜: "ê¸ˆ", ëª©: "ìˆ˜" };
        return map[elem] || "";
      }

      function getOvercomeElem(elem) {
        const entries = Object.entries(OVERCOME);
        const found = entries.find(([, v]) => v === elem);
        return found ? found[0] : "";
      }

      function getYongshinSuggestion(person) {
        const suggestions = [];
        const genWeak = getGenerator(person.weakElem);
        const controlTop = getOvercomeElem(person.topElem);
        if (person.weakScore <= 0.8 && genWeak) {
          suggestions.push({
            elem: genWeak,
            reason: `ì•½í•œ ${person.weakElem} ë³´ì™„`,
          });
        }
        if (person.topScore >= 1.4 && controlTop) {
          suggestions.push({
            elem: controlTop,
            reason: `ê°•í•œ ${person.topElem} ì¡°ì ˆ`,
          });
        }
        if (!suggestions.length && genWeak) {
          suggestions.push({
            elem: genWeak,
            reason: `ê· í˜• ìœ ì§€`,
          });
        }
        return suggestions;
      }

      function calcStrength(elements, dayElem, seasonElem) {
        if (!dayElem) return "ì¤‘ê°„";
        const total = Object.values(elements).reduce((a, b) => a + b, 0);
        const avg = total / 5;
        let score = elements[dayElem] || 0;
        if (seasonElem === dayElem) score += 0.6;
        if (GENERATE[seasonElem] === dayElem) score += 0.3;
        if (OVERCOME[seasonElem] === dayElem) score -= 0.3;
        if (score >= avg + 0.2) return "ì‹ ê°•";
        if (score <= avg - 0.2) return "ì‹ ì•½";
        return "ì¤‘ê°„";
      }

      function listInternalPairs(branches, table) {
        const out = [];
        for (let i = 0; i < branches.length; i++) {
          for (let j = i + 1; j < branches.length; j++) {
            if (hasPair(branches[i], branches[j], table)) {
              out.push(`${branches[i]}-${branches[j]}`);
            }
          }
        }
        return out;
      }

      function listInternalHyeong(branches) {
        const out = [];
        for (let i = 0; i < branches.length; i++) {
          for (let j = i + 1; j < branches.length; j++) {
            if (
              HYEONG.some(
                ([a, b]) =>
                  (branches[i] === a && branches[j] === b) ||
                  (branches[i] === b && branches[j] === a)
              )
            ) {
              out.push(`${branches[i]}-${branches[j]}`);
            }
          }
        }
        return out;
      }

      function renderDeepAnalysisCard(a, b) {
        const blocks = [];
        if (a) blocks.push(renderDeepBlock("A", a));
        if (b) blocks.push(renderDeepBlock("B", b));
        deepAnalysis.innerHTML = blocks.join("");
      }

      function renderDeepBlock(label, person) {
        const t = window.t || ((key, vars = {}) => key);
        const lang = window.currentLang || "ko";
        const yongshin = getYongshinSuggestion(person);
        let yongText;
        if (lang === "en") {
          yongText = yongshin.length
            ? yongshin.map((y) => {
                const reasonMap = {
                  [`ì•½í•œ ${person.weakElem} ë³´ì™„`]: `Supplement weak ${person.weakElem}`,
                  [`ê°•í•œ ${person.topElem} ì¡°ì ˆ`]: `Control strong ${person.topElem}`,
                  "ê· í˜• ìœ ì§€": "Maintain balance"
                };
                return `${y.elem}(${reasonMap[y.reason] || y.reason})`;
              }).join(", ")
            : "â€”";
        } else {
          yongText = yongshin.length
            ? yongshin.map((y) => `${y.elem}(${y.reason})`).join(", ")
            : "â€”";
        }
        const season =
          person.monthBranch && person.seasonTopElem
            ? `${person.monthBranch}(${person.seasonTopElem})`
            : "â€”";
        const seasonLine = person.seasonTopElem && person.topElem === person.seasonTopElem
          ? t("deepSeasonSame")
          : t("deepSeasonDifferent");
        const currentLine = formatElemLine(t("deepCurrent"), person.elements);
        const dayStemLine = person.dayStem
          ? t("deepDayStem", {
              dayStem: person.dayStem,
              dayElem: person.dayElem,
              strength: person.strength
            })
          : t("deepDayStem", { dayStem: "â€”", dayElem: "â€”", strength: "â€”" });
        const branches = [
          person.yearBranch,
          person.monthBranch,
          person.dayBranch,
          person.hourBranch,
        ].filter(Boolean);
        const hap = listInternalPairs(branches, LIUHE);
        const chung = listInternalPairs(branches, CHUNG);
        const hyeong = listInternalHyeong(branches);
        const relationLine = t("deepRelation", {
          hap: hap.length ? hap.join(", ") : "â€”",
          chung: chung.length ? chung.join(", ") : "â€”",
          hyeong: hyeong.length ? hyeong.join(", ") : "â€”"
        });
        let relationExplain;
        if (lang === "en") {
          relationExplain = t("deepRelationExplain", {
            hyeongNote: hyeong.length
              ? t("deepRelationHyeongNote", { hyeong: hyeong.join(", ") })
              : t("deepRelationHyeongNone")
          });
        } else {
          relationExplain = t("deepRelationExplain", {
            hyeongNote: hyeong.length
              ? t("deepRelationHyeongNote", { hyeong: hyeong.join(", ") })
              : t("deepRelationHyeongNone")
          });
        }
        return `
          <div class="rule-card">
            <div class="mini">${escapeHtml(dayStemLine)}</div>
            <div class="mini">${t("deepYongshin", { yongText: escapeHtml(yongText) })}</div>
            <div class="mini">${t("deepGyeokguk", { season: escapeHtml(season), seasonLine: escapeHtml(seasonLine) })}</div>
            <div class="mini">${escapeHtml(currentLine)}</div>
            <div class="mini">${escapeHtml(relationLine)}</div>
            <div class="mini">${escapeHtml(relationExplain)}</div>
          </div>
        `;
      }

      function getHourRangeText(branch) {
        const map = {
          ì: "00:00~01:30",
          ì¶•: "01:31~03:30",
          ì¸: "03:31~05:30",
          ë¬˜: "05:31~07:30",
          ì§„: "07:31~09:30",
          ì‚¬: "09:31~11:30",
          ì˜¤: "11:31~13:30",
          ë¯¸: "13:31~15:30",
          ì‹ : "15:31~17:30",
          ìœ : "17:31~19:30",
          ìˆ : "19:31~21:30",
          í•´: "21:31~23:30",
        };
        return map[branch] || "â€”";
      }

      function makeYearNarrative(person, targetYear) {
        const pillar = ganzhiYear(targetYear);
        const yearElem = STEM_ELEM[pillar.stem];
        const yearTenGod = person.dayStem
          ? tenGod(person.dayStem, pillar.stem)
          : "";
        const mode = yearModeText(
          pickYearMode(
            relationElem(yearElem, person.topElem),
            relationElem(yearElem, person.weakElem)
          )
        );
        const relYearTop = relationElem(yearElem, person.topElem);
        const relYearWeak = relationElem(yearElem, person.weakElem);

        // ì´ë¡  ìƒì„±
        let totalParts = [];
        if (relYearTop === "ìƒ" || relYearTop === "ë™") {
          totalParts.push(
            "ìœ„ê¸° ê°€ìš´ë° ê¸°íšŒê°€ ìˆìœ¼ë‹ˆ ì–´ë ¤ì›€ ì¤‘ì— ì–»ìŒì´ í° í•´ì…ë‹ˆë‹¤."
          );
          totalParts.push(
            "ê²½í—˜ì„ í†µí•´ ì–»ì€ ê²ƒì´ë‹ˆ ê²°ê³¼ê°€ ë‹¨ë‹¨í•˜ë©° ë³´ê¸°ì— ì¢‹ìŠµë‹ˆë‹¤."
          );
        } else if (relYearTop === "ê·¹" || relYearTop === "ëˆŒë¦¼") {
          totalParts.push(
            "ì‹ ì¤‘ì´ ê³§ ë³µì¸ í•´ì…ë‹ˆë‹¤. ì„œë‘ë¥´ë©´ ì†í•´ë¥¼ ë³´ë‹ˆ í™•ì¸ì„ ê±°ë“­í•´ì•¼ í•©ë‹ˆë‹¤."
          );
          totalParts.push(
            "ì§€í‚¤ëŠ” ìì—ê²Œ ë³µì´ ë¨¸ë¬¼ëŸ¬ ì•ˆì •ì„ ì¶”êµ¬í•˜ë©´ ê¸¸í•©ë‹ˆë‹¤."
          );
        } else {
          totalParts.push("ê¸°ë³¸ì„ ì§€í‚¤ë©´ ì•ˆì •ì´ ë”°ë¥´ëŠ” í•´ì…ë‹ˆë‹¤.");
          totalParts.push(
            "ì‘ì€ ì„±ì‹¤ì´ í° ë³µìœ¼ë¡œ ëŒì•„ì˜¤ë‹ˆ ê¾¸ì¤€í•¨ì´ ìš”ì²´ì…ë‹ˆë‹¤."
          );
        }

        if (yearTenGod === "ì •ê´€" || yearTenGod === "í¸ê´€") {
          totalParts.push(
            "ëŠ¥ë ¥ì„ ì–»ì—ˆìœ¼ë‹ˆ ë‚˜ë¥¼ ë°”ë¼ë³´ëŠ” ì‹œì„ ì´ ë§ì•„ì§€ëŠ” í•´ì…ë‹ˆë‹¤."
          );
          totalParts.push("ì¸ê¸°ê°€ ë§ìœ¼ë‹ˆ ëª…ì˜ˆëŠ” ì €ì ˆë¡œ ì–»ê²Œ ë©ë‹ˆë‹¤.");
        } else if (yearTenGod === "ì •ì¬" || yearTenGod === "í¸ì¬") {
          totalParts.push(
            "í° ì¬ë¬¼ì€ ì•„ë‹ˆì–´ë„ ì†Œì†Œí•¨ì´ ìˆì„ ê²ƒì´ë‹ˆ ëŠì´ì§€ ì•Šê²Œ í•˜ì—¬ ê·¼ì‹¬ì„ ë§‰ì„ ê²ƒì…ë‹ˆë‹¤."
          );
          totalParts.push(
            "í•„ìš”í•œ ì •ë„ëŠ” ì–»ì„ ê²ƒì´ë‹ˆ ìš•ì‹¬ìœ¼ë¡œ í™”ë¥¼ ì¡°ì¥í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤."
          );
        } else if (yearTenGod === "ì •ì¸" || yearTenGod === "í¸ì¸") {
          totalParts.push("ë³µì€ ì¸ì—°ê³¼ ê²¸ì†ì„ í†µí•´ ì°¾ì•„ì˜µë‹ˆë‹¤.");
          totalParts.push(
            "ë‚˜ì˜ ê²ƒì´ ì•„ë‹Œ ê²ƒì„ ë°”ë¼ë©´ ë˜ë ¤ í‰ì‚¬ê°€ ë  ê²ƒì´ë‹ˆ ë°˜ë“œì‹œ ë…¸ë ¥ì„ í†µí•´ ì–»ì–´ì•¼ í•¨ì„ ëª…ì‹¬í•˜ê¸° ë°”ëë‹ˆë‹¤."
          );
        }

        totalParts.push(
          "ì§€ìœ„ì™€ ëª…ì˜ˆëŠ” ì‹¤ë¦¬ë¥¼ ë™ë°˜í•´ì•¼ í•˜ë©° ì¬ë¬¼ì€ ë…¸ë ¥ì´ ìˆ˜ë°˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤."
        );
        totalParts.push(
          "íˆ¬ìë¥¼ í†µí•´ì„œ ì–»ëŠ” ì¬ë¬¼ì€ ì—†ì„ ê²ƒì´ë‹ˆ ê³µì—°íˆ ë‚­íŒ¨ ë³´ëŠ” ì¼ì´ ì—†ë„ë¡ í•˜ì‹œê³  ì±…ì„ë§Œ ì£¼ì–´ì§„ ê°íˆ¬ëŠ” ê°ë³„íˆ ì‚¬ì–‘í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤."
        );
        totalParts.push(
          "ê¸°íšŒì— ì €í•´ìš”ì†Œê°€ ë  ê²ƒì´ë‹ˆ ëª…ì˜ˆë¥¼ ì–»ê³ ë„ ì¼ì€ í—ˆì‚¬ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        );
        totalParts.push(
          "ê¸¸ì„±ì´ ë¬¸ ì•ì„ ë¹„ì¶œ ê²ƒì´ë‹ˆ ì·¨í•˜ëŠ” ìì˜ ë…¸ë ¥ì— ë”°ë¼ ì–»ìŒì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤."
        );
        totalParts.push(
          "ë…¸ë ¥í•˜ë©´ ì´ìƒì„ ì–»ê²Œ ë˜ëŠ” í•´ì´ë‚˜ ì•‰ì•„ì„œ ë“¤ì–´ì˜¤ëŠ” ì¬ë¬¼ì€ ì—†ìŠµë‹ˆë‹¤."
        );
        totalParts.push(
          "ë…¸ë ¥ ì—†ì´ ì¬ë¬¼ì„ íƒí•˜ë©´ ì‹¤ì´ ë  ê²ƒì´ë‹ˆ ëª…ì‹¬í•´ì•¼ í•©ë‹ˆë‹¤."
        );
        totalParts.push(
          "ë„ì›€ ì£¼ëŠ” ì¸ì—°ì´ ë‚˜íƒ€ë‚  ê²ƒì´ë‹ˆ ì‘ì€ ì¸ì—°ë„ ì†Œì¤‘íˆ í•´ì•¼ í•©ë‹ˆë‹¤."
        );
        totalParts.push(
          "ê·¼ì‹¬ì€ ì‘ê³  ê¸°ì¨ì€ í° í•´ì´ë‹ˆ ë¬´ëª¨í•¨ìœ¼ë¡œ ì¢‹ì€ ë³µì„ ë‚ ë¦¬ëŠ” ì¼ì´ ì—†ë„ë¡ í•˜ì„¸ìš”."
        );
        totalParts.push("ì¼ì´ ìƒê¸°ë©´ í”¼í•˜ì§€ ë§ì•„ì•¼ í•©ë‹ˆë‹¤.");

        const total = casualizeText(totalParts.join(" "));

        // ì¬ë¬¼ìš´ ìƒì„±
        let moneyParts = [];
        if (relYearWeak === "ìƒ" || relYearWeak === "ë™") {
          moneyParts.push(
            "ì¼ì„ ì§„í–‰í•˜ê³  ì¬ë¬¼ì„ ì–»ìœ¼ë ¤ë©´ í•œë²ˆì€ í¬ê²Œ ëª¨í—˜ì„ í•˜ê²Œ ë˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤."
          );
          moneyParts.push(
            "ë§ˆìŒì†ì— ê³ ë¯¼ê³¼ ê°ˆë“±ì´ ë§ì•„ì§€ê²Œ ë˜ë©° ì¤‘ìš”í•œ ê²°ì •ì„ ë‚´ë¦¬ê²Œ ë˜ëŠ” ì‹œê¸°ì´êµ°ìš”."
          );
          moneyParts.push(
            "ë‹¤í–‰íˆ ê¸¸ì„±ì´ ë¹„ì¶”ê³  ì›”ë•ê³¼ ì²œì„ì´ í•¨ê»˜í•˜ê²Œ ë˜ë‹ˆ ì¢‹ì€ ê²°ê³¼ê°€ ê¸°ëŒ€í•  ìˆ˜ ìˆê² ìŠµë‹ˆë‹¤."
          );
        } else {
          moneyParts.push("ì¬ë¬¼ì€ ê¾¸ì¤€í•¨ì—ì„œ ë‚˜ì˜µë‹ˆë‹¤.");
          moneyParts.push(
            "ê¸‰í•˜ê²Œ í°ëˆì„ íƒí•˜ë©´ ì†ì‹¤ë¡œ ëŒì•„ì˜¬ ìˆ˜ ìˆìœ¼ë‹ˆ ì‹ ì¤‘í•´ì•¼ í•©ë‹ˆë‹¤."
          );
        }
        moneyParts.push(
          "íš¡ì¬ë‚˜ í–‰ìš´ìœ¼ë¡œ ì–»ì–´ì§€ëŠ” ì¬ë¬¼ì€ ë§ì§€ ì•Šê³  ì¼ì´ ì˜ í’€ë¦¬ê³  ì„±ì¥í•˜ì—¬ ì¢‹ì€ ì„±ê³¼ë¥¼ ì˜¬ë¦¬ê²Œ ë  ë•Œ ì–»ê²Œ ë˜ëŠ” ì¬ë¬¼ì´ ë§ì„ ê²ƒì…ë‹ˆë‹¤."
        );
        moneyParts.push(
          "ë³¸ì—…ìœ¼ë¡œ ì–»ëŠ” ìˆ˜ìµë³´ë‹¤ ë³¸ì—… ì´ì™¸ì˜ ë¶„ì•¼ì—ì„œ ë“¤ì–´ì˜¤ëŠ” ìˆ˜ìµì´ ë” í´ ê²ƒì´ë‹ˆ ë‹¤ì†Œ ê· í˜•ì´ ë§ì§€ ì•Šì•„ì„œ ì„ íƒì˜ ê¸°ë¡œì—ì„œ ê°ˆë“±ì´ ìˆê² ì§€ë§Œ ì¬ë¬¼ì´ ìŒ“ì—¬ê°€ëŠ” ì¦ê±°ì›€ê³¼ í–‰ë³µí•¨ì´ í¬ê²Œ ëŠê»´ì§ˆ ê²ƒì…ë‹ˆë‹¤."
        );
        moneyParts.push(
          "ë‚˜ë¥¼ ìœ„í•´ ë„ì›€ì„ ì£¼ëŠ” ì˜ì¸ì´ ìˆì–´ ë‚˜ì˜ ì†ì‹¤ì„ ë§‰ì•„ì£¼ê³  ìƒí™œì˜ ë³€í™”ê°€ ìˆìœ¼ë©´ì„œ ì ˆì•½í•˜ëŠ” ìƒí™œì„ í•˜ê²Œ ë  ê²ƒì…ë‹ˆë‹¤."
        );
        moneyParts.push(
          "ê·¸ë˜ë„ ì§€ì¶œì´ ìƒë‹¹íˆ ë§ì€ ì„±í–¥ì´ ìˆìœ¼ë¯€ë¡œ ì¬ë¬¼ì´ ë‚˜ê°€ëŠ” ê²ƒì„ ì˜ ê´€ë¦¬í•œë‹¤ë©´ ê²°êµ­ ë“¤ì–´ì˜¤ëŠ” ì¬ë¬¼ì´ ë‚˜ê°€ëŠ” ì¬ë¬¼ë³´ë‹¤ ë§ì•„ì§€ê²Œ ë˜ì–´ ì¬ë¬¼ì„ ì¶•ì í•  ìˆ˜ê°€ ìˆì„ ê²ƒì…ë‹ˆë‹¤."
        );
        const money = casualizeText(moneyParts.join(" "));

        // ì§ì¥/ì‚¬ì—…ìš´ ìƒì„±
        let workParts = [];
        if (relYearTop === "ìƒ" || relYearTop === "ë™") {
          workParts.push(
            "í° ì¼ì„ ì„±ì‚¬ì‹œì¼œ ìì‹ ì˜ ê´€ë¡ê³¼ ëª…ì„±ì´ í¬ê²Œ ë†’ì•„ì§€ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤."
          );
          workParts.push(
            "ì§ì¥ì—ì„œëŠ” ì§€ìœ„ë¥¼ í¬ê²Œ ì–»ê±°ë‚˜ í° í¬ìƒì„ ë°›ì„ ë¿ë§Œ ì•„ë‹ˆë¼ ì†Œì†ëœ ê³³ì— ê³µì—¬í•˜ëŠ” ë°”ê°€ í¬ê³  ìì‹ ì´ ëŠë¼ëŠ” í–‰ë³µê°ë„ ì»¤ì§ˆ ê²ƒì…ë‹ˆë‹¤."
          );
        } else {
          workParts.push("ì•ˆì •ì„ ì¶”êµ¬í•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.");
          workParts.push(
            "ë¬´ë¦¬í•œ í™•ì¥ë³´ë‹¤ëŠ” ê¸°ì¡´ì˜ ê²ƒì„ ë‹¤ë“¬ëŠ” ê²ƒì´ ìœ ë¦¬í•©ë‹ˆë‹¤."
          );
        }
        workParts.push(
          "ìì‹ ì˜ ëŠ¥ë ¥ì´ ì ì°¨ ì•Œë ¤ì§€ê²Œ ë˜ë©´ì„œ ë‹¤ë¥¸ ê³³ìœ¼ë¡œë¶€í„° ì¢‹ì€ ì œì˜ë¥¼ ë°›ê±°ë‚˜ ë‚˜ë¥¼ ë¶€ë¥¼ ê²ƒì´ë‹ˆ ë‚˜ì˜ ì§„ê°€ì™€ ëŠ¥ë ¥ì´ í¬ê²Œ ë‹ë³´ì´ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤."
        );
        workParts.push(
          "ë°”ê¹¥ìœ¼ë¡œ í™œë™í•˜ëŠ” ì‚¬ëŒì€ ì ì‹œì˜ ì—¬ìœ ë„ ì—†ì„ ì •ë„ë¡œ ì¼ì´ ëŠì´ì§€ ì•Šì„ ê²ƒì…ë‹ˆë‹¤."
        );
        workParts.push(
          "ì¥ì‚¬ë¥¼ í•˜ë©´ ëŒ€ê¸¸ì˜ ìš´ìˆ˜ê°€ í¬ê²Œ ì¼ì–´ë‚  ê²ƒì´ì§€ë§Œ êµ³ì´ ìƒˆë¡œìš´ ì¥ì‚¬ë¥¼ ì‹œì‘í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤."
        );
        workParts.push(
          "ì¥ì‚¬ë³´ë‹¤ëŠ” ë¬´ìŠ¨ ì¼ì„ í•˜ë“ ì§€ ìš´ì˜ ì¤‘ì‹¬ì´ ë‚˜ì—ê²Œ ìˆìœ¼ë¯€ë¡œ ë‚´ê°€ ì£¼ë„ì ìœ¼ë¡œ í•  ìˆ˜ ìˆê³  ìì‹ ì˜ ë¨¸ë¦¬ì™€ ì†ì„ ê±°ì³ì„œ í•˜ëŠ” ì¼ì„ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤."
        );
        workParts.push(
          "ì‚¬ì—…ì ìœ¼ë¡œëŠ” ê¸°ë°˜ì´ íƒ„íƒ„í•´ì§ˆ ê²ƒì´ë©°, ê±°ë˜ì²˜ê°€ í¬ê²Œ ëŠ˜ì–´ë‚  ê²ƒì…ë‹ˆë‹¤."
        );
        workParts.push(
          "í™•ì¥ì˜ ì¤€ë¹„ë¥¼ í•´ì•¼ í•˜ì§€ë§Œ ë¬´ë¦¬í•˜ì§€ ë§ê³  ì¹˜ë°€í•˜ê²Œ ê³„íší•˜ê³  ì²œì²œíˆ ì—¬ìœ ë¥¼ ê°–ê³  ì§„í–‰í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤."
        );
        const work = casualizeText(workParts.join(" "));

        // ê°€ì •/ê±´ê°•ìš´ ìƒì„±
        let familyParts = [];
        familyParts.push(
          "ê°€ì¡± ì¤‘ì—ì„œ ê·¼ì‹¬ì´ ë§ì€ ì‚¬ëŒì´ ìˆìœ¼ë‹ˆ ë§ˆìŒìœ¼ë¡œ ìœ„ë¡œë¥¼ í•´ì•¼ í•  ì¼ì´ ìƒê¸°ê² ìŠµë‹ˆë‹¤."
        );
        familyParts.push("ê°€ì¡± ê°„ì˜ ê°ˆë“±ì´ ì˜ˆìƒë˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.");
        familyParts.push(
          "í•˜ëŠ˜ì´ ë‚˜ì—ê²Œ ë‚´ë¦° ì¢‹ì€ ìš´ì˜ ê¸°ìš´ì´ ì°¾ì•„ì˜¤ê¸° ì „ì˜ ì‚¬ì†Œí•œ ê°ˆë“±ìœ¼ë¡œ ë°œìƒí•  ê²ƒì´ë‹ˆ ìƒëŒ€ì˜ ì…ì¥ì„ ë¨¼ì € ì´í•´í•´ ì£¼ê³  í° ë‹¤íˆ¼ì´ ë˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤."
        );
        familyParts.push(
          "ê°€ì¡±ë¼ë¦¬ ë‹¤íˆ¬ê²Œ ë˜ë©´ ì²œê¸ˆì„ ì–»ëŠ”ë‹¤ í•˜ì—¬ë„ ì•„ë¬´ëŸ° ì†Œìš©ì´ ì—†ìŠµë‹ˆë‹¤."
        );
        familyParts.push(
          "ë´„ì„ ì§€ë‚˜ë©´ ëª¨ë‘ê°€ í•´ê²°ì´ ë  ê²ƒì´ë‹ˆ ê·¸ë•Œë¶€í„°ëŠ” í™”ëª©ê³¼ í‰ì•ˆì´ í´ ê²ƒì…ë‹ˆë‹¤."
        );
        familyParts.push(
          "ì†Œì›ì„±ì·¨ì˜ ìš´ì´ í¬ê²Œ ì¼ì–´ë‚˜ë‹ˆ ë¯¿ìœ¼ë©´ ë¯¿ì€ ë§Œí¼ ë³´ë‹µí•  ê²ƒì…ë‹ˆë‹¤."
        );
        familyParts.push(
          "ìœ„ì•„ë˜ê°€ ì´ì œë¶€í„° ëª¨ë‘ ì œ ì—­í• ì„ í•  ê²ƒì´ë‹ˆ ì„œë¡œê°€ ê³µì†í•´ì ¸ í™”ëª©ì´ ë”í•´ì§‘ë‹ˆë‹¤."
        );
        familyParts.push(
          "ì›ƒìŒì´ ëŠì´ì§€ ì•Šì„ ê²ƒì´ë‹ˆ í° ê²½ì‚¬ê°€ ìƒê¸¸ ì§•ì¡°ë„ ë³´ì´ëŠ”êµ°ìš”."
        );
        familyParts.push("ì›ƒì–´ë¥¸ì˜ ê±´ê°•ì— ë¬¸ì œê°€ ìƒê¹ë‹ˆë‹¤.");
        familyParts.push(
          "ë³‘ì›ì— ì˜¤ë˜ ê³„ì‹œì§€ ì•Šë„ë¡ ê°ë³„íˆ ì‹ ê²½ ì“°ì‹œê³  ì¦ì„¸ê°€ ì˜¤ë©´ ë°˜ë“œì‹œ ë³‘ì›ì„ ì°¾ì•„ ë³‘ì„ í‚¤ìš°ëŠ” ì¼ì´ ì—†ë„ë¡ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤."
        );
        const family = casualizeText(familyParts.join(" "));

        // ì´ì„±/ëŒ€ì¸ê´€ê³„ ìƒì„±
        let relationParts = [];
        relationParts.push(
          "ì•„ì£¼ ì¢‹ì€ ëŒ€ê¸¸ì˜ ì¸ì—°ê³¼ ë§¤ìš° ì¢‹ì§€ ì•Šì€ ì¸ì—°ì´ ë™ì‹œì— ì°¾ì•„ì˜¤ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤."
        );
        relationParts.push(
          "ì‚¬ëŒê³¼ì˜ ì¸ì—°ì— ëŒ€í•´ì„œ ìƒê°ì„ ë§ì´ í•˜ê²Œ ë  ê²ƒì…ë‹ˆë‹¤."
        );
        relationParts.push(
          "ê·¸ëŸ¬ë‚˜, ì¢‹ì€ ìš´ìœ¼ë¡œ ì´ë„ëŠ” í•˜ëŠ˜ì˜ ê¸°ìš´ì´ ë‚˜ë¥¼ ë”ìš± ê°•í•˜ê²Œ ë³´í˜¸í•˜ê³  ìˆìœ¼ë‹ˆ ë¨¸ì§€ì•Šì•„ ì‚¬ëŒì˜ ì¸ì—°ì´ ë³µì„ ê°€ì ¸ì˜¤ê¸° ì‹œì‘í•  ê²ƒì…ë‹ˆë‹¤."
        );
        relationParts.push(
          "ì¼ê³¼ ê´€ë ¨ëœ ë§Œë‚¨ì´ë‚˜ ì´ì„±ì ì¸ ë§Œë‚¨ì—ì„œ ì‚¬ëŒì„ êµ¬ë¶„í•˜ê³  ì„ íƒí•˜ëŠ”ë° ë‹¤ì†Œ ì–´ë ¤ì›€ê³¼ ê³ ë¯¼ì´ ìˆê² ì§€ë§Œ í¬ê²Œ ì‹ ê²½ì„ ì“°ì§€ ì•Šì•„ë„ ë˜ê² ìŠµë‹ˆë‹¤."
        );
        relationParts.push(
          "ì¬ë¬¼ê³¼ ê´€ë ¨ëœ ì œì˜ë¥¼ í•˜ê±°ë‚˜ ìì‹ ì˜ ê¸ˆì „ì ì¸ ì´ìµì„ ëª©ì ìœ¼ë¡œ í•˜ë©´ì„œ ì ‘ê·¼í•˜ëŠ” ë§Œë‚¨ì€ í° í™”ë¥¼ ë‹¹í•˜ê²Œ ë  ìˆ˜ ìˆëŠ” ì¢‹ì§€ ì•Šì€ ì¸ì—°ìœ¼ë¡œ ìƒê°í•˜ì‹œë©´ ë˜ë©°, ì¼ê³¼ ìƒê´€ì—†ì´ ì¼ìƒì ì¸ ë§Œë‚¨ ì¤‘ì—ì„œ ì´ë£¨ì–´ì§€ëŠ” ë§Œë‚¨ì€ ì¢‹ì€ ì¸ì—°ì„ ë§Œë‚  ìˆ˜ ìˆëŠ” ì§•ì¡°ì…ë‹ˆë‹¤."
        );
        relationParts.push(
          "ì¼ ì´ì™¸ì˜ ì¼ìƒì ì¸ ë§Œë‚¨ì´ë‚˜ ì´ì„±ì ì¸ ë§Œë‚¨ì€ ì¢‹ì€ ìš´ì„ ë§Œë“œëŠ” ì‹œë°œì ì´ê¸° ë•Œë¬¸ì— ë§Œë‚¨ì„ í†µí•´ì„œ ë„ì›€ì„ ì£¼ì–´ì•¼ í•  ì‚¬ëŒì€ ë„ì›€ì„ ë² í’€ì–´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤."
        );
        relationParts.push(
          "ë‚´ê°€ ë„ì›€ì„ ì£¼ëŠ” ì‚¬ëŒì€ ì¢‹ì€ ì¸ì—°ìœ¼ë¡œ ë‚¨ì„ ê²ƒì´ê³  ë‚˜ì¤‘ì— ë°˜ë“œì‹œ ë³´ì€ì„ ì…ê²Œ ë  ê²ƒì…ë‹ˆë‹¤."
        );
        relationParts.push(
          "ë‹¤ë§Œ, ì´ ì‹œê¸°ì— ë§Œë‚˜ëŠ” ì‚¬ëŒë“¤ ì¤‘ì— ìì‹ ì—ê²Œ ì¢‹ì€ ë§ë§Œ í•˜ê±°ë‚˜ ë‹¬ì½¤í•œ ì œì˜ë¥¼ í•˜ë©´ì„œ ë‹¤ê°€ì˜¤ëŠ” ì‚¬ëŒì€ ë°˜ë“œì‹œ ê²½ê³„í•˜ê³  ì£¼ì˜ê°€ í•„ìš”í•œ ì‚¬ëŒì´ ë  ê²ƒì…ë‹ˆë‹¤."
        );
        relationParts.push(
          "ì´ì„±ê³¼ì˜ ì• ì •ì´ íƒ€ì˜¤ë¥¼ ìˆ˜ ìˆëŠ” ì‹œê¸°ì´ë‹ˆ ì´ì„±ì„ ìƒˆë¡­ê²Œ ë§Œë‚˜ë©´ ì§§ì€ ì‹œê°„ ì•ˆì— ì •ì„ ëŠë¼ê³  ì‚¬ë‘ì˜ ê°ì •ì´ ì‹¹í‹€ ê²ƒì…ë‹ˆë‹¤."
        );
        relationParts.push(
          "ì• ì •ì´ ê¹Šì–´ì§€ê³  ì‚¬ë‘ì´ ë‘í„°ì›Œì ¸ì„œ ì„œë¡œê°€ ì •ì‹ ì ìœ¼ë¡œ ìœ„ë¡œë¥¼ í•´ì£¼ê³  ì˜ì§€í•˜ê²Œ ë  ê²ƒì…ë‹ˆë‹¤."
        );
        relationParts.push(
          "ì²­ì¶˜ ë‚¨ë…€ëŠ” ì˜¬í•´ì— ì¢‹ì€ ì¸ì—°ì„ ë§Œë‚˜ê²Œ ë  ìˆ˜ ìˆê³  ì• ì •ê´€ê³„ë¡œ ë°œì „í•˜ì§€ ì•Šë”ë¼ë„ ì¢‹ì€ ì¹œêµ¬ë‚˜ ì¢‹ì€ ì¸ê°„ê´€ê³„ë¡œ ì§€ì†ë  ìˆ˜ê°€ ìˆì„ ê²ƒì…ë‹ˆë‹¤."
        );
        const relation = casualizeText(relationParts.join(" "));

        return { total, money, work, family, relation };
      }

      function makeReportKeywords(person) {
        const out = [];
        if (person.topElem) out.push(`ê°•ì  ${person.topElem}`);
        if (person.weakElem) out.push(`ë³´ì™„ ${person.weakElem}`);
        if (person.dayStem) out.push(`ì¼ê°„ ${person.dayStem}`);
        if (person.strength) out.push(`ê°•ì•½ ${person.strength}`);
        if (person.seasonTopElem) out.push(`ì›”ë ¹ ${person.seasonTopElem}`);
        return out.length ? out.join(" Â· ") : "â€”";
      }

      function makeActionTips(person) {
        return {
          total: `í•µì‹¬ í–‰ë™: ${person.topElem} ê¸°ìš´ ì¤‘ì‹¬ìœ¼ë¡œ í•œ ê°€ì§€ ëª©í‘œë§Œ ì¡ê³  ëê¹Œì§€ ë°€ì–´.`,
          money: `ì§€ì¶œ ê´€ë¦¬: ${person.weakElem} ë³´ì™„ ë£¨í‹´ í•˜ë‚˜ë§Œ ê³ ì •í•˜ë©´ ìƒˆëŠ” ëˆì´ ì¤„ì–´.`,
          work: `ì—…ë¬´ ì „ëµ: ${person.topElem} ê°•ì ì„ ì‚´ë¦´ ìˆ˜ ìˆëŠ” ì—­í• ì„ ë¨¼ì € ë§¡ì•„.`,
          family: `ê±´ê°• ë£¨í‹´: ìˆ˜ë©´/ì‹ì‚¬ ì¤‘ í•˜ë‚˜ë§Œ ê³ ì •í•´ë„ ì²´ë ¥ê³¼ ë§ˆìŒì´ ì•ˆì •ë¼.`,
          relation: `ê´€ê³„ íŒ: ì„ ì„ ë¶„ëª…íˆ í•˜ê³  ì•½ì† ì§€í‚¤ë©´ ì˜¤í•´ê°€ ì¤„ì–´.`,
        };
      }

      const ELEM_MEANING = {
        ëª©: "ì„±ì¥/ê¸°íš",
        í™”: "ì¶”ì§„/í‘œí˜„",
        í† : "ì•ˆì •/ê´€ë¦¬",
        ê¸ˆ: "ê²°ê³¼/ë³´ìƒ",
        ìˆ˜: "ì •ë³´/í™˜ê²½",
      };
      function elemMeaning(elem) {
        const t = window.t || ((key, vars = {}) => key);
        const lang = window.currentLang || "ko";
        if (lang === "en") {
          const map = {
            ëª©: t("elemWood"),
            í™”: t("elemFire"),
            í† : t("elemEarth"),
            ê¸ˆ: t("elemMetal"),
            ìˆ˜: t("elemWater"),
          };
          return map[elem] || t("elemGeneric");
        }
        return ELEM_MEANING[elem] || t("elemGeneric");
      }
      function hasFinalConsonant(word) {
        if (!word) return false;
        const last = word[word.length - 1];
        const code = last.charCodeAt(0);
        if (code < 0xac00 || code > 0xd7a3) return false;
        return (code - 0xac00) % 28 !== 0;
      }
      function topicParticle(word) {
        return hasFinalConsonant(word) ? "ì€" : "ëŠ”";
      }
      function subjectParticle(word) {
        return hasFinalConsonant(word) ? "ì´" : "ê°€";
      }
      function objectParticle(word) {
        return hasFinalConsonant(word) ? "ì„" : "ë¥¼";
      }
      function scaleElements(elements, targetTotal = 150) {
        const keys = ["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"];
        const sum = keys.reduce((acc, k) => acc + (elements[k] || 0), 0);
        if (!sum) {
          return {
            scaled: { ëª©: 0, í™”: 0, í† : 0, ê¸ˆ: 0, ìˆ˜: 0 },
            total: targetTotal,
            sum: 0,
          };
        }
        const scale = targetTotal / sum;
        const scaled = {};
        let scaledSum = 0;
        keys.forEach((k) => {
          const v = Math.round((elements[k] || 0) * scale);
          scaled[k] = v;
          scaledSum += v;
        });
        const diff = targetTotal - scaledSum;
        if (diff !== 0) {
          const topKey = keys.sort(
            (a, b) => (elements[b] || 0) - (elements[a] || 0)
          )[0];
          scaled[topKey] = Math.max(0, (scaled[topKey] || 0) + diff);
        }
        return { scaled, total: targetTotal, sum };
      }
      function formatScaledElements(scaled) {
        const order = ["ëª©", "í™”", "í† ", "ê¸ˆ", "ìˆ˜"];
        return order.map((k) => `${k} ${scaled[k] ?? 0}`).join(" Â· ");
      }
      function elementPercent(elements, elem) {
        const total = Object.values(elements).reduce((a, b) => a + b, 0) || 1;
        return Math.round(((elements[elem] || 0) / total) * 100);
      }
      function getTenGodStats(person) {
        const stems = [
          person.yearStem,
          person.monthStem,
          person.dayStem,
          person.hourStem,
        ].filter(Boolean);
        const counts = {};
        stems.forEach((stem) => {
          const tg = tenGod(person.dayStem, stem);
          if (!tg) return;
          counts[tg] = (counts[tg] || 0) + 1;
        });
        const gwanCount = (counts["ì •ê´€"] || 0) + (counts["í¸ê´€"] || 0);
        const jaeCount = (counts["ì •ì¬"] || 0) + (counts["í¸ì¬"] || 0);
        const hasSikshin = (counts["ì‹ì‹ "] || 0) > 0;
        const hasJeongGwan = (counts["ì •ê´€"] || 0) > 0;
        const hasPyeonGwan = (counts["í¸ê´€"] || 0) > 0;
        return {
          counts,
          gwanCount,
          jaeCount,
          hasSikshin,
          gwanMix: hasJeongGwan && hasPyeonGwan,
        };
      }
      function yearModeFor(person, year) {
        const pillar = ganzhiYear(year);
        const yearElem = STEM_ELEM[pillar.stem];
        const mode = pickYearMode(
          relationElem(yearElem, person.topElem),
          relationElem(yearElem, person.weakElem)
        );
        const yearTenGod = person.dayStem
          ? tenGod(person.dayStem, pillar.stem)
          : "";
        return { year, pillar, yearElem, mode, yearTenGod };
      }
      function yearStrategy(mode) {
        const t = window.t || ((key, vars = {}) => key);
        if (mode === "push") return { todo: t("strategyPush"), avoid: t("avoidPush") };
        if (mode === "pushPlus")
          return { todo: t("strategyPushPlus"), avoid: t("avoidPushPlus") };
        if (mode === "recover")
          return { todo: t("strategyRecover"), avoid: t("avoidRecover") };
        if (mode === "brake") return { todo: t("strategyBrake"), avoid: t("avoidBrake") };
        return { todo: t("strategySteady"), avoid: t("avoidSteady") };
      }
      function renderStructuredReport(person, result) {
        const scaled = scaleElements(person.elements, 150);
        const profile = makeElementProfile(person.elements);
        const tenStats = getTenGodStats(person);
        const gwanSummary =
          tenStats.gwanCount >= 2
            ? "ê´€(ì •ê´€/í¸ê´€) ë‹¤ìˆ˜"
            : tenStats.gwanCount === 1
            ? "ê´€ ì¡´ì¬"
            : "ê´€ ì•½í•¨";
        const jaeSummary = tenStats.jaeCount <= 1 ? "ì¬ì„± ì•½í•¨" : "ì¬ì„± ë³´í†µ";
        const gwanSalSummary = tenStats.gwanMix ? "ê´€ì‚´í˜¼ì¡" : "ê´€ì‚´ ë‹¨ì •";
        const sikSummary = tenStats.hasSikshin ? "ì‹ì‹  ì¡´ì¬" : "ì‹ì‹  ì•½í•¨";
        const waterPct = elementPercent(person.elements, "ìˆ˜");
        const t = window.t || ((key, vars = {}) => key);
        const genderLabel = person.gender === "female" ? t("genderFemale") : t("genderMale");

        const branches = [
          person.yearBranch,
          person.monthBranch,
          person.dayBranch,
          person.hourBranch,
        ].filter(Boolean);
        const hap = listInternalPairs(branches, LIUHE);
        const chung = listInternalPairs(branches, CHUNG);
        const hyeong = listInternalHyeong(branches);
        const relationLine = `í•© ${hap.length ? hap.join(", ") : "â€”"} Â· ì¶© ${
          chung.length ? chung.join(", ") : "â€”"
        } Â· í˜• ${hyeong.length ? hyeong.join(", ") : "â€”"}`;

        const topMeaning = elemMeaning(person.topElem);
        const weakMeaning = elemMeaning(person.weakElem);
        const lang = window.currentLang || "ko";
        let coreDef, coreEvidence, coreDerived;
        if (lang === "en") {
          coreDef = `This fortune has prominent ${person.topElem} energy and weak ${person.weakElem} energy structure. ${topMeaning} is a strength, but conflicts repeatedly arise in ${weakMeaning}.`;
          coreEvidence = `Evidence: Five Elements distribution ${formatScaledElements(scaled.scaled)} (based on total ${scaled.total}). Strong/Mid/Weak ${profile.strong} / ${profile.mid} / ${profile.weak}.`;
          coreDerived = `Derived: Reacts quickly as energy concentrates toward ${person.topElem}, but judgment wavers when the weakness of ${person.weakElem} energy is revealed.`;
        } else {
          coreDef = `ì´ ì‚¬ì£¼ëŠ” ${person.topElem} ê¸°ìš´ì´ ë‘ë“œëŸ¬ì§€ê³  ${person.weakElem} ê¸°ìš´ì´ ì•½í•œ êµ¬ì¡°ë¡œ, ${topMeaning}${topicParticle(topMeaning)} ê°•ì ì´ì§€ë§Œ ${weakMeaning}ì—ì„œ ë°˜ë³µ ê°ˆë“±ì´ ìƒê¸°ëŠ” í˜•ì´ë‹¤.`;
          coreEvidence = `ê·¼ê±°: ì˜¤í–‰ ë¶„í¬ ${formatScaledElements(scaled.scaled)} (ì´ì  ${scaled.total} ê¸°ì¤€). ê°•/ì¤‘/ì•½ ${profile.strong} / ${profile.mid} / ${profile.weak}.`;
          coreDerived = `íŒŒìƒ: ${person.topElem} ê¸°ìš´ ìª½ìœ¼ë¡œ ëª°ë ¤ ë°˜ì‘ì€ ë¹ ë¥´ì§€ë§Œ, ${person.weakElem} ê¸°ìš´ì˜ ì•½ì ì´ ë“œëŸ¬ë‚˜ëŠ” ìˆœê°„ íŒë‹¨ì´ í”ë“¤ë¦°ë‹¤.`;
        }
        const topMeaningForConflict = elemMeaning(person.topElem);
        let conflictOne, conflictTwo;
        if (lang === "en") {
          conflictOne = `${person.topElem} energy is strong, so the habit of relying on ${topMeaningForConflict} grows. However, ${person.weakElem} energy is weak, so when ${weakMeaning} wavers, choices are reversed.`;
          conflictTwo = tenStats.gwanMix
            ? "Gwan is mixed, so the desire to follow rules and the desire to break free arise simultaneously, splitting decisions."
            : tenStats.gwanCount >= 2
            ? "Gwan is many, so it solidifies toward taking responsibility, but if strong, control obsession arises and conflicts repeat."
            : "Gwan is relatively weak, so standards easily waver and relationship/career choices become inconsistent.";
        } else {
          conflictOne = `${person.topElem} ê¸°ìš´ì´ ê°•í•´ì„œ ${topMeaningForConflict}ì— ì˜ì¡´í•˜ë ¤ëŠ” ìŠµê´€ì´ ì»¤ì§„ë‹¤. ê·¸ëŸ°ë° ${person.weakElem} ê¸°ìš´ì´ ì•½í•´ì„œ ${weakMeaning}${subjectParticle(weakMeaning)} í”ë“¤ë¦´ ë•Œ ì„ íƒì´ ë’¤ì§‘íŒë‹¤.`;
          conflictTwo = tenStats.gwanMix
            ? "ê´€ì´ í˜¼ì¡í•˜ë‹ˆê¹Œ ê·œì¹™ì„ ì§€í‚¤ë ¤ëŠ” ë§ˆìŒê³¼ ë²—ì–´ë‚˜ë ¤ëŠ” ë§ˆìŒì´ ë™ì‹œì— ì˜¬ë¼ì™€ ê²°ì •ì´ ê°ˆë¼ì§„ë‹¤."
            : tenStats.gwanCount >= 2
            ? "ê´€ì´ ë§ì•„ì„œ ì±…ì„ì„ ë– ì•ˆëŠ” ë°©í–¥ìœ¼ë¡œ êµ³ì–´ì§€ëŠ”ë°, ì‹ ê°•ì´ë©´ í†µì œ ì§‘ì°©ì´ ìƒê²¨ ê°ˆë“±ì´ ë°˜ë³µëœë‹¤."
            : "ê´€ì´ ì•½í•œ í¸ì´ë©´ ê¸°ì¤€ì´ ì‰½ê²Œ í”ë“¤ë ¤ ê´€ê³„/ì§ì—… ì„ íƒì´ ë“¤ì­‰ë‚ ì­‰í•´ì§„ë‹¤.";
        }

        let moneyRisk, workRisk, relationRisk;
        if (lang === "en") {
          moneyRisk = `Wealth: ${
            person.weakElem === "ê¸ˆ" || tenStats.jaeCount <= 1
              ? "Reward perception is weak, so money easily leaks."
              : "Income comes in but management easily becomes loose."
          } Evidence: ${jaeSummary} Â· ${person.weakElem} energy weak. Action: Quantify by month + create fixed settlement routine.`;
          workRisk = `Career: ${
            tenStats.gwanCount >= 2
              ? "Responsibility is excessively concentrated and roles expand."
              : "Role boundaries blur and consumed by miscellaneous tasks."
          } Evidence: ${gwanSummary}. Action: Fix role scope in writing and reject non-role tasks.`;
          relationRisk = `Relationships: ${
            hyeong.length || chung.length
              ? "Friction points repeat and emotions are easily hurt."
              : "Major conflicts are few but small sparks accumulate."
          } Evidence: ${relationLine}. Action: Organize emotions after 24 hours before speaking.`;
        } else {
          moneyRisk = `ì¬ë¬¼: ${
            person.weakElem === "ê¸ˆ" || tenStats.jaeCount <= 1
              ? "ë³´ìƒ ì²´ê°ì´ ì•½í•´ì„œ ëˆì´ ìƒˆê¸° ì‰½ë‹¤."
              : "ìˆ˜ì…ì€ ë“¤ì–´ì˜¤ëŠ”ë° ê´€ë¦¬ê°€ ëŠìŠ¨í•´ì§€ê¸° ì‰½ë‹¤."
          } ê·¼ê±°: ${jaeSummary} Â· ${person.weakElem} ê¸°ìš´ ì•½. í–‰ë™: ì›” ê¸°ì¤€ ìˆ˜ì¹˜í™” + ê³ ì • ì •ì‚° ë£¨í‹´ì„ ë§Œë“¤ì–´.`;
          workRisk = `ì§ì—…: ${
            tenStats.gwanCount >= 2
              ? "ì±…ì„ì´ ê³¼ë„í•˜ê²Œ ëª°ë¦¬ê³  ì—­í• ì´ í™•ì¥ëœë‹¤."
              : "ì—­í•  ê²½ê³„ê°€ íë ¤ì ¸ ì¡ë¬´ë¡œ ì†Œëª¨ëœë‹¤."
          } ê·¼ê±°: ${gwanSummary}. í–‰ë™: ì—­í•  ë²”ìœ„ë¥¼ ë¬¸ì„œë¡œ ê³ ì •í•˜ê³ , ì•„ë‹Œ ì¼ì€ ê±°ì ˆí•´.`;
          relationRisk = `ê´€ê³„: ${
            hyeong.length || chung.length
              ? "ë§ˆì°° í¬ì¸íŠ¸ê°€ ë°˜ë³µë¼ ê°ì •ì´ ì‰½ê²Œ ìƒí•œë‹¤."
              : "í° ì¶©ëŒì€ ì ì§€ë§Œ ì‘ì€ ë¶ˆì”¨ê°€ ìŒ“ì¸ë‹¤."
          } ê·¼ê±°: ${relationLine}. í–‰ë™: ê°ì •ì€ 24ì‹œê°„ ë’¤ì— ì •ë¦¬í•´ì„œ ë§í•´.`;
        }

        const strongElem =
          profile.strong !== "â€”" ? profile.strong : person.topElem;
        const midElem = profile.mid !== "â€”" ? profile.mid : person.topElem;
        let strengthUse, workStyle, romanceReason, matchCondition, jobDirection, moneyDirection;
        if (lang === "en") {
          strengthUse = `Strong Five Elements (${strongElem}) are highly efficient when used in ${strongElem.split(" Â· ").map((e) => elemMeaning(e)).join("Â·")}. Mid Five Elements (${midElem}) should be attached to assist execution speed and maintenance.`;
          workStyle = `Work processing method is "gather information -> set criteria -> push through at once." Career is favorable in planning/operations/management with repetition and structure.`;
          romanceReason = `Romance is difficult because ${jaeSummary} and excessive ${person.topElem} energy cause confidence to attach late and reactions to become excessive.`;
          matchCondition = `A good match is someone with few emotional fluctuations, consistent life rhythm, and who keeps promises rather than just words.`;
          jobDirection = `Stable workplace is favorable because ${gwanSummary} structure produces results within rules.`;
          moneyDirection = `Investment/adventure is unfavorable because ${
            person.weakElem === "ê¸ˆ" || tenStats.jaeCount <= 1
              ? "result perception is weak, delaying profit/loss judgment"
              : "risk management becomes loose"
          }. Wealth increases through structure, not speed: fix spending standards, income distribution, settlement cycle.`;
        } else {
          strengthUse = `ê°•í•œ ì˜¤í–‰(${strongElem})ì€ ${strongElem.split(" Â· ").map((e) => elemMeaning(e)).join("Â·")}ì— ì“°ë©´ íš¨ìœ¨ì´ ë†’ë‹¤. ì¤‘ê°„ ì˜¤í–‰(${midElem})ì€ ì‹¤í–‰ ì†ë„ì™€ ìœ ì§€ë ¥ì„ ë³´ì¡°í•˜ëŠ” ìª½ìœ¼ë¡œ ë¶™ì—¬.`;
          workStyle = `ì¼ ì²˜ë¦¬ ë°©ì‹ì€ "ì •ë³´ë¥¼ ëª¨ìœ¼ê³  -> ê¸°ì¤€ì„ ìë¥´ê³  -> í•œ ë²ˆì— ë°€ì–´ë¶™ì´ê¸°"ê°€ ë§ë‹¤. ì»¤ë¦¬ì–´ëŠ” ë°˜ë³µì„±ê³¼ êµ¬ì¡°ê°€ ìˆëŠ” ê¸°íš/ìš´ì˜/ê´€ë¦¬ ìª½ì´ ìœ ë¦¬í•˜ë‹¤.`;
          romanceReason = `ì—°ì• ê°€ ì–´ë ¤ìš´ ì´ìœ ëŠ” ${jaeSummary}ê³¼ ${person.topElem} ê¸°ìš´ ê³¼ë‹¤ë¡œ í™•ì‹ ì´ ëŠ¦ê²Œ ë¶™ê³ , ë°˜ì‘ì´ ê³¼í•´ì§€ê¸° ë•Œë¬¸ì´ë‹¤.`;
          matchCondition = `ì˜ ë§ëŠ” ìƒëŒ€ëŠ” ê°ì • ê¸°ë³µì´ ì ê³  ìƒí™œ ë¦¬ë“¬ì´ ì¼ì •í•˜ë©°, ë§ë³´ë‹¤ ì•½ì†ì„ ì§€í‚¤ëŠ” ì‚¬ëŒì´ë‹¤.`;
          jobDirection = `ì•ˆì •ì ì¸ ì§ì¥ì´ ìœ ë¦¬í•œ ì´ìœ ëŠ” ${gwanSummary} êµ¬ì¡°ê°€ ê·œì¹™ ì•ˆì—ì„œ ì„±ê³¼ë¥¼ ë‚´ëŠ” ë°©ì‹ì´ê¸° ë•Œë¬¸ì´ë‹¤.`;
          moneyDirection = `íˆ¬ì/ëª¨í—˜ì´ ë¶ˆë¦¬í•œ ì´ìœ ëŠ” ${
            person.weakElem === "ê¸ˆ" || tenStats.jaeCount <= 1
              ? "ê²°ê³¼ ì²´ê°ì´ ì•½í•´ ì†ìµ íŒë‹¨ì´ ëŠ¦ì–´ì§€ê¸° ë•Œë¬¸"
              : "ë¦¬ìŠ¤í¬ ê´€ë¦¬ê°€ ëŠìŠ¨í•´ì§€ê¸° ë•Œë¬¸"
          }ì´ë‹¤. ì¬ë¬¼ì€ ì†ë„ê°€ ì•„ë‹ˆë¼ êµ¬ì¡°ë¡œ ëŠ˜ë¦°ë‹¤: ì§€ì¶œ ê¸°ì¤€, ìˆ˜ì… ë¶„ë°°, ì •ì‚° ì£¼ê¸°ë¥¼ ê³ ì •í•´.`;
        }

        const tzOffsetMinutes = person.tzOffsetMinutes ?? 540;
        const dstMode = person.dstMode || "off";
        const flows = buildYearFlows(person, tzOffsetMinutes, dstMode);
        const decades = summarizeDecades(flows).slice(0, 2);
        const decadeLines = decades.map((d) => {
          const strategy = yearStrategy(d.mode);
          if (lang === "en") {
            return `${d.range}: ${yearModeText(d.mode)}. To do: ${strategy.todo}. To avoid: ${strategy.avoid}.`;
          }
          return `${d.range}: ${yearModeText(d.mode)}. í•´ì•¼ í•  ê²ƒ: ${strategy.todo}. í”¼í•´ì•¼ í•  ê²ƒ: ${strategy.avoid}.`;
        });
        const y2026 = yearModeFor(person, 2026);
        const y2026Strategy = yearStrategy(y2026.mode);
        let yearLine2026;
        if (lang === "en") {
          yearLine2026 = `2026: ${yearModeText(y2026.mode)}. To do: ${y2026Strategy.todo}. To avoid: ${y2026Strategy.avoid}.`;
        } else {
          yearLine2026 = `2026ë…„: ${yearModeText(y2026.mode)}. í•´ì•¼ í•  ê²ƒ: ${y2026Strategy.todo}. í”¼í•´ì•¼ í•  ê²ƒ: ${y2026Strategy.avoid}.`;
        }

        let finalAttitudes;
        if (lang === "en") {
          finalAttitudes = [
            "Fix judgment criteria with rules, not emotions.",
            "Fix routines rather than speed.",
            "Relationships are maintained by keeping promises and setting clear boundaries.",
          ];
        } else {
          finalAttitudes = [
            "íŒë‹¨ ê¸°ì¤€ì€ ê°ì •ì´ ì•„ë‹ˆë¼ ë£°ë¡œ ê³ ì •í•´.",
            "ì†ë„ë³´ë‹¤ ë£¨í‹´ì„ ê³ ì •í•´.",
            "ê´€ê³„ëŠ” ì•½ì† ì§€í‚¤ê³  ì„ ì„ ë¶„ëª…íˆ í•˜ë©´ ìœ ì§€ë¼.",
          ];
        }

        let waterPctNote;
        if (lang === "en") {
          waterPctNote = `Water energy ratio: ${waterPct}% Â· This ratio is greatly influenced by environment/situation, so setting standards first reduces wavering.`;
        } else {
          waterPctNote = `ìˆ˜ ê¸°ìš´ ë¹„ì¤‘: ${waterPct}% Â· ì´ ë¹„ì¤‘ì€ í™˜ê²½/ìƒí™© ì˜í–¥ì´ í° í¸ì´ë¼ ê¸°ì¤€ì„ ë¨¼ì € ì¡ì•„ì•¼ í”ë“¤ë¦¼ì´ ì¤„ì–´.`;
        }
        let finalNote;
        if (lang === "en") {
          finalNote = "Walking calmly also builds good results.";
        } else {
          finalNote = "ì°¨ë¶„íˆ ê±¸ì–´ê°€ë„ ì¢‹ì€ ê²°ê³¼ê°€ ìŒ“ì—¬.";
        }
        return `
          <div class="rule-card">
            <div class="section-title">${t("reportCoreTitle")}</div>
            <div class="mini">${t("reportBasicInfo", {
              gender: genderLabel,
              dayStem: person.dayStem || "â€”",
              dayElem: person.dayElem || "â€”",
              strength: person.strength || "â€”",
              relationLine: relationLine
            })}</div>
            <br>
            <div class="report-section">
              <h3>${t("reportSection1")}</h3>
              <p class="mini">${escapeHtml(softenText(coreDef))}</p>
              <p class="mini">${escapeHtml(softenText(coreEvidence))}</p>
              <p class="mini">${escapeHtml(softenText(coreDerived))}</p>
              <p class="mini">${t("reportNote1")}</p>
            </div>
            <br>
            <div class="report-section">
              <h3>${t("reportSection2")}</h3>
              <p class="mini">1) ${escapeHtml(softenText(conflictOne))}</p>
              <p class="mini">2) ${escapeHtml(softenText(conflictTwo))}</p>
              <p class="mini">${t("reportNote2")}</p>
            </div>
            <br>
            <div class="report-section">
              <h3>${t("reportSection3")}</h3>
              <p class="mini">${escapeHtml(softenText(moneyRisk))}</p>
              <p class="mini">${escapeHtml(softenText(workRisk))}</p>
              <p class="mini">${escapeHtml(softenText(relationRisk))}</p>
              <p class="mini">${t("reportNote3")}</p>
            </div>
            <br>
            <div class="report-section">
              <h3>${t("reportSection4")}</h3>
              <p class="mini">${escapeHtml(softenText(strengthUse))}</p>
              <p class="mini">${escapeHtml(softenText(workStyle))}</p>
              <p class="mini">${escapeHtml(softenText(waterPctNote))}</p>
              <p class="mini">${t("reportNote4")}</p>
            </div>
            <br>
            <div class="report-section">
              <h3>${t("reportSection5")}</h3>
              <p class="mini">${escapeHtml(softenText(romanceReason))}</p>
              <p class="mini">${escapeHtml(softenText(matchCondition))}</p>
              <p class="mini">${t("reportNote5")}</p>
            </div>
            <br>
            <div class="report-section">
              <h3>${t("reportSection6")}</h3>
              <p class="mini">${escapeHtml(softenText(jobDirection))}</p>
              <p class="mini">${escapeHtml(softenText(moneyDirection))}</p>
              <p class="mini">${t("reportNote6")}</p>
            </div>
            <br>
            <div class="report-section">
              <h3>${t("reportSection7")}</h3>
              <p class="mini">${escapeHtml(softenText(decadeLines.join(" ")))}</p>
              <p class="mini">${escapeHtml(softenText(yearLine2026))}</p>
              <p class="mini">${t("reportNote7")}</p>
            </div>
            <br>
            <div class="report-section">
              <h3>${t("reportSection8")}</h3>
              <p class="mini">${escapeHtml(softenText(finalAttitudes.join(" ")))}</p>
              <p class="mini">${finalNote}</p>
            </div>
          </div>
        `;
      }

      const ELEM_CLASS = {
        ëª©: "wood",
        í™”: "fire",
        í† : "earth",
        ê¸ˆ: "metal",
        ìˆ˜: "water",
      };
      function elemClass(elem) {
        return ELEM_CLASS[elem] ? `e-${ELEM_CLASS[elem]}` : "";
      }
      function tenGodChip(label, text, elem) {
        const cls = elemClass(elem);
        return `<span class="chip ${cls}"><b>${escapeHtml(
          label
        )}</b> ${escapeHtml(text)}</span>`;
      }

      function renderReportCard(a, b) {
        const blocks = [];
        if (a) blocks.push(renderReportBlock(a, state.aResult));
        if (b) blocks.push(renderReportBlock(b, state.bResult));
        reportContent.innerHTML = blocks.join("");

        // ì›”ë³„ ì„¸ìš´ ì¹´ë“œì˜ ê³µìœ  ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        setTimeout(() => {
          reportContent.querySelectorAll("[data-month]").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const monthIndex = parseInt(btn.getAttribute("data-month-index"));
              const person = a || b;
              if (person) {
                const monthData = makeMonthlyLuck(person)[monthIndex];
                await shareMonthlyCard(monthData);
              }
            });
          });
        }, 100);
      }

      function renderReportBlock(person, result) {
        if (!result) return "";
        return renderStructuredReport(person, result);
      }

      function getLocalNowYear(tzOffsetMinutes, dstMode) {
        const parts = toLocalDateParts(new Date(), tzOffsetMinutes, dstMode);
        return parts.y;
      }

      function pickYearMode(relTop, relWeak) {
        let mode = "steady";
        if (relTop === "ìƒ" || relTop === "ë™") mode = "push";
        if (relWeak === "ìƒ" || relWeak === "ë™")
          mode = mode === "push" ? "pushPlus" : "recover";
        if (relTop === "ê·¹" || relTop === "ëˆŒë¦¼") mode = "brake";
        return mode;
      }

      function yearModeText(mode) {
        const t = window.t || ((key, vars = {}) => key);
        const map = {
          push: t("yearModePush"),
          pushPlus: t("yearModePushPlus"),
          recover: t("yearModeRecover"),
          brake: t("yearModeBrake"),
          steady: t("yearModeSteady"),
        };
        return map[mode] || t("yearModeSteady");
      }

      function monthModeText(mode) {
        const t = window.t || ((key, vars = {}) => key);
        const map = {
          push: t("monthModePush"),
          pushPlus: t("monthModePushPlus"),
          recover: t("monthModeRecover"),
          brake: t("monthModeBrake"),
          steady: t("monthModeSteady"),
        };
        return map[mode] || t("monthModeSteady");
      }

      function formatMonthTags(tags) {
        if (!tags || !Array.isArray(tags) || tags.length < 3) return "";
        const [luckTag, mode, seasonElem] = tags;
        const luckText =
          luckTag === "ê¸¸" ? "ê¸¸ìš´" : luckTag === "í‰" ? "í‰ìš´" : "ì¤‘ìš´";
        const modeText = monthModeText(mode);
        const elemText = `${seasonElem} ê¸°ìš´`;

        // ìƒ‰ìƒ í´ë˜ìŠ¤ ê²°ì •
        const luckClass =
          luckTag === "ê¸¸"
            ? "chip e-wood"
            : luckTag === "í‰"
            ? "chip e-fire"
            : "chip";
        const elemClassKey =
          ELEM_CLASS && ELEM_CLASS[seasonElem] ? ELEM_CLASS[seasonElem] : "";
        const elemClass = elemClassKey ? `chip e-${elemClassKey}` : "chip";

        return `
          <span class="${luckClass}" style="font-size: 11px; padding: 4px 10px; white-space: nowrap;">${luckText}</span>
          <span class="chip" style="font-size: 11px; padding: 4px 10px; white-space: nowrap;">${modeText}</span>
          <span class="${elemClass}" style="font-size: 11px; padding: 4px 10px; white-space: nowrap;">${elemText}</span>
        `;
      }

      function buildYearFlows(person, tzOffsetMinutes, dstMode) {
        const startYear = getLocalNowYear(tzOffsetMinutes, dstMode);
        const flows = [];
        for (let i = 0; i < 10; i++) {
          const year = startYear + i;
          const pillar = ganzhiYear(year);
          const yearElem = STEM_ELEM[pillar.stem];
          const relTop = relationElem(yearElem, person.topElem);
          const relWeak = relationElem(yearElem, person.weakElem);
          const mode = pickYearMode(relTop, relWeak);
          const yearTenGod = person.dayStem
            ? tenGod(person.dayStem, pillar.stem)
            : "";
          flows.push({
            year,
            pillar,
            yearElem,
            mode,
            yearTenGod,
          });
        }
        return flows;
      }

      function summarizeDecades(flows) {
        const buckets = {};
        flows.forEach((f) => {
          const start = f.year - (f.year % 10);
          if (!buckets[start]) buckets[start] = [];
          buckets[start].push(f);
        });
        return Object.entries(buckets).map(([start, list]) => {
          const counts = list.reduce((acc, cur) => {
            acc[cur.mode] = (acc[cur.mode] || 0) + 1;
            return acc;
          }, {});
          const topMode = Object.entries(counts).sort(
            (a, b) => b[1] - a[1]
          )[0][0];
          return {
            range: `${start}~${Number(start) + 9}`,
            mode: topMode,
          };
        });
      }

      function renderLuckFlowCard(a, b) {
        const blocks = [];
        if (a) blocks.push(renderLuckBlock(a));
        if (b) blocks.push(renderLuckBlock(b));
        luckFlow.innerHTML = blocks.join("");
      }

      function renderLuckBlock(person) {
        const tzOffsetMinutes = person.tzOffsetMinutes ?? 540;
        const dstMode = person.dstMode || "off";
        const flows = buildYearFlows(person, tzOffsetMinutes, dstMode);
        const decades = summarizeDecades(flows);
        const decadeSummary = decades
          .map((d) => `${d.range}: ${yearModeText(d.mode)}`)
          .join(" Â· ");
        const daewoonNarrative = `ëŒ€ìš´ì€ 10ë…„ ë‹¨ìœ„ë¡œ íë¥´ëŠ” í° ë¬¼ì¤„ê¸°ì•¼. ${
          decadeSummary || "â€”"
        }ì˜ ê²°ì´ ì´ì–´ì§€ë‹ˆê¹Œ, ì´ ì‹œê¸°ì—ëŠ” ë°©í–¥ì„ í¬ê²Œ ì¡ê³  í”ë“¤ë¦¼ì„ ì¤„ì—¬ì•¼ í•´. í° ê²°ì •ì€ ëŒ€ìš´ íë¦„ì— ë§ì¶°ì•¼ ê¸¸ì´ ì—´ë ¤.`;
        const yearLines = flows
          .map(
            (f) =>
              `${f.year}ë…„ ${f.pillar.text}(${f.yearElem}) Â· ${yearModeText(
                f.mode
              )}`
          )
          .join("<br/>");
        const sewoonNarrative =
          "ì„¸ìš´ì€ í•´ë§ˆë‹¤ ê²°ì´ ë‹¬ë¼ì§€ëŠ” íë¦„ì´ì•¼. ê°•í•œ í•´ì—ëŠ” í™•ì¥ê³¼ ì‹¤í–‰ì„, ì•½í•œ í•´ì—ëŠ” ì •ë¦¬ì™€ íšŒë³µì„ íƒí•´ì•¼ ì‹¤ì´ ì ì–´. í•´ë§ˆë‹¤ ê¸°ìš´ì´ ë°”ë€Œë‹ˆê¹Œ ê°™ì€ ë°©ë²•ì„ ê³ ì§‘í•˜ì§€ ë§ê³  íë¦„ì— ë§ì¶° ì¡°ìœ¨í•˜ëŠ” ê²Œ ì¢‹ì•„.";

        return `
          <div class="rule-card">
            <div class="mini">ëŒ€ìš´(10ë…„): ${escapeHtml(daewoonNarrative)}</div>
            <div class="mini">ì„¸ìš´(10ë…„): ${yearLines}</div>
            <div class="mini">${escapeHtml(sewoonNarrative)}</div>
          </div>
        `;
      }

      function setResultVisibility(mode) {
        if (mode === "today") {
          // ì˜¤ëŠ˜ ìš´ì„¸ ëª¨ë“œ: ì˜¤ëŠ˜ ìš´ì„¸ ì¹´ë“œë§Œ í‘œì‹œ
          resultElementsCard.classList.add("hidden");
          resultDeepCard.classList.add("hidden");
          resultLuckCard.classList.add("hidden");
          resultTodayCard.classList.remove("hidden");
          resultRadarCard.classList.add("hidden");
          resultABCard.classList.add("hidden");
          resultRulesCard.classList.add("hidden");
          resultMonthlyCard.classList.add("hidden");
          resultReportCard.classList.add("hidden");
          resultSummaryCard.classList.add("hidden");
        } else {
          resultElementsCard.classList.toggle("hidden", !state.A);
          resultDeepCard.classList.toggle("hidden", !state.A);
          resultLuckCard.classList.toggle("hidden", !state.A);
          resultTodayCard.classList.toggle("hidden", mode === "newyear");
          resultRadarCard.classList.toggle("hidden", mode !== "compat");
          resultABCard.classList.toggle("hidden", mode !== "compat");
          resultRulesCard.classList.toggle("hidden", mode !== "compat");
          resultMonthlyCard.classList.toggle("hidden", mode !== "newyear");
          resultReportCard.classList.toggle("hidden", mode === "today");
          resultSummaryCard.classList.toggle("hidden", mode === "today");
        }
      }

      function renderCompat() {
        const a = buildPerson(state.A);
        const b = buildPerson(state.B);
        const firedRules = evaluateRules(a, b);
        const sectionScores = calcSectionScores(firedRules);
        const totalScore = calcTotalFromSections(sectionScores);
        const coupleElements = combineElements(a.elements, b.elements);
        const coupleBreakdown = combineBreakdown(
          state.aResult?.elements?.breakdown,
          state.bResult?.elements?.breakdown
        );
        const coupleStats = getTopWeak(coupleElements);

        resultTitle.textContent = "ê¶í•© ìš”ì•½";
        const includeHourMode =
          state.A?.includeHour === state.B?.includeHour
            ? Boolean(state.A?.includeHour)
            : "partial";
        renderElementsAnalysis(coupleElements, coupleBreakdown, {
          hiddenMode:
            state.aResult?.input?.hiddenMode === "on" ||
            state.bResult?.input?.hiddenMode === "on"
              ? "on"
              : "off",
          includeHour: includeHourMode,
        });
        renderDeepAnalysisCard(a, b);
        renderLuckFlowCard(a, b);
        renderSummary(totalScore, firedRules, null, coupleElements);
        renderTodayCoupleBox(a, b);
        renderRadar(sectionScores);
        renderRules(firedRules, null, {
          topElem: coupleStats.top,
          weakElem: coupleStats.weak,
          A_topElem: a.topElem,
          B_topElem: b.topElem,
          A_weakElem: a.weakElem,
          B_weakElem: b.weakElem,
          A_branch: a.dayBranch,
          B_branch: b.dayBranch,
          A_season: a.seasonTopElem,
          B_season: b.seasonTopElem,
        });
        // ê¶í•© ëª¨ë“œì—ì„œëŠ” ì›”ë³„ ì‹ ë…„ìš´ì„¸ë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ
        renderReportCard(a, b);
        renderPillars(aPillarsEl, state.aResult);
        renderPillars(bPillarsEl, state.bResult);

        return { totalScore, firedRules, coupleElements };
      }

      function renderNewYear() {
        const a = buildPerson(state.A);
        const { top, weak } = getTopWeak(a.elements);
        const t = window.t || ((key, vars = {}) => key);
        resultTitle.textContent = t("resultNewYearSummary");
        renderElementsAnalysis(a.elements, state.aResult?.elements?.breakdown, {
          hiddenMode: state.aResult?.input?.hiddenMode,
          includeHour: state.A?.includeHour,
          boundaryText: state.A?.boundaryText,
          birthText: state.aResult?.input?.local
            ? `${state.aResult.input.local} (${state.A?.hourBranch || "â€”"})`
            : "",
          anchorKey: state.aResult?.elements?.anchor?.key,
          anchorApplied: state.aResult?.elements?.anchor?.applied,
          dayElem: a.dayElem,
        });
        renderDeepAnalysisCard(a, null);
        renderLuckFlowCard(a, null);
        totalScoreEl.textContent = "â€”";
        summarySub.textContent = "2026 íë¦„ Â· ìƒì„¸ í•´ì„";
        summaryMain.textContent = `2026ë…„ì€ ${top} ê¸°ìš´ì´ í˜ì„ ì–»ê³ , ${weak}ì„(ë¥¼) ë³´ì™„í•˜ë©´ ë³µì´ ë”°ë¥´ëŠ” í•´ì•¼. ì¼ê°„ ${
          a.dayStem || "â€”"
        }ì˜ ê°•ì•½ì€ ${
          a.strength
        }ì´ë‹ˆê¹Œ, ë¬´ë¦¬í•œ í™•ì¥ë³´ë‹¤ ê¸°ì¤€ì„ ì„¸ìš°ê³  í•œ ê°€ì§€ ëª©í‘œë¥¼ ëê¹Œì§€ ë°€ì–´ì•¼ ì‹¤ì´ ì ì–´. ì„¸ìš´ì˜ ê²°ì„ ì½ê³  ì†ë„ë¥¼ ì¡°ì ˆí•˜ë©´ ê¸°íšŒê°€ ìŒ“ì´ê³  ê²°ê³¼ê°€ ë‹¨ë‹¨í•´ì ¸.`;
        summaryPills.innerHTML = [
          `í•µì‹¬ ì˜¤í–‰: ${top}`,
          `ì•½í•œ ì˜¤í–‰: ${weak}`,
          "2026 ì›”ë³„ íë¦„",
        ]
          .map((p) => `<span class="pill">${escapeHtml(p)}</span>`)
          .join("");

        todayCoupleLine.textContent = "â€”";
        todayCoupleMeta.textContent = "";
        renderMonthly(a);
        renderReportCard(a, null);
        renderPillars(aPillarsEl, state.aResult);
        bPillarsEl.textContent = "";

        return { totalScore: null, coupleElements: a.elements };
      }

      function renderTodayOnly() {
        const a = buildPerson(state.A);
        const todayLuck = todayLuckLine(a);

        // ì˜¤ëŠ˜ ìš´ì„¸ ì¹´ë“œì— ìƒì„¸ ë‚´ìš© í‘œì‹œ
        todayCoupleLine.textContent = todayLuck.main;
        todayCoupleMeta.innerHTML = `
          <div style="margin-top: 20px; padding: 20px; background: rgba(99, 102, 241, 0.04); border-radius: 12px; border-left: 4px solid var(--accent);">
            <p style="font-size: 16px; line-height: 1.9; margin: 0 0 16px 0; color: rgba(15, 23, 42, 0.9); text-align: left;">
              ${escapeHtml(todayLuck.detail)}
            </p>
            <div style="margin-top: 16px; padding: 14px; background: rgba(34, 197, 94, 0.08); border-radius: 8px; border-left: 3px solid rgba(34, 197, 94, 0.5);">
              <p style="font-size: 15px; margin: 0; line-height: 1.8; font-weight: 600; color: rgba(15, 23, 42, 0.9); text-align: left;">
                ${escapeHtml(todayLuck.tip)}
              </p>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: rgba(255, 255, 255, 0.6); border-radius: 8px; border: 1px solid rgba(15, 23, 42, 0.08);">
              <p style="font-size: 14px; margin: 0; line-height: 1.8; color: rgba(15, 23, 42, 0.8); text-align: left;">
                <strong style="color: rgba(15, 23, 42, 0.9);">ì˜¤ëŠ˜ ì˜¤í–‰:</strong> ${escapeHtml(
                  todayLuck.todayElem
                )}<br/>
                <strong style="color: rgba(15, 23, 42, 0.9);">ë‚´ ê°•ì :</strong> ${escapeHtml(
                  a.topElem
                )} Â· <strong style="color: rgba(15, 23, 42, 0.9);">ë‚´ ì•½ì :</strong> ${escapeHtml(
          a.weakElem
        )}
              </p>
            </div>
          </div>
        `;
      }

      function renderAll() {
        if (!state.A) return;
        setResultVisibility(state.mode);
        if (state.mode === "compat") return renderCompat();
        if (state.mode === "newyear") return renderNewYear();
        return renderTodayOnly();
      }

      /* ======================================================
  10. ê³µìœ  ì¹´ë“œ
====================================================== */
      function roundRect(ctx, x, y, w, h, r, fill) {
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.arcTo(x + w, y, x + w, y + h, r);
        ctx.arcTo(x + w, y + h, x, y + h, r);
        ctx.arcTo(x, y + h, x, y, r);
        ctx.arcTo(x, y, x + w, y, r);
        ctx.closePath();
        ctx.fillStyle = fill;
        ctx.fill();
      }

      function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        const words = text.split(" ");
        let line = "";
        let lineCount = 1;
        let currentY = y;
        for (let i = 0; i < words.length; i++) {
          const test = line + words[i] + " ";
          if (ctx.measureText(test).width > maxWidth && i > 0) {
            ctx.fillText(line, x, currentY);
            line = words[i] + " ";
            currentY += lineHeight;
            lineCount++;
          } else {
            line = test;
          }
        }
        ctx.fillText(line, x, currentY);
        return lineCount;
      }

      async function generateShareCard(payload) {
        const c = document.getElementById("shareCanvas");
        const ctx = c.getContext("2d");

        const g = ctx.createLinearGradient(0, 0, 0, c.height);
        g.addColorStop(0, "#0b1621");
        g.addColorStop(0.5, "#101f2e");
        g.addColorStop(1, "#14273b");
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, c.width, c.height);

        const pad = 70;
        const cardX = pad;
        const cardY = pad;
        const cardW = c.width - pad * 2;
        const cardH = c.height - pad * 2;
        roundRect(
          ctx,
          cardX,
          cardY,
          cardW,
          cardH,
          40,
          "rgba(255,255,255,0.92)"
        );

        let currentY = cardY + 80;

        // ì‹ ë…„ìš´ì„¸ ì¹´ë“œ ë ˆì´ì•„ì›ƒ
        if (payload.mode === "newyear") {
          ctx.fillStyle = "#0f172a";
          ctx.font = "800 52px IBM Plex Sans KR";
          ctx.fillText(payload.title, cardX + 50, cardY + 100);

          let y = cardY + 180;
          if (payload.summary) {
            ctx.font = "700 28px IBM Plex Sans KR";
            ctx.fillStyle = "rgba(15,23,42,0.9)";
            const summaryLines = wrapText(
              ctx,
              payload.summary,
              cardX + 50,
              y,
              cardW - 100,
              38
            );
            y += summaryLines * 38 + 40;
          }

          if (payload.lines && payload.lines.length) {
            payload.lines.forEach((line) => {
              if (!line || line.trim() === "") {
                y += 16; // ë¹ˆ ì¤„ì€ ê°„ê²©ë§Œ ì¶”ê°€
                return;
              }
              // "ğŸ“… ì›”ë³„ íë¦„:" ê°™ì€ ì œëª©ì€ ë” í¬ê²Œ
              if (line.includes("ğŸ“…") || line.includes("ì›”ë³„")) {
                ctx.font = "700 26px IBM Plex Sans KR";
                ctx.fillStyle = "rgba(15,23,42,0.9)";
                y += 12;
              } else if (line.includes("ì›”:")) {
                // ì›”ë³„ í•­ëª©ì€ ì‘ê²Œ
                ctx.font = "500 20px IBM Plex Sans KR";
                ctx.fillStyle = "rgba(15,23,42,0.75)";
              } else {
                ctx.font = "600 24px IBM Plex Sans KR";
                ctx.fillStyle = "rgba(15,23,42,0.82)";
              }
              const lineCount = wrapText(
                ctx,
                line.includes("ì›”:") ? `  ${line}` : `â€¢ ${line}`,
                cardX + 50,
                y,
                cardW - 100,
                line.includes("ì›”:") ? 28 : 34
              );
              y +=
                lineCount * (line.includes("ì›”:") ? 28 : 34) +
                (line.includes("ì›”:") ? 6 : 12);
            });
          }

          // ì˜¤í–‰ ì •ë³´ë¥¼ í•˜ë‹¨ ì¤‘ì•™ì— ë°°ì¹˜
          if (payload.topElem && payload.weakElem) {
            ctx.font = "600 22px IBM Plex Sans KR";
            ctx.fillStyle = "rgba(15,23,42,0.7)";
            const elemText = `í•µì‹¬ ì˜¤í–‰: ${payload.topElem} Â· ì•½í•œ ì˜¤í–‰: ${payload.weakElem}`;
            const elemWidth = ctx.measureText(elemText).width;
            ctx.fillText(
              elemText,
              cardX + (cardW - elemWidth) / 2,
              cardY + cardH - 100
            );
          }

          // funnyfunny.cloudë¥¼ ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— ë°°ì¹˜
          ctx.font = "600 20px IBM Plex Sans KR";
          ctx.fillStyle = "rgba(15,23,42,0.5)";
          const brandText = "funnyfunny.cloud";
          const brandWidth = ctx.measureText(brandText).width;
          ctx.fillText(
            brandText,
            cardX + cardW - brandWidth - 50,
            cardY + cardH - 50
          );
        } else if (payload.main && payload.detail && payload.tip) {
          // ì˜¤ëŠ˜ ìš´ì„¸ ëª¨ë“œì¼ ë•Œ ê¹”ë”í•œ ë ˆì´ì•„ì›ƒ
          // ì œëª©
          ctx.fillStyle = "#0f172a";
          ctx.font = "800 56px IBM Plex Sans KR";
          ctx.fillText("ğŸ”® " + payload.title, cardX + 50, currentY);
          currentY += 100;

          // ë©”ì¸ í…ìŠ¤íŠ¸
          ctx.font = "700 36px IBM Plex Sans KR";
          ctx.fillStyle = "rgba(15,23,42,0.95)";
          const mainLines = wrapText(
            ctx,
            payload.main,
            cardX + 50,
            currentY,
            cardW - 100,
            50
          );
          currentY += mainLines * 50 + 40;

          // ìƒì„¸ ì„¤ëª…
          ctx.font = "600 28px IBM Plex Sans KR";
          ctx.fillStyle = "rgba(15,23,42,0.85)";
          const detailLines = wrapText(
            ctx,
            payload.detail,
            cardX + 50,
            currentY,
            cardW - 100,
            42
          );
          currentY += detailLines * 42 + 30;

          // íŒ
          ctx.font = "700 26px IBM Plex Sans KR";
          ctx.fillStyle = "rgba(15,23,42,0.9)";
          const tipLines = wrapText(
            ctx,
            payload.tip,
            cardX + 50,
            currentY,
            cardW - 100,
            38
          );
          currentY += tipLines * 38 + 40;

          // ì˜¤í–‰ ì •ë³´
          ctx.font = "600 24px IBM Plex Sans KR";
          ctx.fillStyle = "rgba(15,23,42,0.75)";
          ctx.fillText(`ì˜¤ëŠ˜ ì˜¤í–‰: ${payload.todayElem}`, cardX + 50, currentY);
          currentY += 35;
          ctx.fillText(
            `ë‚´ ê°•ì : ${payload.topElem} Â· ë‚´ ì•½ì : ${payload.weakElem}`,
            cardX + 50,
            currentY
          );

          // funnyfunny.cloudë¥¼ ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— ë°°ì¹˜
          ctx.font = "600 20px IBM Plex Sans KR";
          ctx.fillStyle = "rgba(15,23,42,0.5)";
          const brandText = "funnyfunny.cloud";
          const brandWidth = ctx.measureText(brandText).width;
          ctx.fillText(
            brandText,
            cardX + cardW - brandWidth - 50,
            cardY + cardH - 50
          );
        } else {
          // ê¸°ì¡´ ë ˆì´ì•„ì›ƒ (ê¶í•©, ì‹ ë…„ìš´ì„¸)
          ctx.fillStyle = "#0f172a";
          ctx.font = "800 52px IBM Plex Sans KR";
          ctx.fillText(payload.title, cardX + 50, cardY + 120);

          if (payload.toneLabel) {
            ctx.font = "700 30px IBM Plex Sans KR";
            ctx.fillStyle = "rgba(15,23,42,0.7)";
            ctx.fillText(payload.toneLabel, cardX + 50, cardY + 170);
          }

          if (payload.scoreText && payload.scoreText !== "â€”") {
            ctx.font = "800 110px IBM Plex Sans KR";
            ctx.fillStyle = "#0f172a";
            ctx.fillText(String(payload.scoreText), cardX + 50, cardY + 300);
            ctx.font = "700 30px IBM Plex Sans KR";
            ctx.fillStyle = "rgba(15,23,42,0.7)";
            ctx.fillText(payload.scoreLabel, cardX + 50, cardY + 350);
          }

          if (payload.topElem) {
            ctx.font = "700 32px IBM Plex Sans KR";
            ctx.fillStyle = "rgba(15,23,42,0.85)";
            ctx.fillText(
              `í•µì‹¬ ì˜¤í–‰: ${payload.topElem}`,
              cardX + 50,
              cardY + 430
            );
          }

          if (payload.summary) {
            ctx.font = "700 32px IBM Plex Sans KR";
            ctx.fillStyle = "rgba(15,23,42,0.9)";
            wrapText(
              ctx,
              `ìš”ì•½: ${payload.summary}`,
              cardX + 50,
              cardY + 510,
              cardW - 100,
              44
            );
          }

          if (payload.todayLine) {
            ctx.font = "700 28px IBM Plex Sans KR";
            ctx.fillStyle = "rgba(15,23,42,0.78)";
            wrapText(
              ctx,
              payload.todayLine,
              cardX + 50,
              cardY + 700,
              cardW - 100,
              40
            );
          }

          // funnyfunny.cloudë¥¼ ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— ë°°ì¹˜
          ctx.font = "600 20px IBM Plex Sans KR";
          ctx.fillStyle = "rgba(15,23,42,0.5)";
          const brandText = "funnyfunny.cloud";
          const brandWidth = ctx.measureText(brandText).width;
          ctx.fillText(
            brandText,
            cardX + cardW - brandWidth - 50,
            cardY + cardH - 50
          );
        }

        return new Promise((resolve) => c.toBlob(resolve, "image/png", 1.0));
      }

      function getSharePayload(snapshot) {
        if (state.mode === "compat") {
          return {
            title: "ê¶í•© ë¦¬í¬íŠ¸",
            scoreText: snapshot.totalScore,
            scoreLabel: "ê¶í•© ì ìˆ˜",
            summary: summaryMain.textContent,
            todayLine: todayCoupleLine.textContent,
            topElem: getTopWeak(snapshot.coupleElements).top,
          };
        }
        if (state.mode === "newyear") {
          const a = buildPerson(state.A);
          const { top, weak } = getTopWeak(state.A.elements);
          const y2026 = yearModeFor(a, 2026);
          const strategy = yearStrategy(y2026.mode);
          const monthlyData = makeMonthlyLuck(a);

          // ì›”ë³„ ìš´ì„¸ë¥¼ ê°„ë‹¨íˆ ìš”ì•½ (ì¹´ë“œì— ë§ê²Œ ê°„ê²°í•˜ê²Œ)
          const monthlySummary = monthlyData
            .map((m) => {
              const modeText = monthModeText(m.mode);
              const luckText =
                m.tags?.[0] === "ê¸¸"
                  ? "ê¸¸"
                  : m.tags?.[0] === "í‰"
                  ? "í‰"
                  : "ì¤‘";
              // ìš”ì•½ í…ìŠ¤íŠ¸ë¥¼ 20ì ì´ë‚´ë¡œ ì¤„ì´ê¸°
              let summary = m.summary || "";
              if (summary.length > 20) {
                // ë¬¸ì¥ì˜ í•µì‹¬ë§Œ ì¶”ì¶œ
                const shortSummary = summary
                  .replace(/ì˜¤ëŠ˜ì€|ì´ë²ˆ ë‹¬ì€|ì´ ì‹œê¸°ëŠ”/g, "")
                  .replace(/\.\.\./g, "")
                  .trim();
                summary =
                  shortSummary.length > 20
                    ? shortSummary.substring(0, 17) + "..."
                    : shortSummary;
              }
              return `${m.month}ì›”: ${luckText}ìš´ Â· ${modeText} Â· ${summary}`;
            })
            .slice(0, 12); // 12ê°œì›” ëª¨ë‘ í¬í•¨

          return {
            mode: "newyear",
            title: "ì‹ ë…„ìš´ì„¸ ë¦¬í¬íŠ¸",
            summary: summaryMain.textContent,
            lines: [
              `2026ë…„ ${y2026.pillar.text}(${y2026.yearElem}) Â· ${yearModeText(
                y2026.mode
              )}`,
              `í•´ì•¼ í•  ê²ƒ: ${strategy.todo}`,
              `í”¼í•´ì•¼ í•  ê²ƒ: ${strategy.avoid}`,
              "",
              "ğŸ“… ì›”ë³„ íë¦„:",
              ...monthlySummary,
            ],
            topElem: top,
            weakElem: weak,
          };
        }
        const a = buildPerson(state.A);
        const todayLuck = todayLuckLine(a);
        const topElem = getTopWeak(state.A.elements).top;
        return {
          title: "ì˜¤ëŠ˜ì˜ ìš´ì„¸",
          main: todayLuck.main,
          detail: todayLuck.detail,
          tip: todayLuck.tip,
          todayElem: todayLuck.todayElem,
          topElem: a.topElem,
          weakElem: a.weakElem,
        };
      }

      async function shareCard() {
        if (!state.A) {
          const t = window.t || ((key, vars = {}) => key);
          alert(t("alertInputRequired"));
          return;
        }

        // ì‹ ë…„ìš´ì„¸ ëª¨ë“œëŠ” í…ìŠ¤íŠ¸ ê³µìœ 
        if (state.mode === "newyear") {
          const a = buildPerson(state.A);
          const { top, weak } = getTopWeak(state.A.elements);
          const y2026 = yearModeFor(a, 2026);
          const strategy = yearStrategy(y2026.mode);
          const monthlyData = makeMonthlyLuck(a);
          const t = window.t || ((key, vars = {}) => key);

          let text = t("shareNewYearText");
          text += `${summaryMain.textContent}\n\n`;
          text += `2026ë…„ ${y2026.pillar.text}(${
            y2026.yearElem
          }) Â· ${yearModeText(y2026.mode)}\n`;
          text += `í•´ì•¼ í•  ê²ƒ: ${strategy.todo}\n`;
          text += `í”¼í•´ì•¼ í•  ê²ƒ: ${strategy.avoid}\n\n`;
          text += `í•µì‹¬ ì˜¤í–‰: ${top} Â· ì•½í•œ ì˜¤í–‰: ${weak}\n\n`;
          text += `ğŸ“… ì›”ë³„ íë¦„:\n`;

          monthlyData.forEach((m) => {
            const modeText = monthModeText(m.mode);
            const luckText =
              m.tags?.[0] === "ê¸¸"
                ? t("luckGood")
                : m.tags?.[0] === "í‰"
                ? t("luckBad")
                : t("luckNeutral");
            text += `${m.month}ì›”: ${luckText} Â· ${modeText} Â· ${m.summary}\n`;
          });

          text += `\nğŸ”® ì‚¬ì£¼í’€ì´ ì„œë¹„ìŠ¤: https://saju.funnyfunny.cloud/`;

          try {
            await navigator.clipboard.writeText(text);
            shareStatus.textContent = t("shareNewYearCopied");
          } catch (err) {
            // í´ë¦½ë³´ë“œ APIê°€ ì—†ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš°
            const textarea = document.createElement("textarea");
            textarea.value = text;
            textarea.style.position = "fixed";
            textarea.style.opacity = "0";
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand("copy");
              shareStatus.textContent = t("shareNewYearCopied");
            } catch (e) {
              prompt(t("copyPrompt"), text);
              shareStatus.textContent = t("shareStatusAfterCopy");
            }
            document.body.removeChild(textarea);
          }
          return;
        }

        // ì˜¤ëŠ˜ìš´ì„¸, ê¶í•© ëª¨ë“œëŠ” ê¸°ì¡´ ì¹´ë“œ ê³µìœ 
        const snapshot = renderAll() || {
          totalScore: "â€”",
          coupleElements: state.A.elements,
        };
        const blob = await generateShareCard(getSharePayload(snapshot));

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;

        // ëª¨ë“œë³„ íŒŒì¼ëª… ì„¤ì •
        const dateStr = new Date().toISOString().slice(0, 10);
        let fileName;
        if (state.mode === "today") {
          fileName = `ì˜¤ëŠ˜ì˜ìš´ì„¸ì¹´ë“œ_${dateStr}.png`;
        } else {
          fileName = `ê¶í•©ì¹´ë“œ_${dateStr}.png`;
        }
        a.download = fileName;
        a.click();

        try {
          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
          const t = window.t || ((key, vars = {}) => key);
          shareStatus.textContent = t("shareCardCopied");
        } catch {
          const t = window.t || ((key, vars = {}) => key);
          shareStatus.textContent = t("shareCardCreated");
        }
      }

      /* ======================================================
  11. PDF ì €ì¥ (html2canvas + jsPDF)
====================================================== */
      async function savePdfPretty() {
        if (!state.A) {
          const t = window.t || ((key, vars = {}) => key);
          alert(t("alertInputRequired"));
          return;
        }
        const t = window.t || ((key, vars = {}) => key);
        if (!window.html2canvas || !window.jspdf) {
          alert(t("alertPDFNotReady"));
          return;
        }

        const area = document.getElementById("pdfArea");
        const canvas = await html2canvas(area, {
          scale: 1.5,
          backgroundColor: "#ffffff",
          useCORS: true,
          logging: false,
          ignoreElements: (element) => {
            // hidden í´ë˜ìŠ¤ê°€ ìˆëŠ” ìš”ì†ŒëŠ” ì œì™¸
            return element.classList?.contains("hidden");
          },
        });

        const imgData = canvas.toDataURL("image/jpeg", 0.82);
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: "p",
          unit: "mm",
          format: "a4",
          compress: true,
        });
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const imgW = pageW;
        const imgH = (canvas.height * imgW) / canvas.width;

        // ì´ë¯¸ì§€ë¥¼ PDFì— ì¶”ê°€ (ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë‚˜ëˆ„ê¸°)
        if (imgH <= pageH) {
          pdf.addImage(imgData, "JPEG", 0, 0, imgW, imgH);
        } else {
          let y = 0;
          let remaining = imgH;
          while (remaining > 0) {
            pdf.addImage(imgData, "JPEG", 0, -y, imgW, imgH);
            remaining -= pageH;
            y += pageH;
            if (remaining > 0) pdf.addPage();
          }
        }

        // ëª¨ë“œë³„ íŒŒì¼ëª… ì„¤ì •
        const dateStr = new Date().toISOString().slice(0, 10);
        let fileName;
        if (state.mode === "today") {
          fileName = t("pdfFileNameToday", { date: dateStr });
        } else if (state.mode === "newyear") {
          fileName = t("pdfFileNameNewYear", { date: dateStr });
        } else {
          fileName = t("pdfFileNameCompat", { date: dateStr });
        }

        pdf.save(fileName);
      }

      /* ======================================================
  12. ì…ë ¥/ê³„ì‚° íŒŒì´í”„ë¼ì¸
====================================================== */
      function loadInputs() {
        try {
          return JSON.parse(localStorage.getItem(INPUT_KEY) || "{}");
        } catch {
          return {};
        }
      }
      function saveInputs(data) {
        localStorage.setItem(INPUT_KEY, JSON.stringify(data));
      }

      function setInputs(data) {
        if (!data) return;
        aDate.value = data.aDate || "";
        aHourBranch.value = data.aHourBranch || "ì";
        aTimeUnknown.checked = Boolean(data.aTimeUnknown);
        aGender.value = data.aGender || "male";
        aDaewoonStart.value = data.aDaewoonStart || "";
        aHiddenMode.value = "on";
        aHiddenMode.disabled = true;
        aTzOffset.value = data.aTzOffset ?? "9";
        aDstMode.value = data.aDstMode || "off";
        bDate.value = data.bDate || "";
        bHourBranch.value = data.bHourBranch || "ì";
        bTimeUnknown.checked = Boolean(data.bTimeUnknown);
        bGender.value = data.bGender || "female";
        bDaewoonStart.value = data.bDaewoonStart || "";
        bHiddenMode.value = "on";
        bHiddenMode.disabled = true;
        bTzOffset.value = data.bTzOffset ?? "9";
        bDstMode.value = data.bDstMode || "off";
      }

      function getInputData() {
        return {
          aDate: aDate.value,
          aHourBranch: aHourBranch.value,
          aTimeUnknown: aTimeUnknown.checked,
          aGender: aGender.value,
          aLunar: "",
          aDaewoonStart: aDaewoonStart.value,
          aHiddenMode: "on",
          aTzOffset: aTzOffset.value,
          aDstMode: aDstMode.value,
          bDate: bDate.value,
          bHourBranch: bHourBranch.value,
          bTimeUnknown: bTimeUnknown.checked,
          bGender: bGender.value,
          bLunar: "",
          bDaewoonStart: bDaewoonStart.value,
          bHiddenMode: "on",
          bTzOffset: bTzOffset.value,
          bDstMode: bDstMode.value,
          mode: state.mode,
        };
      }

      function configureInputForMode(mode) {
        const t = window.t || ((key, vars = {}) => key);
        const gridContainer = panelA.parentElement;
        if (mode === "compat") {
          inputTitle.textContent = t("inputTitleCompat");
          inputDesc.textContent = t("inputDescCompat");
          panelB.classList.remove("hidden");
          gridContainer.style.display = "grid";
          gridContainer.style.gridTemplateColumns = "repeat(2, minmax(0, 1fr))";
          gridContainer.style.justifyItems = "stretch";
          panelA.style.maxWidth = "none";
        } else if (mode === "newyear") {
          inputTitle.textContent = t("inputTitleNewYear");
          inputDesc.textContent = t("inputDescNewYear");
          panelB.classList.add("hidden");
          gridContainer.style.display = "flex";
          gridContainer.style.justifyContent = "center";
          panelA.style.maxWidth = "500px";
        } else {
          inputTitle.textContent = t("inputTitleToday");
          inputDesc.textContent = t("inputDescToday");
          panelB.classList.add("hidden");
          gridContainer.style.display = "flex";
          gridContainer.style.justifyContent = "center";
          panelA.style.maxWidth = "500px";
        }
      }

      function showStep(name) {
        stepMenu.classList.toggle("active", name === "menu");
        stepInput.classList.toggle("active", name === "input");
        stepResult.classList.toggle("active", name === "result");
      }

      async function computePair() {
        try {
          const t = window.t || ((key, vars = {}) => key);
          const data = getInputData();
          if (!data.aDate || !data.aHourBranch) {
            alert(t("alertADateRequired"));
            return;
          }
          if (state.mode === "compat" && (!data.bDate || !data.bHourBranch)) {
            alert(t("alertBDateRequired"));
            return;
          }
          saveInputs(data);

          loadingOverlay.classList.add("active");
          loadingOverlay.setAttribute("aria-hidden", "false");
          await new Promise((r) => setTimeout(r, 700));

          const aOffsetMin = parseTzOffsetMinutes(data.aTzOffset, 540);
          const aIncludeHour = !data.aTimeUnknown;
          const aTimeStr = aIncludeHour
            ? hourBranchToTime(data.aHourBranch)
            : "12:00";
          if (!data.aDate) {
            throw new Error("A ë‚ ì§œê°€ ë¹„ì–´ ìˆì–´.");
          }
          const aBirth = parseLocalDateTime(
            data.aDate,
            aTimeStr,
            aOffsetMin,
            data.aDstMode
          );
          if (!aBirth || isNaN(aBirth.getTime())) {
            throw new Error(
              "A ë‚ ì§œ/ì‹œê°„ íŒŒì‹± ì‹¤íŒ¨: " + data.aDate + " " + aTimeStr
            );
          }
          const aHourBranch = aIncludeHour ? data.aHourBranch : null;
          const aResult = computeSajuFiveElements(aBirth, {
            ziMode: "2300",
            hiddenMode: "on", // í•­ìƒ onìœ¼ë¡œ ê³ ì •
            tzOffsetMinutes: aOffsetMin,
            dstMode: data.aDstMode,
            includeHour: aIncludeHour,
            hourBranchOverride: aHourBranch,
          });
          if (!aResult || !aResult.elements || !aResult.pillars) {
            throw new Error("A ì‚¬ì£¼ ê³„ì‚° ì‹¤íŒ¨");
          }
          state.aResult = aResult;
          state.A = {
            name: "A",
            elements: aResult.elements.raw,
            dayBranch: aResult.pillars.day.branch,
            monthBranch: aResult.pillars.month.branch,
            yearBranch: aResult.pillars.year.branch,
            yearStem: aResult.pillars.year.stem,
            monthStem: aResult.pillars.month.stem,
            dayStem: aResult.pillars.day.stem,
            hourStem: aResult.pillars.hour ? aResult.pillars.hour.stem : "",
            tzOffsetMinutes: aOffsetMin,
            dstMode: data.aDstMode,
            includeHour: aIncludeHour,
            hourBranch: aHourBranch,
            boundaryText: makeBoundaryText(),
            altResult: null,
            gender: data.aGender,
            lunarDate: data.aLunar,
            daewoonStartAge: data.aDaewoonStart,
          };

          if (state.mode === "compat") {
            const bOffsetMin = parseTzOffsetMinutes(data.bTzOffset, 540);
            const bIncludeHour = !data.bTimeUnknown;
            const bTimeStr = bIncludeHour
              ? hourBranchToTime(data.bHourBranch)
              : "12:00";
            if (!data.bDate) {
              throw new Error("B ë‚ ì§œê°€ ë¹„ì–´ ìˆì–´.");
            }
            const bBirth = parseLocalDateTime(
              data.bDate,
              bTimeStr,
              bOffsetMin,
              data.bDstMode
            );
            if (!bBirth || isNaN(bBirth.getTime())) {
              throw new Error(
                "B ë‚ ì§œ/ì‹œê°„ íŒŒì‹± ì‹¤íŒ¨: " + data.bDate + " " + bTimeStr
              );
            }
            const bHourBranch = bIncludeHour ? data.bHourBranch : null;
            const bResult = computeSajuFiveElements(bBirth, {
              ziMode: "2300",
              hiddenMode: "on", // í•­ìƒ onìœ¼ë¡œ ê³ ì •
              tzOffsetMinutes: bOffsetMin,
              dstMode: data.bDstMode,
              includeHour: bIncludeHour,
              hourBranchOverride: bHourBranch,
            });
            if (!bResult || !bResult.elements || !bResult.pillars) {
              throw new Error("B ì‚¬ì£¼ ê³„ì‚° ì‹¤íŒ¨");
            }
            state.bResult = bResult;
            state.B = {
              name: "B",
              elements: bResult.elements.raw,
              dayBranch: bResult.pillars.day.branch,
              monthBranch: bResult.pillars.month.branch,
              yearBranch: bResult.pillars.year.branch,
              yearStem: bResult.pillars.year.stem,
              monthStem: bResult.pillars.month.stem,
              dayStem: bResult.pillars.day.stem,
              hourStem: bResult.pillars.hour ? bResult.pillars.hour.stem : "",
              tzOffsetMinutes: bOffsetMin,
              dstMode: data.bDstMode,
              includeHour: bIncludeHour,
              hourBranch: bHourBranch,
              boundaryText: makeBoundaryText(),
              altResult: null,
              gender: data.bGender,
              lunarDate: data.bLunar,
              daewoonStartAge: data.bDaewoonStart,
            };
          } else {
            state.bResult = null;
            state.B = null;
          }

          showStep("result");
          renderAll();

          await new Promise((r) => setTimeout(r, 400));
        } catch (error) {
          console.error("ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          const t = window.t || ((key, vars = {}) => key);
          alert(t("alertError", { error: error.message }));
        } finally {
          loadingOverlay.classList.remove("active");
          loadingOverlay.setAttribute("aria-hidden", "true");
        }
      }

      // =========================
      // i18n
      // =========================
      const translations = {
        ko: {
          metaTitle: "ì‚¬ì£¼í’€ì´ Â· ê¶í•© Â· ì˜¤ëŠ˜ìš´ì„¸ Â· ì‹ ë…„ìš´ì„¸",
          serviceName: "ì‚¬ì£¼í’€ì´",
          btnOtherServices: "ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë³´ê¸°",
          menuDesc: "ì‹ ë…„ìš´ì„¸/ì˜¤ëŠ˜ìš´ì„¸ ì¤‘ ì„ íƒí•˜ë©´ ë‹¨ê³„ë³„ë¡œ ì…ë ¥ë°›ê³  ê²°ê³¼ë¥¼ ë³´ì—¬ì¤„ê²Œ.",
          menuNewYear: "ì‹ ë…„ìš´ì„¸",
          menuNewYearDesc: "2026ë…„ í•œ í•´ì˜ íë¦„ì„<br />ì›”ë³„ë¡œ ì‚´í´ë³´ê¸°",
          menuToday: "ì˜¤ëŠ˜ì˜ ìš´ì„¸",
          menuTodayDesc: "ì˜¤ëŠ˜ í•˜ë£¨ì˜ ê¸°ìš´ê³¼<br />í–‰ë™ ê°€ì´ë“œë¥¼ í™•ì¸í•˜ê¸°",
          btnBackToMenu: "ë©”ë‰´ë¡œ",
          btnClearSaved: "ì €ì¥ ì´ˆê¸°í™”",
          inputBirthInfo: "ì¶œìƒ ì •ë³´",
          inputPartnerInfo: "ìƒëŒ€ ì •ë³´",
          inputTimeUnknown: "ì‹œê°„ ëª¨ë¦„(ì‹œì£¼ ì œì™¸)",
          genderMale: "ë‚¨ì",
          genderFemale: "ì—¬ì",
          inputDesc: "ë‚ ì§œì™€ ì‹œê°„(12ê°„ì§€)ì„ ì…ë ¥í•œ ë’¤ ì„±ë³„ë§Œ ì„ íƒí•˜ë©´ ë¼.",
          inputTitleNewYear: "ì‹ ë…„ìš´ì„¸ ì…ë ¥",
          inputDescNewYear: "í•œ ì‚¬ëŒ ì¶œìƒ ì •ë³´ ì…ë ¥ â†’ 2026 íë¦„",
          inputTitleToday: "ì˜¤ëŠ˜ìš´ì„¸ ì…ë ¥",
          inputDescToday: "í•œ ì‚¬ëŒ ì¶œìƒ ì •ë³´ ì…ë ¥ â†’ ì˜¤ëŠ˜ í•œ ì¤„",
          inputTitleCompat: "ê¶í•© ì…ë ¥",
          inputDescCompat: "A/B ì¶œìƒ ì •ë³´ ì…ë ¥ â†’ ê¶í•© ê³„ì‚°",
          alertADateRequired: "A ë‚ ì§œì™€ 12ê°„ì§€ë¥¼ ì„ íƒí•´ì¤˜.",
          alertBDateRequired: "B ë‚ ì§œì™€ 12ê°„ì§€ë¥¼ ì„ íƒí•´ì¤˜.",
          alertError: "ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ìƒê²¼ì–´. ì…ë ¥ê°’ í™•ì¸í•´ì¤˜.\nì˜¤ë¥˜: {error}",
          // ì˜¤í–‰ ì˜ë¯¸
          elemWood: "ì„±ì¥/ê¸°íš",
          elemFire: "ì¶”ì§„/í‘œí˜„",
          elemEarth: "ì•ˆì •/ê´€ë¦¬",
          elemMetal: "ê²°ê³¼/ë³´ìƒ",
          elemWater: "ì •ë³´/í™˜ê²½",
          elemGeneric: "ê¸°ìš´",
          // ì—°ë„ ëª¨ë“œ
          yearModePush: "í™•ì¥/ì¶”ì§„ì— ìœ ë¦¬",
          yearModePushPlus: "ì„±ê³¼+íšŒë³µ ë™ì‹œ",
          yearModeRecover: "ì •ë¦¬/íšŒë³µì— ìœ ë¦¬",
          yearModeBrake: "ì†ë„ ì¡°ì ˆ ì¶”ì²œ",
          yearModeSteady: "ê¸°ë³¸ ìœ ì§€",
          // ì—°ë„ ì „ëµ
          strategyPush: "í™•ì¥/ì¶”ì§„",
          strategyPushPlus: "í™•ì¥+íšŒë³µ ë™ì‹œ",
          strategyRecover: "ì •ë¦¬/íšŒë³µ",
          strategyBrake: "ì†ë„ ì¡°ì ˆ",
          strategySteady: "ê¸°ë³¸ ìœ ì§€",
          avoidPush: "ìš°ìœ ë¶€ë‹¨",
          avoidPushPlus: "ë¬´ë¦¬í•œ í™•ì¥",
          avoidRecover: "ìƒˆ íŒ ë²Œë¦¬ê¸°",
          avoidBrake: "ê³¼ì†/ëª¨í—˜",
          avoidSteady: "ê¸‰ë³€",
          // ì›”ë³„ ëª¨ë“œ
          monthModePush: "ì¶”ì§„",
          monthModePushPlus: "ì¶”ì§„+íšŒë³µ",
          monthModeRecover: "íšŒë³µ",
          monthModeBrake: "ì¡°ì ˆ",
          monthModeSteady: "ìœ ì§€",
          // ê²°ê³¼ í™”ë©´ ì œëª©
          resultElementsTitle: "ì˜¤í–‰ ê¸°ìš´ ë¶„ì„",
          resultDeepTitle: "ì‹¬í™” ë¶„ì„",
          resultLuckTitle: "ëŒ€ìš´ Â· ì„¸ìš´",
          resultReportTitle: "ë³¸ì§ˆ ë¦¬í¬íŠ¸",
          resultSummaryTitle: "ê¶í•© ìš”ì•½",
          resultTodayTitle: "ğŸ”® ì˜¤ëŠ˜ì˜ ìš´ì„¸",
          resultRulesTitle: "ê¶í•© í¬ì¸íŠ¸",
          resultMonthlyTitle: "2026 ì‹ ë…„ìš´ì„¸ (ì›”ë³„)",
          resultRadarTitle: "ì„¹ì…˜ë³„ ê· í˜•",
          resultABTitle: "A/B ì‚¬ì£¼ ìš”ì•½",
          shareCardTitle: "ê³µìœ  Â· PDF",
          btnShare: "ê³µìœ ",
          btnPDF: "PDF ì €ì¥",
          btnInputModify: "ì…ë ¥ ìˆ˜ì •",
          btnRestart: "ë©”ë‰´ë¡œ",
          btnShareMonthly: "ğŸ“‹ ê³µìœ í•˜ê¸°",
          // ë¡œë”©
          loadingTitle: "ì˜¤í–‰ ê· í˜• ê³„ì‚° ì¤‘",
          loadingDesc: "ì ˆê¸° ê¸°ì¤€ìœ¼ë¡œ ì •ë°€í•˜ê²Œ ë§ì¶”ëŠ” ì¤‘ì´ì•¼â€¦",
          // ë¦¬í¬íŠ¸ ì„¹ì…˜
          reportSection1: "1ï¸âƒ£ ì‚¬ì£¼ êµ¬ì¡° í•µì‹¬ ìš”ì•½",
          reportSection2: "2ï¸âƒ£ ì´ ì‚¬ì£¼ì˜ í‰ìƒ í•µì‹¬ ê³¼ì œ",
          reportSection3: "3ï¸âƒ£ ê¼­ ì±™ê²¨ì•¼ í•  í¬ì¸íŠ¸ 3ê°€ì§€",
          reportSection4: "4ï¸âƒ£ ê°•ì  í™œìš© ì „ëµ (í˜„ì‹¤ ì ìš©)",
          reportSection5: "5ï¸âƒ£ ê´€ê³„ í•´ì„ (ì¤‘ìš”)",
          reportSection6: "6ï¸âƒ£ ì§ì—…Â·ì¬ë¬¼ ë°©í–¥",
          reportSection7: "7ï¸âƒ£ ëŒ€ìš´Â·ì„¸ìš´ í•´ì„ (ì „ëµ ì¤‘ì‹¬)",
          reportSection8: "8ï¸âƒ£ ìµœì¢… ì´í‰ (í˜„ì‹¤ì ì¸ ì¡°ì–¸)",
          reportBasicInfo: "ê¸°ë³¸ ì •ë³´: {gender} Â· ì¼ê°„ {dayStem}({dayElem}) Â· ê°•ì•½ {strength} Â· {relationLine}",
          reportCoreTitle: "ë³¸ì§ˆ ë¦¬í¬íŠ¸",
          reportNote1: "ì •ë¦¬ëœ êµ¬ì¡°ë¥¼ ì•Œë©´ ë°©í–¥ì´ ë” ì„ ëª…í•´ì ¸.",
          reportNote2: "ê³¼ì œë¥¼ ì•Œë©´ ì„ íƒì´ ë” ë¶€ë“œëŸ¬ì›Œì ¸.",
          reportNote3: "ì§€í‚¬ í¬ì¸íŠ¸ë¥¼ ì¡ìœ¼ë©´ ìš´ì´ ë” ì•ˆì •ë¼.",
          reportNote4: "ê°•ì ì„ ì‚´ë¦¬ë©´ ì„±ê³¼ê°€ ìì—°ìŠ¤ëŸ½ê²Œ ë”°ë¼ì™€.",
          reportNote5: "ê´€ê³„ëŠ” ì²œì²œíˆ ë‹¤ì ¸ë„ ì¶©ë¶„íˆ ì¢‹ì•„ì ¸.",
          reportNote6: "ì¢‹ì€ ë°©í–¥ì„ ê³ ë¥´ë©´ íë¦„ì´ ë” í¸ì•ˆí•´ì ¸.",
          reportNote7: "íë¦„ì„ ì½ìœ¼ë©´ ê¸°íšŒê°€ ë” ì˜ ë³´ì—¬.",
          reportNote8: "ì°¨ë¶„íˆ ê±¸ì–´ê°€ë„ ì¢‹ì€ ê²°ê³¼ê°€ ìŒ“ì—¬.",
          // ì‹¬í™” ë¶„ì„
          deepDayStem: "ì¼ê°„: {dayStem}({dayElem}) Â· {strength}",
          deepYongshin: "ìš©ì‹ : {yongText}",
          deepGyeokguk: "ê²©êµ­: ì›”ì§€ {season} ì¤‘ì‹¬. {seasonLine}",
          deepCurrent: "í˜„ì¬ ì˜¤í–‰:",
          deepRelation: "í•©: {hap} Â· ì¶©: {chung} Â· í˜•: {hyeong}",
          deepRelationExplain: "í•©ì€ ì„œë¡œ ë•ëŠ” ê²°ì´ë¼ í˜¸í¡ì´ ë¶€ë“œëŸ½ê³ , ì¶©ì€ ë¶€ë”ªí˜ì´ ìƒê²¨ íƒ€ì´ë° ì¡°ì ˆì´ í•„ìš”í•´. í˜•ì€ ë§ˆì°°ì´ë‚˜ ê¸´ì¥ì´ ìƒê¸°ê¸° ì‰¬ìš´ ê²°ì´ì•¼. {hyeongNote}",
          deepRelationHyeongNote: "í˜„ì¬ í˜•: {hyeong}ì´ë‹ˆê¹Œ ë§íˆ¬/ì†ë„ë¥¼ ì¤„ì´ë©´ ì¶©ëŒì´ ì¤„ì–´ë“¤ì–´.",
          deepRelationHyeongNone: "í˜•ì´ ì ì–´ì„œ í° ë§ˆì°°ì€ ëœí•´.",
          deepSeasonSame: "ì›”ë ¹ê³¼ ê°•ì ì´ ê°™ì•„ì„œ ìì—°ìŠ¤ëŸ½ê²Œ í˜ì´ ì‹¤ë¦¬ëŠ” íë¦„ì´ì•¼.",
          deepSeasonDifferent: "ì›”ë ¹ê³¼ ê°•ì ì´ ë‹¬ë¼ì„œ ì¡°ìœ¨ê³¼ ë³´ì™„ì´ ì¤‘ìš”í•´.",
          // ì›”ë³„ ìš´ì„¸
          monthlyFlow: "{month}ì›” Â· {seasonElem} íë¦„",
          monthlyTip: "ğŸ’¡ íŒ:",
          monthlyShareCopied: "{monthLabel} ìš´ì„¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!",
          monthlyShareText: "ğŸ”® {monthLabel} ìš´ì„¸\n\n{summary}\n\n{details}\n\níƒœê·¸: {tags}\n\n#ì‚¬ì£¼í’€ì´ #ì‹ ë…„ìš´ì„¸ #{monthLabel}ìš´ì„¸\n\nğŸ”® ì‚¬ì£¼í’€ì´ ì„œë¹„ìŠ¤: https://saju.funnyfunny.cloud/",
          // ìš´ì„¸ íƒœê·¸
          luckGood: "ê¸¸ìš´",
          luckBad: "í‰ìš´",
          luckNeutral: "ì¤‘ìš´",
          luckEnergy: "{elem} ê¸°ìš´",
          // ê¶í•© ë£°
          ruleNoRules: "ë°œë™ëœ ë£°ì´ ì•„ì§ ì—†ì–´. ì…ë ¥ê°’ì„ í™•ì¸í•´ì¤˜.",
          ruleInsightMoney: "ëˆ íë¦„ì€ ê·œì¹™ í•©ì˜ê°€ ìˆì„ìˆ˜ë¡ ì•ˆì •ëœë‹¤.",
          ruleInsightHealth: "ë¦¬ë“¬ì´ ë§ì„ìˆ˜ë¡ ì»¨ë””ì…˜ íšŒë³µì´ ë¹ ë¥´ë‹¤.",
          // ì˜¤ëŠ˜ì˜ ìš´ì„¸
          todayFortune: "ì˜¤ëŠ˜ì˜ ìš´ì„¸",
          // ê¸°íƒ€
          summarySub: "ì…ë ¥ ì‹œê°„ëŒ€ ê¸°ì¤€ Â· ì ˆê¸°/ì˜¤í–‰ ê·œì¹™",
          summaryPillCore: "í•µì‹¬ ì˜¤í–‰: {top}",
          summaryPillWeak: "ì•½í•œ ì˜¤í–‰: {weak}",
          summaryPillRules: "ë°œë™ ë£°: {count}ê°œ",
          radarLegend: "ê´€ê³„ì˜ ì „ì²´ ë°¸ëŸ°ìŠ¤",
          // ì•Œë¦¼
          alertInputRequired: "ì…ë ¥ í›„ ê³„ì‚°í•´ì¤˜.",
          alertPDFNotReady: "PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´.",
          alertMonthCopied: "{monthLabel} ìš´ì„¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!",
          shareCardCopied: "ì¹´ë“œë¥¼ ìƒì„±í•˜ê³  í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´.",
          shareCardCreated: "ì¹´ë“œë¥¼ ìƒì„±í–ˆì–´. ë‹¤ìš´ë¡œë“œë¥¼ í™•ì¸í•´ì¤˜.",
          inputTimeNote: "â€» ì…ë ¥ ì‹œê°„ì€ í•œêµ­ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•´.",
          // ì¶”ê°€ ë²ˆì—­
          inputTitle: "ì…ë ¥",
          shintoNote: "ì‹ í† ì •ë¹„ê²° ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•´.",
          btnCalculate: "í™•ì¸í•˜ê¸°",
          todayBadge: "ì‹ í† ì •ë¹„ê²°",
          shintoCorrectionTitle: "ì‹ í† ì •ë¹„ê²° ë³´ì •",
          shintoCorrectionApplied: "ì ìš©ë¨",
          shintoCorrectionNotApplied: "ë¯¸ì ìš©",
          shintoCorrectionAppliedText: "âœ… <strong>ì‹ í† ì •ë¹„ê²° ë³´ì • ì ìš©</strong><br/>ë„ˆì˜ ì‚¬ì£¼ ê°„ì§€ ì¡°í•©ì€ ì‹ í† ì •ë¹„ê²°(ì „í†µ ì‚¬ì£¼ í•´ì„ì„œ)ì— ê¸°ë¡ëœ íŠ¹ë³„í•œ íŒ¨í„´ì´ì•¼. ì¼ë°˜ ê³„ì‚° ëŒ€ì‹  ì‹ í† ì •ë¹„ê²°ì—ì„œ ì •í•œ ì˜¤í–‰ ë¶„í¬ê°’ì„ ì¨ì„œ ë” ì •í™•í•˜ê²Œ ë³´ì—¬ì¤˜.",
          shintoCorrectionNotAppliedText: "â„¹ï¸ <strong>ì‹ í† ì •ë¹„ê²° ë³´ì • ë¯¸ì ìš©</strong><br/>ë„ˆì˜ ì‚¬ì£¼ ê°„ì§€ ì¡°í•©ì— ëŒ€í•œ ì‹ í† ì •ë¹„ê²° ê¸°ì¤€ ë°ì´í„°ê°€ ì—†ì–´ì„œ ì¼ë°˜ ê³„ì‚°ìœ¼ë¡œ ì˜¤í–‰ì„ ì‚°ì¶œí–ˆì–´.",
          shintoCorrectionNoData: "í•´ë‹¹ ê°„ì§€ ì¡°í•©ì— ëŒ€í•œ ì‹ í† ì •ë¹„ê²° ë³´ì • ë°ì´í„°ê°€ ì—†ì–´.",
          tableHeaderCategory: "êµ¬ë¶„",
          tableHeaderYear: "ë…„",
          tableHeaderMonth: "ì›”",
          tableHeaderDay: "ì¼",
          tableHeaderHour: "ì‹œ",
          tableHeaderStemBranch: "ê°„ì§€",
          tableHeaderElements: "ì˜¤í–‰",
          tableHeaderTotal: "í•©ê³„",
          tableHeaderCorrection: "ë³´ì •ê°’",
          resultNewYearSummary: "ì‹ ë…„ìš´ì„¸ ìš”ì•½",
          shareNewYearCopied: "ì‹ ë…„ìš´ì„¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆì–´.",
          shareNewYearText: "ğŸ”® 2026 ì‹ ë…„ìš´ì„¸\n\n",
          copyPrompt: "ë³µì‚¬í•  ë‚´ìš©:",
          shareStatusAfterCopy: "í…ìŠ¤íŠ¸ë¥¼ í™•ì¸í•´ì¤˜.",
          pdfFileNameToday: "ì˜¤ëŠ˜ì˜ìš´ì„¸_{date}.pdf",
          pdfFileNameNewYear: "ì‹ ë…„ìš´ì„¸_{date}.pdf",
          pdfFileNameCompat: "ê¶í•©ë¦¬í¬íŠ¸_{date}.pdf",
        },
        en: {
          metaTitle: "Fortune Telling Â· Compatibility Â· Today's Fortune Â· New Year Fortune",
          serviceName: "Fortune Telling",
          btnOtherServices: "View Other Services",
          menuDesc: "Select New Year Fortune or Today's Fortune, and I'll guide you step by step to show the results.",
          menuNewYear: "New Year Fortune",
          menuNewYearDesc: "View the flow of 2026<br />month by month",
          menuToday: "Today's Fortune",
          menuTodayDesc: "Check today's energy and<br />action guide",
          btnBackToMenu: "Back to Menu",
          btnClearSaved: "Clear Saved",
          inputBirthInfo: "Birth Information",
          inputPartnerInfo: "Partner Information",
          inputTimeUnknown: "Time unknown (exclude hour)",
          genderMale: "Male",
          genderFemale: "Female",
          inputDesc: "Enter date and time (12 zodiac signs), then select gender.",
          inputTitleNewYear: "New Year Fortune Input",
          inputDescNewYear: "Enter one person's birth info â†’ 2026 flow",
          inputTitleToday: "Today's Fortune Input",
          inputDescToday: "Enter one person's birth info â†’ today's one-liner",
          inputTitleCompat: "Compatibility Input",
          inputDescCompat: "Enter A/B birth info â†’ compatibility calculation",
          alertADateRequired: "Please select A date and 12 zodiac signs.",
          alertBDateRequired: "Please select B date and 12 zodiac signs.",
          alertError: "An error occurred during calculation. Please check your input.\nError: {error}",
          // Element meanings
          elemWood: "Growth/Planning",
          elemFire: "Drive/Expression",
          elemEarth: "Stability/Management",
          elemMetal: "Result/Reward",
          elemWater: "Information/Environment",
          elemGeneric: "Energy",
          // Year modes
          yearModePush: "Favorable for expansion/drive",
          yearModePushPlus: "Achievement + recovery simultaneously",
          yearModeRecover: "Favorable for organization/recovery",
          yearModeBrake: "Speed control recommended",
          yearModeSteady: "Maintain basics",
          // Year strategies
          strategyPush: "Expansion/Drive",
          strategyPushPlus: "Expansion + recovery simultaneously",
          strategyRecover: "Organization/Recovery",
          strategyBrake: "Speed control",
          strategySteady: "Maintain basics",
          avoidPush: "Indecision",
          avoidPushPlus: "Excessive expansion",
          avoidRecover: "Starting new ventures",
          avoidBrake: "Speed/Adventure",
          avoidSteady: "Sudden changes",
          // Month modes
          monthModePush: "Drive",
          monthModePushPlus: "Drive + Recovery",
          monthModeRecover: "Recovery",
          monthModeBrake: "Control",
          monthModeSteady: "Maintain",
          // Result screen titles
          resultElementsTitle: "Five Elements Energy Analysis",
          resultDeepTitle: "Deep Analysis",
          resultLuckTitle: "Major/Minor Fortune",
          resultReportTitle: "Core Report",
          resultSummaryTitle: "Compatibility Summary",
          resultTodayTitle: "ğŸ”® Today's Fortune",
          resultRulesTitle: "Compatibility Points",
          resultMonthlyTitle: "2026 New Year Fortune (Monthly)",
          resultRadarTitle: "Section Balance",
          resultABTitle: "A/B Fortune Summary",
          shareCardTitle: "Share Â· PDF",
          btnShare: "Share",
          btnPDF: "Save PDF",
          btnInputModify: "Modify Input",
          btnRestart: "Back to Menu",
          btnShareMonthly: "ğŸ“‹ Share",
          // Loading
          loadingTitle: "Calculating Five Elements Balance",
          loadingDesc: "Precisely adjusting based on seasonal periodsâ€¦",
          // Report sections
          reportSection1: "1ï¸âƒ£ Core Summary of Fortune Structure",
          reportSection2: "2ï¸âƒ£ Lifetime Core Challenges",
          reportSection3: "3ï¸âƒ£ Three Key Points to Keep",
          reportSection4: "4ï¸âƒ£ Strength Utilization Strategy (Practical Application)",
          reportSection5: "5ï¸âƒ£ Relationship Interpretation (Important)",
          reportSection6: "6ï¸âƒ£ Career Â· Wealth Direction",
          reportSection7: "7ï¸âƒ£ Major/Minor Fortune Interpretation (Strategy Focus)",
          reportSection8: "8ï¸âƒ£ Final Summary (Practical Advice)",
          reportBasicInfo: "Basic Info: {gender} Â· Day Stem {dayStem}({dayElem}) Â· Strength {strength} Â· {relationLine}",
          reportCoreTitle: "Core Report",
          reportNote1: "Knowing the organized structure makes the direction clearer.",
          reportNote2: "Knowing the challenges makes choices smoother.",
          reportNote3: "Grasping the points to keep makes fortune more stable.",
          reportNote4: "Utilizing strengths naturally brings results.",
          reportNote5: "Relationships can become good even if built slowly.",
          reportNote6: "Choosing good directions makes the flow more comfortable.",
          reportNote7: "Reading the flow makes opportunities more visible.",
          reportNote8: "Walking calmly also builds good results.",
          // Deep analysis
          deepDayStem: "Day Stem: {dayStem}({dayElem}) Â· {strength}",
          deepYongshin: "Yongshin: {yongText}",
          deepGyeokguk: "Gyeokguk: Month Branch {season} centered. {seasonLine}",
          deepCurrent: "Current Five Elements:",
          deepRelation: "Hap: {hap} Â· Chung: {chung} Â· Hyeong: {hyeong}",
          deepRelationExplain: "Hap is a bond that helps each other, making breathing smooth. Chung creates conflicts, requiring timing control. Hyeong is a bond that easily creates friction or tension. {hyeongNote}",
          deepRelationHyeongNote: "Current Hyeong: {hyeong}, so reducing tone/speed reduces conflicts.",
          deepRelationHyeongNone: "Hyeong is few, so major friction is less.",
          deepSeasonSame: "Month order and strength are the same, so power naturally flows.",
          deepSeasonDifferent: "Month order and strength differ, so coordination and supplementation are important.",
          // Monthly fortune
          monthlyFlow: "{month} Month Â· {seasonElem} Flow",
          monthlyTip: "ğŸ’¡ Tip:",
          monthlyShareCopied: "{monthLabel} fortune copied to clipboard!",
          monthlyShareText: "ğŸ”® {monthLabel} Fortune\n\n{summary}\n\n{details}\n\nTags: {tags}\n\n#FortuneTelling #NewYearFortune #{monthLabel}Fortune\n\nğŸ”® Fortune Telling Service: https://saju.funnyfunny.cloud/",
          // Fortune tags
          luckGood: "Good Fortune",
          luckBad: "Bad Fortune",
          luckNeutral: "Neutral Fortune",
          luckEnergy: "{elem} Energy",
          // Compatibility rules
          ruleNoRules: "No rules activated yet. Please check your input.",
          ruleInsightMoney: "Money flow becomes more stable with rule agreements.",
          ruleInsightHealth: "The more rhythm matches, the faster condition recovery.",
          // Today's fortune
          todayFortune: "Today's Fortune",
          // Others
          summarySub: "Based on input timezone Â· Seasonal period/Five Elements rules",
          summaryPillCore: "Core Element: {top}",
          summaryPillWeak: "Weak Element: {weak}",
          summaryPillRules: "Activated Rules: {count}",
          radarLegend: "Overall relationship balance",
          // Alerts
          alertInputRequired: "Please calculate after input.",
          alertPDFNotReady: "PDF library is not ready.",
          alertMonthCopied: "{monthLabel} fortune copied to clipboard!",
          shareCardCopied: "Card created and copied to clipboard.",
          shareCardCreated: "Card created. Please check the download.",
          inputTimeNote: "â€» Input time is calculated based on Korea standard time.",
          // Additional translations
          inputTitle: "Input",
          shintoNote: "Calculated based on Shinto Jeongbi Gyeol standards.",
          btnCalculate: "Calculate",
          todayBadge: "Shinto Jeongbi Gyeol",
          shintoCorrectionTitle: "Shinto Jeongbi Gyeol Correction",
          shintoCorrectionApplied: "Applied",
          shintoCorrectionNotApplied: "Not Applied",
          shintoCorrectionAppliedText: "âœ… <strong>Shinto Jeongbi Gyeol Correction Applied</strong><br/>Your fortune stem-branch combination is a special pattern recorded in Shinto Jeongbi Gyeol (traditional fortune interpretation book). Instead of general calculation, we use the five elements distribution values set by Shinto Jeongbi Gyeol to show more accurately.",
          shintoCorrectionNotAppliedText: "â„¹ï¸ <strong>Shinto Jeongbi Gyeol Correction Not Applied</strong><br/>There is no Shinto Jeongbi Gyeol standard data for your fortune stem-branch combination, so the five elements were calculated using general calculation.",
          shintoCorrectionNoData: "There is no Shinto Jeongbi Gyeol correction data for this stem-branch combination.",
          tableHeaderCategory: "Category",
          tableHeaderYear: "Year",
          tableHeaderMonth: "Month",
          tableHeaderDay: "Day",
          tableHeaderHour: "Hour",
          tableHeaderStemBranch: "Stem-Branch",
          tableHeaderElements: "Elements",
          tableHeaderTotal: "Total",
          tableHeaderCorrection: "Correction",
          resultNewYearSummary: "New Year Fortune Summary",
          shareNewYearCopied: "New Year fortune has been copied to clipboard.",
          shareNewYearText: "ğŸ”® 2026 New Year Fortune\n\n",
          copyPrompt: "Copy content:",
          shareStatusAfterCopy: "Please check the text.",
          pdfFileNameToday: "TodayFortune_{date}.pdf",
          pdfFileNameNewYear: "NewYearFortune_{date}.pdf",
          pdfFileNameCompat: "CompatibilityReport_{date}.pdf",
        },
      };

      const defaultLang = "ko";
      const supportedLangs = ["ko", "en"];
      let currentLang = defaultLang;

      function t(key, vars = {}) {
        const langTable = translations[currentLang] || translations.ko;
        let template = langTable?.[key] ?? translations.ko?.[key] ?? key;
        if (typeof template !== "string") return template;
        Object.keys(vars).forEach((k) => {
          template = template.replace(new RegExp(`\\{${k}\\}`, "g"), vars[k]);
        });
        return template;
      }

      function applyTranslations() {
        document.title = t("metaTitle");
        document.documentElement.lang = currentLang;
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          el.textContent = t(el.dataset.i18n);
        });
        document.querySelectorAll("[data-i18n-html]").forEach((el) => {
          el.innerHTML = t(el.dataset.i18nHtml);
        });
        document.querySelectorAll("[data-i18n-title]").forEach((el) => {
          if (el.tagName === "TITLE") {
            el.textContent = t(el.dataset.i18nTitle);
          } else {
            el.title = t(el.dataset.i18nTitle);
          }
        });
        document.querySelectorAll("[data-i18n-aria]").forEach((el) => {
          el.setAttribute("aria-label", t(el.dataset.i18nAria));
        });
        document.querySelectorAll("[data-i18n-alt]").forEach((el) => {
          el.setAttribute("alt", t(el.dataset.i18nAlt));
        });
        // Update select options
        document.querySelectorAll('select[id="aGender"] option, select[id="bGender"] option').forEach((opt) => {
          if (opt.value === "male") opt.textContent = t("genderMale");
          if (opt.value === "female") opt.textContent = t("genderFemale");
        });
        // Update todayBadge
        const todayBadge = document.getElementById("todayBadge");
        if (todayBadge) todayBadge.textContent = t("todayBadge");
        // Update inputDesc if configureInputForMode exists
        if (window.configureInputForMode && window.state) {
          configureInputForMode(state.mode);
        }
      }

      function detectLang() {
        const params = new URLSearchParams(window.location.search);
        const paramLang = params.get("lang");
        if (supportedLangs.includes(paramLang)) return paramLang;
        const stored = localStorage.getItem("preferredLang");
        if (supportedLangs.includes(stored)) return stored;
        const browserLang =
          navigator.languages && navigator.languages.length
            ? navigator.languages[0]
            : navigator.language;
        if (browserLang && browserLang.toLowerCase().startsWith("ko")) {
          return "ko";
        }
        return defaultLang;
      }

      function setLang(lang, options = {}) {
        const nextLang = supportedLangs.includes(lang) ? lang : defaultLang;
        currentLang = nextLang;
        window.currentLang = currentLang;
        document.documentElement.lang = nextLang;
        localStorage.setItem("preferredLang", nextLang);
        document.querySelectorAll(".lang-switch button").forEach((button) => {
          button.classList.toggle("active", button.dataset.lang === nextLang);
        });
        applyTranslations();
        if (options.updateUrl) {
          const url = new URL(window.location.href);
          url.searchParams.set("lang", nextLang);
          window.history.replaceState({}, "", url);
        }
        // Update dynamic content if needed
        if (window.configureInputForMode && window.state) {
          configureInputForMode(state.mode);
        }
      }

      document.querySelectorAll(".lang-switch button").forEach((button) => {
        button.addEventListener("click", () => {
          setLang(button.dataset.lang, { updateUrl: true });
        });
      });

      setLang(detectLang(), { updateUrl: false });

      // Make t() function and currentLang globally available
      window.t = t;
      window.currentLang = currentLang;
      window.setLang = setLang;

      /* ======================================================
  INIT
====================================================== */
      function init() {
        const saved = loadInputs();
        setInputs(saved);
        // í•­ìƒ ë©”ë‰´ í™”ë©´ì„ ë¨¼ì € í‘œì‹œ
        showStep("menu");
        // ì €ì¥ëœ ëª¨ë“œê°€ ìˆìœ¼ë©´ í•´ë‹¹ ëª¨ë“œë¡œ ì…ë ¥ í™”ë©´ ì„¤ì •ë§Œ í•´ë‘ê¸° (í™”ë©´ì€ ë©”ë‰´ ìœ ì§€)
        if (saved.mode) {
          state.mode = saved.mode === "compat" ? "newyear" : saved.mode;
          configureInputForMode(state.mode);
        }
      }

      document.querySelectorAll(".menu-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          state.mode = btn.dataset.mode;
          configureInputForMode(state.mode);
          showStep("input");
        });
      });

      backToMenu.addEventListener("click", () => showStep("menu"));
      clearSaved.addEventListener("click", () => {
        localStorage.removeItem(INPUT_KEY);
        aDate.value = "";
        aHourBranch.value = "ì";
        aTimeUnknown.checked = false;
        aGender.value = "male";
        aDaewoonStart.value = "";
        aHiddenMode.value = "on";
        aHiddenMode.disabled = true;
        aTzOffset.value = "9";
        aDstMode.value = "off";
        bDate.value = "";
        bHourBranch.value = "ì";
        bTimeUnknown.checked = false;
        bGender.value = "female";
        bDaewoonStart.value = "";
        bHiddenMode.value = "on";
        bHiddenMode.disabled = true;
        bTzOffset.value = "9";
        bDstMode.value = "off";
        alert("ì €ì¥ëœ ì…ë ¥ì„ ì´ˆê¸°í™”í–ˆì–´.");
      });
      backToInput.addEventListener("click", () => showStep("input"));
      restartFlow.addEventListener("click", () => showStep("menu"));

      shareBtn.addEventListener("click", shareCard);
      pdfBtn.addEventListener("click", savePdfPretty);
      calcBtn.addEventListener("click", computePair);

      init();
    </script>
  </body>
</html>
